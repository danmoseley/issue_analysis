[
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/6720",
        "createdAt":  "2019-01-15T20:55:18Z",
        "number":  6720,
        "author":  "HaoK",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  null,
                          "nodes":  [

                                    ],
                          "totalCount":  0
                      },
        "updatedAt":  "2021-09-03T20:51:40Z",
        "body":  "DataProtection/Extensions/test/DataProtectionProviderTests.cs System_UsesProvidedDirectoryAndCertificate fails only on OSX queue\r\n\r\n```\r\n[xUnit.net 00:00:01.28]     Microsoft.AspNetCore.DataProtection.DataProtectionProviderTests.System_UsesProvidedDirectoryAndCertificate [FAIL]\r\nFailed   Microsoft.AspNetCore.DataProtection.DataProtectionProviderTests.System_UsesProvidedDirectoryAndCertificate\r\nError Message:\r\n Interop+AppleCrypto+AppleCommonCryptoCryptographicException : write permissions error\r\nStack Trace:\r\n   at Interop.AppleCrypto.X509StoreAddCertificate(SafeKeychainItemHandle certOrIdentity, SafeKeychainHandle keychain)\r\n   at Internal.Cryptography.Pal.StorePal.AppleKeychainStore.Add(ICertificatePal cert)\r\n   at System.Security.Cryptography.X509Certificates.X509Store.Add(X509Certificate2 certificate)\r\n   at Microsoft.AspNetCore.DataProtection.DataProtectionProviderTests.System_UsesProvidedDirectoryAndCertificate() in /_/src/DataProtection/Extensions/test/DataProtectionProviderTests.cs:line 124\r\n[xUnit.net 00:00:01.58]     Microsoft.AspNetCore.DataProtection.DataProtectionProviderTests.System_UsesProvidedDirectory_WithConfigurationCallback [SKIP]\r\nSkipped  Microsoft.AspNetCore.DataProtection.DataProtectionProviderTests.System_UsesProvidedDirectory_WithConfigurationCallback\r\nResults File: /Users/dotnet-bot/dotnetbuild/work/e46143d4-88da-42ae-96d7-42513595330a/Work/45b5d399-ffd0-4a6b-ab73-3fce0571cf50/Exec/TestResults/_dci-mac-build-083_2019-01-15_01_40_03.trx\r\n```",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHONmhGYA==",
                         "nodes":  [
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDQ1NDY3MTI4NA==",
                                           "createdAt":  "2019-01-16T06:49:51Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "HaoK",
                                           "body":  "These also cause Microsoft.AspNetCore.ApiAuthorization.IdentityServer.Tests to fail in master",
                                           "updatedAt":  "2019-01-16T06:49:51Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDQ1NDcxODQyNg==",
                                           "createdAt":  "2019-01-16T09:52:31Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "HaoK",
                                           "body":  "Note on master there appears to be a new attribute `[X509StoreIsAvailable(StoreName.My, StoreLocation.CurrentUser)]` that is attempting to skip sometimes, but maybe its not correctly working on helix OSX",
                                           "updatedAt":  "2019-01-16T09:52:31Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDYwNjgwMDgxNQ==",
                                           "createdAt":  "2020-03-31T18:37:43Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "HaoK",
                                           "body":  "Unskipped these tests except on OSX, which still has a cert failure\r\n\r\n```\r\nThe System_UsesProvidedDirectoryAndCertificate is failing with\r\n\r\nInterop+AppleCrypto+AppleCommonCryptoCryptographicException : User interaction is not allowed.\r\n```",
                                           "updatedAt":  "2020-03-31T18:37:43Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDYwNzM4NDA3NA==",
                                           "createdAt":  "2020-04-01T17:24:52Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "HaoK",
                                           "body":  "See https://github.com/dotnet/aspnetcore/pull/20319#issuecomment-606824891 for context and suggested workarounds",
                                           "updatedAt":  "2020-04-01T17:24:52Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDcxOTY1MzQwNg==",
                                           "createdAt":  "2020-10-30T16:24:24Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "Thanks for contacting us.\nWe\u0027re moving this issue to the `Next sprint planning` milestone for future evaluation / consideration. We will evaluate the request when we are planning the work for the next milestone. To learn more about what to expect next and how this issue will be handled you can read more about our triage process [here](https://github.com/dotnet/aspnetcore/blob/master/docs/TriageProcess.md).",
                                           "updatedAt":  "2020-10-30T16:24:24Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde842aEZg",
                                           "createdAt":  "2021-09-03T20:51:40Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "We\u0027ve moved this issue to the Backlog milestone. This means that it is not going to be worked on for the coming release. We will reassess the backlog following the current release and consider this item at that time. To learn more about our issue management process and to have better expectation regarding different types of issues you can read our [Triage Process](https://github.com/dotnet/aspnetcore/blob/master/docs/TriageProcess.md).",
                                           "updatedAt":  "2021-09-03T20:51:40Z"
                                       }
                                   ],
                         "totalCount":  6
                     },
        "title":  "[Helix] Cert tests fail with user interaction on OSX",
        "labels":  [
                       "task",
                       "area-dataprotection",
                       "test-failure",
                       "affected-few",
                       "severity-minor"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/20680",
        "createdAt":  "2020-04-09T14:34:45Z",
        "number":  20680,
        "author":  "kanadaj",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHOC2ITLg==",
                          "nodes":  [
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "madelson",
                                            "createdAt":  "2023-04-05T09:59:27Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "berhir",
                                            "createdAt":  "2023-07-31T12:38:51Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "gtbuchanan",
                                            "createdAt":  "2024-02-26T17:51:27Z"
                                        }
                                    ],
                          "totalCount":  3
                      },
        "updatedAt":  "2024-02-27T14:05:06Z",
        "body":  "### Is your feature request related to a problem? Please describe.\r\nI\u0027m not sure if this is possible at all since the documentation feels rather scarce when it comes to changes to the data protection stores, but we have 2 different migration issues here with changing Data Protection providers:\r\n\r\n1. We want to migrate our existing DataProtection keys from one data store to another, relying on the implementation itself to do the work of creating and storing the missing keys rather than us having to work out exactly how the format is different between providers.\r\n2. We\u0027ve realised after-the-fact that we should have had set the application name for the DataProtection config since we now want to share the existing keys with multiple applications. Adding a name now seems to log out all users which is really not a viable option on a consumer website (last time it happened when we migrated from ASP.NET to Core, we were getting emails about a \"bug\" and forgotten password issues for months).\r\n\r\n### Describe the solution you\u0027d like\r\nIf any of the above is already possible, it\u0027d be ideal to include it in the documentation.\r\n\r\nIf it\u0027s not already possible, ideally we\u0027d like to see the following features:\r\n1. The ability to add multiple DataProtection key stores, with the expectation that the key stores have their keys reconciled (maybe have multiple `ReconciliationStrategies`, such as merge and override?) and maintained at a synchronised state.\r\n2. The ability to either add a new ApplicationName for data protection with the expectation that keys referring to the old name are migrated, or, similar to above, the ability to add multiple application names and have identical keys maintained for both names.\r\n3. Pertaining to #1, if there are already multiple key stores defined, the ability to use a synced key store for fallback might be a welcome addition in certain scenarios such as in the case of geo-replicated Kubernetes clusters, but this is really more of an optional idea if there are already multiple key stores anyway.\r\n\r\nThese could be either implemented via a new `IKeyManager` or `IXmlRepository` store, or implemented directly in the core of the data protection system. I can see pros on both sides of this issue.",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOdThIfw==",
                         "nodes":  [
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDYxMTY2NjM0MQ==",
                                           "createdAt":  "2020-04-09T17:56:37Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "GrabYourPitchforks",
                                           "body":  "You shouldn\u0027t need to go to the trouble of creating new managers or repositorites. A strawman way of implementing this:\r\n\r\n 1. Create an `IDataProtectionProvider` which corresponds to the \"old\" setup. Configure it such that the key store is in read-only mode.\r\n 2. Create an `IDataProtectionProvider` which corresponds to the \"new\" setup. Configure it for auto-rotation of keys.\r\n 3. Create a wrapper `IDataProtectionProvider` which wraps the providers created in steps (1) and (2) above. Encryption should always delegate to the provider from step (2). Decryption should first try the provider in step (2), and if that fails try the provider in step (1), and if that fails bubble the exception up to the caller.\r\n 4. Register the provider you created in step (3) in your app\u0027s startup configuration.\r\n\r\nEdit: eventually, after some period of time, you can drop the \"old\" store entirely once you\u0027re confident there are no more existing authentication tokens encrypted with the old keys. This will depend on how long of a validity period you\u0027ve configured for your app\u0027s authentication cookies / tokens.",
                                           "updatedAt":  "2020-04-09T17:59:35Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDYxMTY5MDA2MQ==",
                                           "createdAt":  "2020-04-09T18:41:29Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "kanadaj",
                                           "body":  "`IDataProtectionProvider` isn\u0027t responsible for storing and retrieving the key data though, and overriding only `IDataProtector` isn\u0027t sufficient for this either. It\u0027s probably `IKeyManager` that could do it, and even then it doesn\u0027t seem clean for something that shouldn\u0027t be that rare when an app is moved for example from Redis to Azure KeyVault, or if the ApplicationName has to be changed to share keys due to refactoring.",
                                           "updatedAt":  "2020-04-09T18:41:29Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDcxOTY1MzIwOQ==",
                                           "createdAt":  "2020-10-30T16:24:02Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "We\u0027ve moved this issue to the Backlog milestone. This means that it is not going to be worked on for the coming release. We will reassess the backlog following the current release and consider this item at that time. To learn more about our issue management process and to have better expectation regarding different types of issues you can read our [Triage Process](https://github.com/dotnet/aspnetcore/blob/master/docs/TriageProcess.md).",
                                           "updatedAt":  "2020-10-30T16:24:02Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDcyMzI2ODYwNw==",
                                           "createdAt":  "2020-11-06T19:50:24Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "mkArtakMSFT",
                                           "body":  "@GrabYourPitchforks, @blowdart is there anything we need to do here?\r\nWould help if you would mark this with either `enhancement` or `bug` \r\n",
                                           "updatedAt":  "2020-11-06T19:50:24Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDcyMzcwMDY1OQ==",
                                           "createdAt":  "2020-11-09T01:13:35Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "GrabYourPitchforks",
                                           "body":  "_enhancement_ seems like an appropriate label. The extensibility hooks to allow this already exist. If this is a common enough scenario then it\u0027d be useful to provide a vetted implementation in-box.",
                                           "updatedAt":  "2020-11-09T01:13:35Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85ZPjf-",
                                           "createdAt":  "2023-04-05T10:16:50Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOC6MdLQ==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "EYES",
                                                                               "user":  "savage8811",
                                                                               "createdAt":  "2023-04-19T15:29:43Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "madelson",
                                           "body":  "@GrabYourPitchforks regarding [your suggested configuration approach ](https://github.com/dotnet/aspnetcore/issues/20680#issuecomment-611666341), for creating the nested protector instances would you need to create nested instances in their own service containers?\r\n\r\nI\u0027m imagining something like this:\r\n\r\n```\r\nServiceCollection services1 = new();\r\nservices1.AddDataProtection(/* configuration 1 */);\r\nServiceProvider provider1 = services1.BuildServiceProvider();\r\nIDataProtectionProvider dataProtectionProvider1 = (IDataProtectionProvider)provider1.GetRequiredService(typeof(IDataProtectionProvider));\r\n\r\n... // repeat for configuration2\r\n\r\n// on the main application service collection\r\nservices.AddSingleton(typeof(IDataProtectionProvider), _ =\u003e new DelegatingDataProtectionProvider(dataProtectionProvider1, dataProtectionProvider2));\r\n```\r\n\r\nI might have expected to be able to use `DataProtectionProvider.Create`, but that method seems to limit your persistence/protection options.",
                                           "updatedAt":  "2023-04-06T13:48:42Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde851OEh_",
                                           "createdAt":  "2024-02-27T14:04:23Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "gtbuchanan",
                                           "body":  "For those that are interested, I wrote a console app to migrate keys from DPAPI-NG (or DPAPI) to Azure Key Vault. It should be simple enough to adapt to other encryption mechanisms. This avoids having to use both mechanisms at the same time until you decide the old keys aren\u0027t needed anymore. The app needs to be \"run as\" the user the keys are encrypted under.\r\n\r\n[DpapiNGToKeyVault.zip](https://github.com/dotnet/aspnetcore/files/14420368/DpapiNGToKeyVault.zip)\r\n\r\nObviously, the requested enhancement would still be nice to have. I had to use reflection in the console app since `AzureKeyVaultXmlEncryptor` is internal.",
                                           "updatedAt":  "2024-02-27T14:05:06Z"
                                       }
                                   ],
                         "totalCount":  7
                     },
        "title":  "Multiple dataprotection providers for migration/fallback",
        "labels":  [
                       "enhancement",
                       "area-dataprotection",
                       "affected-few",
                       "severity-minor"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/23033",
        "createdAt":  "2020-06-17T06:44:54Z",
        "number":  23033,
        "author":  "shazhko-artem2",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHODAkXIw==",
                          "nodes":  [
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "shazhko-artem2",
                                            "createdAt":  "2020-06-17T06:46:06Z"
                                        },
                                        {
                                            "content":  "HEART",
                                            "user":  "shazhko-artem2",
                                            "createdAt":  "2020-06-17T06:46:12Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "mali3days",
                                            "createdAt":  "2020-06-17T10:05:55Z"
                                        },
                                        {
                                            "content":  "HEART",
                                            "user":  "mali3days",
                                            "createdAt":  "2020-06-17T10:05:58Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "blanknamed",
                                            "createdAt":  "2020-06-17T10:06:44Z"
                                        },
                                        {
                                            "content":  "HEART",
                                            "user":  "blanknamed",
                                            "createdAt":  "2020-06-17T10:06:45Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "biletskiyi",
                                            "createdAt":  "2020-06-17T10:07:04Z"
                                        },
                                        {
                                            "content":  "HEART",
                                            "user":  "biletskiyi",
                                            "createdAt":  "2020-06-17T10:07:04Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "ox4",
                                            "createdAt":  "2020-06-17T10:09:22Z"
                                        },
                                        {
                                            "content":  "HEART",
                                            "user":  "ox4",
                                            "createdAt":  "2020-06-17T10:09:25Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "skima",
                                            "createdAt":  "2020-06-17T10:10:17Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "Kostya--K",
                                            "createdAt":  "2020-06-17T11:03:26Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "nazariitaran",
                                            "createdAt":  "2021-05-13T07:56:28Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "dgioulakis",
                                            "createdAt":  "2021-08-03T18:25:16Z"
                                        },
                                        {
                                            "content":  "HEART",
                                            "user":  "dgioulakis",
                                            "createdAt":  "2021-08-03T18:25:17Z"
                                        },
                                        {
                                            "content":  "HEART",
                                            "user":  "ozonev",
                                            "createdAt":  "2021-12-20T15:42:07Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "ozonev",
                                            "createdAt":  "2021-12-20T15:42:08Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "strozzac",
                                            "createdAt":  "2021-12-20T15:43:45Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "Shazhko-Artem",
                                            "createdAt":  "2021-12-20T15:44:30Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "ljani",
                                            "createdAt":  "2022-07-25T06:01:57Z"
                                        },
                                        {
                                            "content":  "HEART",
                                            "user":  "jmezach",
                                            "createdAt":  "2022-11-17T08:10:00Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "jmezach",
                                            "createdAt":  "2022-11-17T08:10:02Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "gor-st",
                                            "createdAt":  "2024-09-09T11:22:26Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "swh-cb",
                                            "createdAt":  "2025-03-27T14:43:20Z"
                                        }
                                    ],
                          "totalCount":  24
                      },
        "updatedAt":  "2024-01-26T21:34:31Z",
        "body":  "### Problem\r\nIn my current project, we have several certificate providers, so we use the certificate factory. Also, we use data protection and protect keys with a certificate. The problem is that `DataProtectionBuilderExtensions.ProtectKeysWithCertificate` requires a certificate directly, for which we need a certificate factory, but for getting a factory, we need an `IServiceProvider`.\r\n\r\n### Solution\r\nWe need to add a method overload with the following parameters.\r\n\r\n``` C#\r\npublic static IDataProtectionBuilder ProtectKeysWithCertificate(this IDataProtectionBuilder builder, Func\u003cIServiceProvider, X509Certificate2 \u003e factory){...}\r\n```\r\n\r\n### Similar existing solutions\r\nA similar solution already exists for `AddKeyEscrowSink`, but not for `ProtectKeysWithCertificate`.\r\n``` C#\r\npublic static IDataProtectionBuilder AddKeyEscrowSink(this IDataProtectionBuilder builder, Func\u003cIServiceProvider, IKeyEscrowSink\u003e factory){...}\r\n```",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOcgHifQ==",
                         "nodes":  [
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDc2Nzg0OTkzNg==",
                                           "createdAt":  "2021-01-26T21:49:49Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "Thanks for contacting us.\nWe\u0027re moving this issue to the `Next sprint planning` milestone for future evaluation / consideration. We will evaluate the request when we are planning the work for the next milestone. To learn more about what to expect next and how this issue will be handled you can read more about our triage process [here](https://github.com/dotnet/aspnetcore/blob/master/docs/TriageProcess.md).",
                                           "updatedAt":  "2021-01-26T21:49:49Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDg0NjAxMDAxNA==",
                                           "createdAt":  "2021-05-21T14:54:57Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "Shazhko-Artem",
                                           "body":  "Hi guys. I investigated the codebase and understood that this requires slightly more changes than expected to implement this feature. The main problem that we need to pass this certificate for two options (`KeyManagementOptions` and `XmlKeyDecryptionOptions`) but we should invoke the certificate factory only once to be sure that these two options will have the same certificate.\r\n\r\nI have an idea of how to implement this with as few changes as possible. We can create a class that will be the container for the value. This class will have a method to get the value, which takes a factory as a parameter. If the value is not yet in the container, then the factory will be called and the resulting value will be stored in the container. The next time this method is called, the value will be taken from the container.\r\n\r\n#### Examples of such a solution.\r\n1. Class `Lazy\u003c\u003e` - allows you to pass a delegate (value factory) to the constructor which will be called once and store the value inside the class. In our situation, we cannot use this class, since the delegate needs to be passed to the constructor, but we cannot do this, since, at the time of creating an instance of the `Lazy` class, we still do not have a service provider.\r\n2. `ConcurrentDictionary\u003c\u003e` - it has a `GetOrAdd` method, the first parameter is a key, and the second is a value factory. This is not suitable for our situation because we do not have a collection, we have a single certificate.\r\n\r\n#### Example of implementation\r\n`ValueBox` is a container for a value.\r\n\r\n``` C#\r\ninternal class ValueBox\u003cTValue\u003e\r\n{\r\n    private readonly object _lock = new object();\r\n    private volatile bool _hasValue = false;\r\n    private TValue _value;\r\n\r\n    public TValue GetOrSet(Func\u003cTValue\u003e factory)\r\n    {\r\n        lock (_lock)\r\n        {\r\n            if (_hasValue)\r\n            {\r\n                return _value;\r\n            }\r\n\r\n            _value = factory();\r\n            _hasValue = true;\r\n        }\r\n\r\n        return _value;\r\n    }\r\n}\r\n```\r\nA new extension method with the ability to delay the receipt of a certificate\r\n\r\n``` C#\r\npublic static IDataProtectionBuilder ProtectKeysWithCertificate(\r\n    this IDataProtectionBuilder builder,\r\n    Func\u003cIServiceProvider, X509Certificate2\u003e provider)\r\n{\r\n    if (builder == null)\r\n    {\r\n        throw new ArgumentNullException(nameof(builder));\r\n    }\r\n\r\n    if (provider == null)\r\n    {\r\n        throw new ArgumentNullException(nameof(provider));\r\n    }\r\n\r\n    var certificateBox = new ValueBox\u003cX509Certificate2\u003e();\r\n    builder.Services.AddSingleton\u003cIConfigureOptions\u003cKeyManagementOptions\u003e\u003e(services =\u003e\r\n    {\r\n        var loggerFactory = services.GetService\u003cILoggerFactory\u003e() ?? NullLoggerFactory.Instance;\r\n        return new ConfigureOptions\u003cKeyManagementOptions\u003e(options =\u003e\r\n        {\r\n            var certificate = certificateBox.GetOrSet(() =\u003e provider(services));\r\n            options.XmlEncryptor = new CertificateXmlEncryptor(certificate, loggerFactory);\r\n        });\r\n    });\r\n    builder.Services.AddSingleton\u003cIConfigureOptions\u003cXmlKeyDecryptionOptions\u003e\u003e(services =\u003e\r\n    {\r\n        return new ConfigureOptions\u003cXmlKeyDecryptionOptions\u003e(options =\u003e\r\n        {\r\n            var certificate = certificateBox.GetOrSet(() =\u003e provider(services));\r\n            options.AddKeyDecryptionCertificate(certificate);\r\n        });\r\n    });\r\n    return builder;\r\n}\r\n```",
                                           "updatedAt":  "2021-05-21T14:54:57Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDg0Njg5ODEyOQ==",
                                           "createdAt":  "2021-05-24T09:04:03Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "Shazhko-Artem",
                                           "body":  "Hi @HaoK, could you check my suggestion, please?",
                                           "updatedAt":  "2021-05-24T09:04:03Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDg1MjAzODU2OA==",
                                           "createdAt":  "2021-06-01T11:09:32Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "Shazhko-Artem",
                                           "body":  "@blowdart, @javiercn, @mkArtakMSFT,  sorry to bother you, could you please check my suggestion above please? Or mention someone who can do it.",
                                           "updatedAt":  "2021-06-01T11:09:32Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDg1MjA0ODM0Nw==",
                                           "createdAt":  "2021-06-01T11:27:17Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "javiercn",
                                           "body":  "@Shazhko-Artem I\u0027m not familiar with this area of the code, so I\u0027ll let others chime in. However, the way you are using config is less than ideal.\r\n\r\nIt\u0027s likely much easier to do this by doing something like:\r\n```csharp\r\nservices.TryAddEnumerable(ServiceDescriptor.Singleton\u003cIConfigureOptions\u003cKeyManagementOptions\u003e\u003e(sp =\u003e sp.GetRequiredService\u003cCertificateConfig\u003e()));\r\nservices.TryAddEnumerable(ServiceDescriptor.Singleton\u003cIConfigureOptions\u003cXmlKeyDecriptionOptions\u003e\u003e(sp =\u003e sp.GetRequiredService\u003cCertificateConfig\u003e()));\r\nservices.AddSingleton(sp =\u003e new CertificateConfig(...));\r\n```\r\n\r\nI believe there is also a Configure overload that does this for you. @HaoK will know better.",
                                           "updatedAt":  "2021-06-01T11:27:17Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDg1MjA5MTYzMw==",
                                           "createdAt":  "2021-06-01T12:40:21Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "Shazhko-Artem",
                                           "body":  "@javiercn Thanks for the answer. I really appreciate your answer.\r\nIn your example, the `CertificateConfig`  should implement two interfaces (`IConfigureOptions\u003cKeyManagementOptions\u003e` and `IConfigureOptions\u003cXmlKeyDecriptionOptions\u003e`) and invoke factory func only in one time and reuse the result (certificate) for configure the second options type.\r\n\r\nBut I got the main idea of your example.\r\nWe can create an `IDataProtectionCertificateProvider` interface that allows us to get the single certificate when we configure these options. The implementation will accept a factory function in the constructor.\r\n\r\n### Example\r\nThe `IDataProtectionCertificateProvider` interface provides the same certificate into different option types.\r\n\r\n``` C#\r\npublic interface IDataProtectionCertificateProvider\r\n{\r\n    X509Certificate2 Get();\r\n}\r\n```\r\n\r\nThe implementation of the `IDataProtectionCertificateProvider`.\r\n\r\n``` C#\r\npublic class DataProtectionCertificateProvider\u003cTDep\u003e : IDataProtectionCertificateProvider\r\n{\r\n    private readonly TDep _dependency;\r\n    private readonly Func\u003cTDep, X509Certificate2\u003e _factory;\r\n    private readonly object _lock = new object();\r\n    private volatile bool _hasCert = false;\r\n    private X509Certificate2 _certificate;\r\n    public DataProtectionCertificateProvider(TDep dependency, Func\u003cTDep, X509Certificate2\u003e factory)\r\n    {\r\n        this._dependency = dependency;\r\n        this._factory = factory;\r\n    }\r\n    public X509Certificate2 Get()\r\n    {\r\n        lock (_lock)\r\n        {\r\n            if (_hasCert)\r\n            {\r\n                return _certificate;\r\n            }\r\n            _certificate = _factory(_dependency);\r\n            _hasCert = true;\r\n        }\r\n        return _certificate;\r\n    }\r\n}\r\n```\r\n\r\nA new extension method with the ability to delay the receipt of a certificate by using data protection certificate provider\r\n\r\n``` C#\r\npublic static IDataProtectionBuilder ProtectKeysWithCertificate(\r\n            this IDataProtectionBuilder builder,\r\n            Func\u003cIServiceProvider, X509Certificate2\u003e factory)\r\n{\r\n     // ...\r\n    builder.Services.AddSingleton\u003cIDataProtectionCertificateProvider\u003e(services=\u003e\r\n        new DataProtectionCertificateProvider\u003cIServiceProvider\u003e(services, factory));\r\n    builder.Services.AddSingleton\u003cIConfigureOptions\u003cKeyManagementOptions\u003e\u003e(services =\u003e\r\n    {\r\n        var loggerFactory = services.GetService\u003cILoggerFactory\u003e() ?? NullLoggerFactory.Instance;\r\n        return new ConfigureOptions\u003cKeyManagementOptions\u003e(options =\u003e\r\n        {\r\n            var certificateProvider = services.GetRequiredService\u003cIDataProtectionCertificateProvider\u003e();\r\n            var certificate = certificateProvider.Get();\r\n            options.XmlEncryptor = new CertificateXmlEncryptor(certificate, loggerFactory);\r\n        });\r\n    });\r\n    builder.Services.AddSingleton\u003cIConfigureOptions\u003cXmlKeyDecryptionOptions\u003e\u003e(services =\u003e\r\n    {\r\n        return new ConfigureOptions\u003cXmlKeyDecryptionOptions\u003e(options =\u003e\r\n        {\r\n            var certificateProvider = services.GetRequiredService\u003cIDataProtectionCertificateProvider\u003e();\r\n            var certificate = certificateProvider.Get();\r\n            options.AddKeyDecryptionCertificate(certificate);\r\n        });\r\n    });\r\n    return builder;\r\n}\r\n```\r\n\r\nBut as you can see we have the same logic in the `DataProtectionCertificateProvider` as previously suggested `ValueBox\u003c\u003e`.\r\n\r\n### Another solution\r\n\r\nWe can create a separate intermediate options class that will have a certificate property.\r\n\r\n#### Example\r\nIntermediate options class.\r\n\r\n``` C#\r\npublic class DataProtectionCertificateOptions\r\n{\r\n    public X509Certificate2 Certificate { get; set; }\r\n}\r\n```\r\n\r\nA new extension method with the ability to delay the receipt of a certificate by using intermediate options class\r\n\r\n``` C#\r\npublic static IDataProtectionBuilder ProtectKeysWithCertificate(\r\n            this IDataProtectionBuilder builder,\r\n            Func\u003cIServiceProvider, X509Certificate2\u003e factory)\r\n{\r\n    // ...\r\n    builder.Services.AddSingleton\u003cIConfigureOptions\u003cDataProtectionCertificateOptions\u003e\u003e(services =\u003e\r\n        new ConfigureOptions\u003cDataProtectionCertificateOptions\u003e(options =\u003e\r\n        {\r\n            options.Certificate = factory(services);\r\n        }));\r\n    builder.Services.AddSingleton\u003cIConfigureOptions\u003cKeyManagementOptions\u003e\u003e(services =\u003e\r\n    {\r\n        var loggerFactory = services.GetService\u003cILoggerFactory\u003e() ?? NullLoggerFactory.Instance;\r\n        return new ConfigureOptions\u003cKeyManagementOptions\u003e(options =\u003e\r\n        {\r\n            var certificateOptions = services.GetService\u003cIOptions\u003cDataProtectionCertificateOptions\u003e\u003e().Value;\r\n            var certificate = certificateOptions.Certificate;\r\n            options.XmlEncryptor = new CertificateXmlEncryptor(certificate, loggerFactory);\r\n        });\r\n    });\r\n    builder.Services.AddSingleton\u003cIConfigureOptions\u003cXmlKeyDecryptionOptions\u003e\u003e(services =\u003e\r\n    {\r\n        return new ConfigureOptions\u003cXmlKeyDecryptionOptions\u003e(options =\u003e\r\n        {\r\n            var certificateOptions = services.GetService\u003cIOptions\u003cDataProtectionCertificateOptions\u003e\u003e().Value;\r\n            var certificate = certificateOptions.Certificate;\r\n            options.AddKeyDecryptionCertificate(certificate);\r\n        });\r\n    });\r\n    return builder;\r\n}\r\n```\r\n\r\nBut I don\u0027t like the name `DataProtectionCertificateOptions` and that we are using this class to pass the value to other options.",
                                           "updatedAt":  "2021-06-02T08:19:34Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDg1Mjg0MjgxOA==",
                                           "createdAt":  "2021-06-02T08:20:54Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "Shazhko-Artem",
                                           "body":  "There is another alternative way to implement this. This is like what @javiercn suggested.\r\nWe can use the _Dependency Injection_ functionality to call the factory once and provide the resulting certificate to the places where we configure the model.\r\n\r\nThe `ValueBox\u003cTValue\u003e` allows injecting value into the configure options.\r\n``` C#\r\ninternal class ValueBox\u003cTValue\u003e\r\n{\r\n    public ValueBox(TValue value)\r\n    {\r\n        Value = value;\r\n    }\r\n\r\n    public TValue Value { get; }\r\n}\r\n```\r\n\r\nConfigure `KeyManagementOptions `and `XmlKeyDecryptionOptions`\r\n\r\n``` C#\r\npublic static IDataProtectionBuilder ProtectKeysWithCertificate(\r\n    this IDataProtectionBuilder builder,\r\n    Func\u003cIServiceProvider, X509Certificate2\u003e factory)\r\n{\r\n    // ...\r\n\r\n    builder.Services.AddSingleton\u003cValueBox\u003cX509Certificate2\u003e\u003e(services =\u003e\r\n        new ValueBox\u003cX509Certificate2\u003e(factory(services)));\r\n        builder.Services.AddSingleton\u003cIConfigureOptions\u003cKeyManagementOptions\u003e\u003e(services =\u003e\r\n    {\r\n        var loggerFactory = services.GetService\u003cILoggerFactory\u003e() ?? NullLoggerFactory.Instance;\r\n        return new ConfigureOptions\u003cKeyManagementOptions\u003e(options =\u003e\r\n        {\r\n            var certificateBox = services.GetRequiredService\u003cValueBox\u003cX509Certificate2\u003e\u003e();\r\n            var certificate = certificateBox.Value;\r\n            options.XmlEncryptor = new CertificateXmlEncryptor(certificate, loggerFactory);\r\n        });\r\n    });\r\n    builder.Services.AddSingleton\u003cIConfigureOptions\u003cXmlKeyDecryptionOptions\u003e\u003e(services =\u003e\r\n    {\r\n        return new ConfigureOptions\u003cXmlKeyDecryptionOptions\u003e(options =\u003e\r\n        {\r\n            var certificateBox = services.GetRequiredService\u003cValueBox\u003cX509Certificate2\u003e\u003e();\r\n            var certificate = certificateBox.Value;\r\n            options.AddKeyDecryptionCertificate(certificate);\r\n        });\r\n    });\r\n    return builder;\r\n}\r\n```\r\n\r\n\r\n",
                                           "updatedAt":  "2021-06-02T08:21:35Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde84_IZap",
                                           "createdAt":  "2022-03-04T13:32:44Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "mkarpuk",
                                           "body":  "Simply making `XmlKeyDecryptionOptions` public will give us capabilities to setup services ourselves (instead of relying on helper methods). Currently it seems impossible...",
                                           "updatedAt":  "2022-03-04T13:32:44Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85OkBxt",
                                           "createdAt":  "2022-11-17T04:46:36Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "Thanks for contacting us.\n\nWe\u0027re moving this issue to the `.NET 8 Planning` milestone for future evaluation / consideration. We would like to keep this around to collect more feedback, which can help us with prioritizing this work. We will re-evaluate this issue, during our next planning meeting(s). \nIf we later determine, that the issue has no community involvement, or it\u0027s very rare and low-impact issue, we will close it - so that the team can focus on more important and high impact issues.\nTo learn more about what to expect next and how this issue will be handled you can read more about our triage process [here](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2022-11-17T04:46:36Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85yAeJ9",
                                           "createdAt":  "2024-01-26T21:34:30Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "We\u0027ve moved this issue to the Backlog milestone. This means that it is not going to be worked on for the coming release. We will reassess the backlog following the current release and consider this item at that time. To learn more about our issue management process and to have better expectation regarding different types of issues you can read our [Triage Process](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2024-01-26T21:34:30Z"
                                       }
                                   ],
                         "totalCount":  10
                     },
        "title":  "Add the ability to delay the receipt of a certificate in the extension method DataProtectionBuilderExtensions.ProtectKeysWithCertificate",
        "labels":  [
                       "enhancement",
                       "area-dataprotection",
                       "severity-minor",
                       "affected-medium"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/29128",
        "createdAt":  "2021-01-07T19:32:31Z",
        "number":  29128,
        "author":  "vkirienko",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  null,
                          "nodes":  [

                                    ],
                          "totalCount":  0
                      },
        "updatedAt":  "2025-06-27T13:27:45Z",
        "body":  "### Describe the bug\r\nWe have a pretty much the same issue as described in https://github.com/dotnet/aspnetcore/issues/9447. Two of our .NET Core 3.1.1 applications running in IIS with hostingModel=\"InProcess\" started to throw errors below when app pool gets recycled and application restarts.\r\n\r\nIt looks like it started to happen right after the following patches were installed on our production server. Unfortunately problem show up only in our production environments even if all environments are kept the same in terms or patches.\r\n\r\n-----------\r\n\r\nCategory: Microsoft.AspNetCore.DataProtection.XmlEncryption.DpapiXmlDecryptor\r\nEventId: 43\r\n\r\nAn exception occurred while trying to decrypt the element.\r\n\r\nException: \r\n```\r\nSystem.Security.Cryptography.CryptographicException: Error occurred during a cryptographic operation.\r\n   at Microsoft.AspNetCore.DataProtection.Cng.DpapiSecretSerializerHelper.UnprotectWithDpapiCore(Byte* pbProtectedData, UInt32 cbProtectedData, Byte* pbOptionalEntropy, UInt32 cbOptionalEntropy)\r\n   at Microsoft.AspNetCore.DataProtection.Cng.DpapiSecretSerializerHelper.UnprotectWithDpapi(Byte[] protectedSecret)\r\n   at Microsoft.AspNetCore.DataProtection.XmlEncryption.DpapiXmlDecryptor.Decrypt(XElement encryptedElement)\r\n```\r\n\r\n-----------\r\n\r\nCategory: Microsoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager\r\nEventId: 24\r\n\r\nAn exception occurred while processing the key element \u0027\u003ckey id=\"9e609506-dcbd-4191-a937-bc514cf9f564\" version=\"1\" /\u003e\u0027.\r\n\r\nException: \r\n```\r\nSystem.Security.Cryptography.CryptographicException: Error occurred during a cryptographic operation.\r\n   at Microsoft.AspNetCore.DataProtection.Cng.DpapiSecretSerializerHelper.UnprotectWithDpapiCore(Byte* pbProtectedData, UInt32 cbProtectedData, Byte* pbOptionalEntropy, UInt32 cbOptionalEntropy)\r\n   at Microsoft.AspNetCore.DataProtection.Cng.DpapiSecretSerializerHelper.UnprotectWithDpapi(Byte[] protectedSecret)\r\n   at Microsoft.AspNetCore.DataProtection.XmlEncryption.DpapiXmlDecryptor.Decrypt(XElement encryptedElement)\r\n   at Microsoft.AspNetCore.DataProtection.XmlEncryption.XmlEncryptionExtensions.DecryptElement(XElement element, IActivator activator)\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager.Microsoft.AspNetCore.DataProtection.KeyManagement.Internal.IInternalXmlKeyManager.DeserializeDescriptorFromKeyElement(XElement keyElement)\r\n```\r\n\r\n----------\r\n\r\nCategory: Microsoft.AspNetCore.DataProtection.KeyManagement.DefaultKeyResolver\r\nEventId: 12\r\n\r\nKey {9e609506-dcbd-4191-a937-bc514cf9f564} is ineligible to be the default key because its CreateEncryptor method failed.\r\n\r\nException:\r\n```\r\nSystem.Security.Cryptography.CryptographicException: Error occurred during a cryptographic operation.\r\n   at Microsoft.AspNetCore.DataProtection.Cng.DpapiSecretSerializerHelper.UnprotectWithDpapiCore(Byte* pbProtectedData, UInt32 cbProtectedData, Byte* pbOptionalEntropy, UInt32 cbOptionalEntropy)\r\n   at Microsoft.AspNetCore.DataProtection.Cng.DpapiSecretSerializerHelper.UnprotectWithDpapi(Byte[] protectedSecret)\r\n   at Microsoft.AspNetCore.DataProtection.XmlEncryption.DpapiXmlDecryptor.Decrypt(XElement encryptedElement)\r\n   at Microsoft.AspNetCore.DataProtection.XmlEncryption.XmlEncryptionExtensions.DecryptElement(XElement element, IActivator activator)\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager.Microsoft.AspNetCore.DataProtection.KeyManagement.Internal.IInternalXmlKeyManager.DeserializeDescriptorFromKeyElement(XElement keyElement)\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.DeferredKey.\u003c\u003ec__DisplayClass1_0.\u003cGetLazyDescriptorDelegate\u003eb__0()\r\n   at System.Lazy`1.ViaFactory(LazyThreadSafetyMode mode)\r\n   at System.Lazy`1.ExecutionAndPublication(LazyHelper executionAndPublication, Boolean useDefaultConstructor)\r\n   at System.Lazy`1.CreateValue()\r\n   at System.Lazy`1.get_Value()\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyBase.get_Descriptor()\r\n   at Microsoft.AspNetCore.DataProtection.AuthenticatedEncryption.CngGcmAuthenticatedEncryptorFactory.CreateEncryptorInstance(IKey key)\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyBase.CreateEncryptor()\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.DefaultKeyResolver.CanCreateAuthenticatedEncryptor(IKey key)\r\n```\r\n\r\n------------\r\n\r\n.NET 3.5\r\nhttps://support.microsoft.com/en-us/help/4578981/kb4578981 - Security Only Update for .NET Framework 3.5 for Windows 8.1 and Windows Server 2012 R2 (KB4578981)\r\nhttps://support.microsoft.com/en-us/help/4569737/kb4569737 - Security Only Update for .NET Framework 3.5 for Windows 8.1 and Windows Server 2012 R2 (KB4569737)\r\nhttps://support.microsoft.com/en-us/help/4565580/kb4565580 - Security Only Update for .NET Framework 3.5 for Windows 8.1 and Windows Server 2012 R2 (KB4565580)\r\nhttps://support.microsoft.com/en-us/help/4578953/kb4578953 - Security and Quality Rollup for .NET Framework 3.5 for Windows 8.1, RT 8.1, and Windows Server 2012 R2 (KB4578953)\r\n\r\n.NET 4.8\r\nhttps://support.microsoft.com/en-us/help/4576489/kb4576489 - Security Only Update for .NET Framework 4.8 for Windows 8.1 and Windows Server 2012 R2 (KB4576489)\r\nhttps://support.microsoft.com/en-us/help/4565588/kb4565588 - Security Only Update for .NET Framework 4.8 for Windows 8.1 and Windows Server 2012 R2 (KB4565588)\r\nhttps://support.microsoft.com/en-us/help/4569732/kb4569732 - Security Only Update for .NET Framework 4.8 for Windows 8.1 and Windows Server 2012 R2 (KB4569732)\r\nhttps://support.microsoft.com/en-us/help/4578989/kb4578989 - Security Only Update for .NET Framework 4.8 for Windows 8.1 and Windows Server 2012 R2 (KB4578989)\r\nhttps://support.microsoft.com/en-us/help/4578976/kb4578976 - Security and Quality Rollup for .NET Framework 4.8 for Windows 8.1, RT 8.1, and Windows Server 2012 R2 (KB4578976)\r\n\r\n\r\n### Further technical details\r\n- ASP.NET Core version \r\n\r\n3.1.1\r\n\r\n- Include the output of `dotnet --info`\r\n\r\nIt was not possible to find any installed .NET Core SDKs\r\nDid you mean to run .NET Core SDK commands? Install a .NET Core SDK from:\r\n      https://aka.ms/dotnet-download\r\n\r\nHost (useful for support):\r\n  Version: 3.1.1\r\n  Commit:  a1388f194c\r\n\r\n.NET Core SDKs installed:\r\n  No SDKs were found.\r\n\r\n.NET Core runtimes installed:\r\n  Microsoft.AspNetCore.App 3.1.1 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNe\r\ntCore.App]\r\n  Microsoft.NETCore.App 3.1.1 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.\r\nApp]\r\n\r\nTo install additional .NET Core runtimes or SDKs:\r\n  https://aka.ms/dotnet-download\r\n",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOs5gllA==",
                         "nodes":  [
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDc1NjQ2MTA4OQ==",
                                           "createdAt":  "2021-01-08T00:03:47Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "blowdart",
                                           "body":  "@GrabYourPitchforks any ideas what might be going on?",
                                           "updatedAt":  "2021-01-08T00:03:47Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDc1NjQ5ODg2Ng==",
                                           "createdAt":  "2021-01-08T02:02:00Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "vkirienko",
                                           "body":  "What\u0027s interesting that there is no pattern related to number of errors per app pool recycle or what keys have problem.\r\n\r\n![image](https://user-images.githubusercontent.com/12551258/103965323-79923280-512b-11eb-9134-0f2d5bbb801a.png)\r\n",
                                           "updatedAt":  "2021-01-08T02:02:00Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDc2MTA2NjM3Mw==",
                                           "createdAt":  "2021-01-15T17:10:16Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "mkArtakMSFT",
                                           "body":  "Ping @GrabYourPitchforks ",
                                           "updatedAt":  "2021-01-15T17:10:16Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDc2NTU2MzI4MQ==",
                                           "createdAt":  "2021-01-22T17:15:56Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "We\u0027ve moved this issue to the Backlog milestone. This means that it is not going to be worked on for the coming release. We will reassess the backlog following the current release and consider this item at that time. To learn more about our issue management process and to have better expectation regarding different types of issues you can read our [Triage Process](https://github.com/dotnet/aspnetcore/blob/master/docs/TriageProcess.md).",
                                           "updatedAt":  "2021-01-22T17:15:56Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDc2NTYyMzQ4Mw==",
                                           "createdAt":  "2021-01-22T19:04:18Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "GrabYourPitchforks",
                                           "body":  "These errors are coming from the Win32 API `CryptUnprotectData`. I wonder if the IIS application pool worker identity has been reset or if the application pool is now configured _not_ to load the user profile? (If there\u0027s no user profile, there\u0027s no place for DPAPI to store the key material.)\r\n\r\nFor historical context, in a traditional Full Framework ASPNET app, the expectation is that the IIS worker process does not load the user profile. Instead, the IIS orchestration service detects that the app pool is configured to load aspnet, it carves out a special section of the registry to allow aspnet to hold its key material, and System.Web uses that registry key instead of the user profile to store the auto-generated `\u003cmachineKey\u003e` element.",
                                           "updatedAt":  "2021-01-22T19:04:18Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDc2NTYzNDY2OQ==",
                                           "createdAt":  "2021-01-22T19:26:26Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "vkirienko",
                                           "body":  "You guess is correct - application pool is configured not to load the user profile. But I was using script below to provision the HKLM registry so that the specified user account can persist auto-generated machine keys.\r\n\r\nhttps://github.com/dotnet/aspnetcore/blob/main/src/DataProtection/Provision-AutoGenKeys.ps1\r\n\r\nBut it strange that these errors showed up just recently.\r\n\r\n",
                                           "updatedAt":  "2021-01-22T19:35:50Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDc2NTc0MzY5OQ==",
                                           "createdAt":  "2021-01-22T23:35:06Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "GrabYourPitchforks",
                                           "body":  "@vkirienko Did the identity of the application pool change recently? For instance, switching from NETWORK SERVICE to APP POOL IDENTITY (or vice versa)? If the app pool user account is set to \"app pool identity\", the identity is based on the name of the application pool. In that case, if the name of the app pool changes, the provisioning script will need to be rerun.",
                                           "updatedAt":  "2021-01-22T23:35:06Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDc2NjM1OTU4OQ==",
                                           "createdAt":  "2021-01-24T14:46:18Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "vkirienko",
                                           "body":  "No, it did not change recently. It was our application service account from day one. Application pool name did not change as well.\r\n\r\nRe-running provisioning script does not help. It was the first thing that I tried when we got these errors.",
                                           "updatedAt":  "2021-01-24T14:47:30Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDc2NzAzMjk2Nw==",
                                           "createdAt":  "2021-01-25T18:48:41Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "GrabYourPitchforks",
                                           "body":  "The DataProtection startup routine attempts to detect capabilities of the current hosting environment at startup ([see code](https://github.com/dotnet/aspnetcore/blob/c925f99cddac0df90ed0bc4a07ecda6b054a0b02/src/DataProtection/DataProtection/src/KeyManagement/XmlKeyManager.cs#L490)) and will choose an appropriate encryption mechanism based on that. It will log something like \"Using the user profile with DPAPI\", \"Using the user profile without DPAPI\", or \"Using registry path \\[blah\\] for key storage\".\r\n\r\nCan you let us know which of these it\u0027s writing to the log? You may have to turn on informational or verbose logging to see these messages.",
                                           "updatedAt":  "2021-01-25T18:48:41Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDc2NzExMjU1OQ==",
                                           "createdAt":  "2021-01-25T21:06:23Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "vkirienko",
                                           "body":  "```\r\nMicrosoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager: 2021-01-25 15:59:40.3371 INFO User profile is available. Using \u0027C:\\Windows\\system32\\config\\systemprofile\\AppData\\Local\\ASP.NET\\DataProtection-Keys\u0027 as key repository and Windows DPAPI to encrypt keys at rest.\r\nMicrosoft.AspNetCore.DataProtection.Repositories.FileSystemXmlRepository: 2021-01-25 15:59:40.3464 DEBUG Reading data from file \u0027C:\\Windows\\system32\\config\\systemprofile\\AppData\\Local\\ASP.NET\\DataProtection-Keys\\key-0d8f0300-c301-48a7-bf94-b97d44f653d7.xml\u0027.\r\n... skip 50 similar lines\r\nMicrosoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager: 2021-01-25 15:59:40.3795 DEBUG Found key {0d8f0300-c301-48a7-bf94-b97d44f653d7}.\r\n... skip 50 similar lines\r\nMicrosoft.AspNetCore.DataProtection.KeyManagement.DefaultKeyResolver: 2021-01-25 15:59:40.4092 DEBUG Considering key {8bc09e78-829b-4211-a4ed-e00d04e9469b} with expiration date 2021-04-25 20:58:35Z as default key.\r\nMicrosoft.AspNetCore.DataProtection.TypeForwardingActivator: 2021-01-25 15:59:40.4092 DEBUG Forwarded activator type request from Microsoft.AspNetCore.DataProtection.XmlEncryption.DpapiXmlDecryptor, Microsoft.AspNetCore.DataProtection, Version=3.1.1.0, Culture=neutral, PublicKeyToken=adb9793829ddae60 to Microsoft.AspNetCore.DataProtection.XmlEncryption.DpapiXmlDecryptor, Microsoft.AspNetCore.DataProtection, Culture=neutral, PublicKeyToken=adb9793829ddae60\r\nMicrosoft.AspNetCore.DataProtection.XmlEncryption.DpapiXmlDecryptor: 2021-01-25 15:59:40.4092 DEBUG Decrypting secret element using Windows DPAPI.\r\nMicrosoft.AspNetCore.DataProtection.XmlEncryption.DpapiXmlDecryptor: 2021-01-25 15:59:40.4424 ERROR An exception occurred while trying to decrypt the element.\r\nMicrosoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager: 2021-01-25 15:59:40.6070 ERROR An exception occurred while processing the key element \u0027\u003ckey id=\"8bc09e78-829b-4211-a4ed-e00d04e9469b\" version=\"1\" /\u003e\u0027.\r\nMicrosoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager: 2021-01-25 15:59:40.6176 TRACE An exception occurred while processing the key element \u0027\u003ckey id=\"8bc09e78-829b-4211-a4ed-e00d04e9469b\" version=\"1\"\u003e\r\n  \u003ccreationDate\u003e2021-01-25T20:58:35.9194222Z\u003c/creationDate\u003e\r\n  \u003cactivationDate\u003e2021-01-25T20:58:35.6384352Z\u003c/activationDate\u003e\r\n  \u003cexpirationDate\u003e2021-04-25T20:58:35.6384352Z\u003c/expirationDate\u003e\r\n  \u003cdescriptor deserializerType=\"Microsoft.AspNetCore.DataProtection.AuthenticatedEncryption.ConfigurationModel.AuthenticatedEncryptorDescriptorDeserializer, Microsoft.AspNetCore.DataProtection, Version=3.1.1.0, Culture=neutral, PublicKeyToken=adb9793829ddae60\"\u003e\r\n    \u003cdescriptor\u003e\r\n      \u003cencryption algorithm=\"AES_256_CBC\" /\u003e\r\n      \u003cvalidation algorithm=\"HMACSHA256\" /\u003e\r\n      \u003cencryptedSecret decryptorType=\"Microsoft.AspNetCore.DataProtection.XmlEncryption.DpapiXmlDecryptor, Microsoft.AspNetCore.DataProtection, Version=3.1.1.0, Culture=neutral, PublicKeyToken=adb9793829ddae60\" xmlns=\"http://schemas.asp.net/2015/03/dataProtection\"\u003e\r\n        \u003cencryptedKey xmlns=\"\"\u003e\r\n          \u003c!-- This key is encrypted with Windows DPAPI. --\u003e\r\n          \u003cvalue\u003e...del...\u003c/value\u003e\r\n        \u003c/encryptedKey\u003e\r\n      \u003c/encryptedSecret\u003e\r\n    \u003c/descriptor\u003e\r\n  \u003c/descriptor\u003e\r\n\u003c/key\u003e\u0027.\r\nMicrosoft.AspNetCore.DataProtection.KeyManagement.DefaultKeyResolver: 2021-01-25 15:59:40.6176 WARN Key {8bc09e78-829b-4211-a4ed-e00d04e9469b} is ineligible to be the default key because its CreateEncryptor method failed.\r\n\r\n\r\n```",
                                           "updatedAt":  "2021-01-25T21:06:23Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDc2NzE4NTQ5NQ==",
                                           "createdAt":  "2021-01-25T23:46:43Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "GrabYourPitchforks",
                                           "body":  "Is your app pool configured to run as SYSTEM? And was this intentional? I don\u0027t see why aspnet would be trying to load the `%SYSTEM32%\\config\\systemprofile\\` directory otherwise.",
                                           "updatedAt":  "2021-01-25T23:46:43Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDc2NzI0ODE4MQ==",
                                           "createdAt":  "2021-01-26T02:36:09Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "vkirienko",
                                           "body":  "App pools configured under service accounts. WWW service runs under Local System account as usual.\r\n\r\n![image](https://user-images.githubusercontent.com/12551258/105792238-37ebef00-5f55-11eb-96bc-1253797a64c8.png)\r\n\r\nAs far as can see systemprofile folder was used all this time (keys were expiring every 3 months) and then suddenly on 12/12/2020 keys are created every day when app pool recycle happens. \r\n\r\nI need to check with our server team to see what is so special about these service accounts. \r\n\r\n![image](https://user-images.githubusercontent.com/12551258/105794605-50f69f00-5f59-11eb-806f-071bb9314023.png)\r\n\r\n",
                                           "updatedAt":  "2021-01-26T03:17:48Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDc4ODIxNzg5OQ==",
                                           "createdAt":  "2021-03-01T19:40:58Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "SatishPasunuti",
                                           "body":  "Hello, I have the same issue for couple of our applications. When can we expect a fix for it?. ",
                                           "updatedAt":  "2021-03-01T19:40:58Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDgxNzYzMDAwOQ==",
                                           "createdAt":  "2021-04-12T09:03:59Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "Henadz",
                                           "body":  "Hello\r\nWe also have the same issue with our applications. Unfortunately, the issue reproduced only on the customer side and we have not full access to the environment. One application is hosted behind IIS, second is a self-hosted application.",
                                           "updatedAt":  "2021-04-12T09:03:59Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDg1NzI2MDc0Mw==",
                                           "createdAt":  "2021-06-08T23:34:46Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "GrabYourPitchforks",
                                           "body":  "Here\u0027s an investigation I\u0027d like to try. Take a look at your key files\u0027 XML again.\r\n\r\n### Detailed walkthrough\r\n\r\n```xml\r\n          \u003c!-- This key is encrypted with Windows DPAPI. --\u003e\r\n          \u003cvalue\u003e...del...\u003c/value\u003e\r\n```\r\n\r\nLet\u0027s look a little more closely at the contents of the _\\\u003cvalue\\\u003e_ element. In particular, I want you to look at the __first 44 bytes__ of that value. (Convert the contents of the _\\\u003cvalue\\\u003e_ element back from hex or base64 into binary first.) Here\u0027s an example from my machine:\r\n\r\n```txt\r\n01-00-00-00-D0-8C-9D-DF-01-15-D1-11-8C-7A-00-C0-4F-C2-97-EB-01-00-00-00-FD-E4-28-23-0E-BD-AD-42-91-29-B7-62-2F-E5-07-2A-00-00-00-00 \u003csnip\u003e\r\n```\r\n\r\nBreak this down into elements of (4 bytes, 16 bytes, 4 bytes, 16 bytes, 4 bytes). Here\u0027s the example I pasted above, broken down and with each field annotated:\r\n\r\n```txt\r\nVer:    01-00-00-00\r\nProvID: D0-8C-9D-DF-01-15-D1-11-8C-7A-00-C0-4F-C2-97-EB\r\nSubver: 01-00-00-00\r\nMKID:   FD-E4-28-23-0E-BD-AD-42-91-29-B7-62-2F-E5-07-2A\r\nFlags:  00-00-00-00\r\n```\r\n\r\nYour _Ver_, _ProvID_, and _Subver_ will likely match mine. It\u0027s just a magic identifier used by DPAPI to recognize its own payload formats.\r\n\r\nThe __MKID__ is the interesting component. This corresponds to the actual file on disk that holds the key used to perform this encryption operation. The way that DPAPI works under the covers is that these \"master keys identifiers\" correspond to files on disk, where those files can be located under your user folder or under the system32 folder.\r\n\r\nHere\u0027s an example of me locating my \"master key\" file under my user profile directory. I opened a command prompt and navigated to the AppData\\Local\\Microsoft\\Protect subdirectory. Note my use of \"attrib /d\" so that I can see a listing of hidden files and folders under these directories, as the \"dir\" command won\u0027t normally show them.\r\n\r\n```txt\r\nMicrosoft Windows [Version 10.0.19043.1052]\r\n(c) Microsoft Corporation. All rights reserved.\r\n\r\nC:\\Users\\levib\u003ecd appdata\\roaming\\microsoft\\protect\r\n\r\nC:\\Users\\levib\\AppData\\Roaming\\Microsoft\\Protect\u003eattrib /d\r\nA  SH                C:\\Users\\levib\\AppData\\Roaming\\Microsoft\\Protect\\CREDHIST\r\n   S                 C:\\Users\\levib\\AppData\\Roaming\\Microsoft\\Protect\\S-foo-bar-baz\r\nA  SH                C:\\Users\\levib\\AppData\\Roaming\\Microsoft\\Protect\\SYNCHIST\r\n\r\nC:\\Users\\levib\\AppData\\Roaming\\Microsoft\\Protect\u003ecd S-foo-bar-baz\r\n\r\nC:\\Users\\levib\\AppData\\Roaming\\Microsoft\\Protect\\S-foo-bar-baz\u003eattrib /d\r\nA  SH                C:\\Users\\levib\\AppData\\Roaming\\Microsoft\\Protect\\S-foo-bar-baz\\2328e4fd-bd0e-42ad-9129-b7622fe5072a\r\nA  SH                C:\\Users\\levib\\AppData\\Roaming\\Microsoft\\Protect\\S-foo-bar-baz\\Preferred\r\n```\r\n\r\n(Note: your _S-foo-bar-baz_ will be different from mine. This S-\\* identifier is used by Windows as a way to identify your account and place security permissions on it.)\r\n\r\nIn my subdirectory, I have an extensionless file called __2328e4fd-bd0e-42ad-9129-b7622fe5072a__. This corresponds to the MKID __FD-E4-28-23-0E-BD-AD-42-91-29-B7-62-2F-E5-07-2A__ in my earlier payload. You may have multiple files in this directory depending on how long your OS has been installed. (Note: due to GUID endianness representations, the first three sections of the filename GUID will have their endianness swapped when represented as binary inside the MKID.)\r\n\r\n__What\u0027s important here is that the file exists.__ I don\u0027t really care about the contents of the file, only that the file exists. Since the file corresponding to MKID __FD-E4-28-23-0E-BD-AD-42-91-29-B7-62-2F-E5-07-2A__ is located under my user profile directory, this means that _my user_ is the one that can decrypt it.\r\n\r\nIn your case, you\u0027re not interested in your own user account\u0027s user profile, you\u0027re interested in the app pool\u0027s user profile. Try following these same steps, but using the directory called out in the `[INFO] User profile is available.` line mentioned at https://github.com/dotnet/aspnetcore/issues/29128#issuecomment-767112559.\r\n\r\nNow, if the master key file doesn\u0027t exist under the user profile directory, check the SYSTEM directory, as shown below.\r\n\r\n```txt\r\nC:\\Users\\levib\u003ecd \\windows\\system32\\microsoft\\protect\r\n\r\nC:\\Windows\\System32\\Microsoft\\Protect\u003eattrib /d\r\n   S                 C:\\Windows\\System32\\Microsoft\\Protect\\Recovery\r\n   S                 C:\\Windows\\System32\\Microsoft\\Protect\\S-1-5-18\r\n\r\nC:\\Windows\\System32\\Microsoft\\Protect\u003ecd S-1-5-18\r\n\r\nC:\\Windows\\System32\\Microsoft\\Protect\\S-1-5-18\u003eattrib /d\r\nA  SH                C:\\Windows\\System32\\Microsoft\\Protect\\S-1-5-18\\c0cea153-af3a-42ca-a1ff-3cf61cb5dfd2\r\nA  SH                C:\\Windows\\System32\\Microsoft\\Protect\\S-1-5-18\\e1b622ea-4223-4149-8e63-a52f0f72eeaa\r\nA  SH                C:\\Windows\\System32\\Microsoft\\Protect\\S-1-5-18\\edddf1be-efa5-486d-91c2-78f45f60908b\r\nA  SH                C:\\Windows\\System32\\Microsoft\\Protect\\S-1-5-18\\f39b1c9b-d088-48d5-8cfd-0071494f24f0\r\nA  SH                C:\\Windows\\System32\\Microsoft\\Protect\\S-1-5-18\\Preferred\r\n   S                 C:\\Windows\\System32\\Microsoft\\Protect\\S-1-5-18\\User\r\n```\r\n\r\nIf the MKID corresponds to one of the files under this directory, it means the contents of the DPAPI blob are encrypted to the local machine instead of to the current user.\r\n\r\n### Discussion\r\n\r\nPerform these steps both for the last known good ASP.NET DataProtection key and for the first invalid ASP.NET DataProtection key. You should be able to crack open the Windows DPAPI payload and locate the physical path on disk where the corresponding Windows DPAPI master keys are located.\r\n\r\nWhat I\u0027m interested in is whether these files are in the same directory or whether they are in different directories. For example, is one file under C:\\Windows\\system32\\config\\systemprofile\\AppData\\Roaming\\Microsoft\\Protect\\S-foo\\ but the other under .\\S-bar\\? Or is one file under system32\\config\\... but the other file under system32\\Microsoft\\Protect\\... (no _config_ inner path)?\r\n\r\nIf so, this would indicate that something in the app pool configuration changed between the generation of these two keys. Either the user profile got created or destroyed unexpectedly, or the app pool S-\\* (security identifier, or SID) changed, or some other environmental factor changed. If the SIDs changed over time, double-check your site configuration to ensure that the app pool settings are as you expect.\r\n\r\nFinally, you could consider querying the innermost _CryptographicException_ you\u0027re seeing from the `DpapiSecretSerializerHelper.UnprotectWithDpapiCore` method. That _CryptographicException_ will have an associated HRESULT (via the `Exception.HResult` property) in addition to the generic error text. That HRESULT (it\u0027s really a Win32 error code; _AND_ the value with `0xFFFF` and refer to [this table](https://docs.microsoft.com/en-us/windows/win32/debug/system-error-codes)) could help narrow down the cause of failure.",
                                           "updatedAt":  "2021-06-08T23:34:46Z"
                                       },
                                       {
                                           "id":  "MDEyOklzc3VlQ29tbWVudDg1NzcxOTA1Nw==",
                                           "createdAt":  "2021-06-09T13:59:51Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "vkirienko",
                                           "body":  "**Update**\r\n\r\nIssue is still reproducible after we migrated all apps to .NET Core 5. Good news it is now reproducible on our DEV box so it will be much easier to debug.\r\n\r\n**Short Investigation Results**\r\n\r\nThere are no files matching **MKID** in these folders:\r\n\r\n    C:\\Windows\\System32\\Microsoft\\Protect\r\n    C:\\Users\\VKYRYYENKO\\appdata\\roaming\\microsoft\\protect\r\n    \r\nFound them in folders corresponding to app pool accounts:\r\n   \r\n    C:\\Users\\svc_triton-dev\\AppData\\Roaming\\Microsoft\\Protect\r\n    C:\\Users\\svc_hhdwh-dev\\AppData\\Roaming\\Microsoft\\Protect\r\n\r\n**Long Investigation Results**\r\n\r\n1. Stopped IIS\r\n2. Deleted all files from \r\n    C:\\Windows\\System32\\config\\systemprofile\\AppData\\Local\\ASP.NET\\DataProtection-Keys\r\n3. Started IIS\r\n4. Got three XML files generated. \r\nTwo of them had same MKID:\r\n![image](https://user-images.githubusercontent.com/12551258/121368015-c2335f00-c908-11eb-96c7-14344d4d9a25.png)\r\nOne had different:\r\n![image](https://user-images.githubusercontent.com/12551258/121368122-d5dec580-c908-11eb-92c0-3784f2eac324.png)\r\n5. Here are the attrib results (no files):\r\n![image](https://user-images.githubusercontent.com/12551258/121368392-0aeb1800-c909-11eb-8adb-996310093828.png)\r\n![image](https://user-images.githubusercontent.com/12551258/121368526-222a0580-c909-11eb-8617-da51fdce80ec.png)\r\nFiles:\r\n![image](https://user-images.githubusercontent.com/12551258/121370079-6a95f300-c90a-11eb-91de-c51c0393e3b8.png)\r\n![image](https://user-images.githubusercontent.com/12551258/121370236-8ef1cf80-c90a-11eb-9a7b-f0b1588daff3.png)\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
                                           "updatedAt":  "2021-06-09T14:09:22Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85fOnwd",
                                           "createdAt":  "2023-06-19T19:34:31Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHODEoP_g==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "ahdung",
                                                                               "createdAt":  "2023-08-24T06:12:01Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "omxitllc",
                                           "body":  "Did we arrive at any fix or still investigating?",
                                           "updatedAt":  "2023-06-19T19:34:31Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86GsBzL",
                                           "createdAt":  "2024-07-31T05:16:21Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "vruss",
                                           "body":  "Is there a known workaround for this? I\u0027m also having the same issue.",
                                           "updatedAt":  "2024-07-31T05:16:21Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86mUe5z",
                                           "createdAt":  "2025-04-09T16:55:45Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "JoelLeach",
                                           "body":  "I was able to reproduce on my production server as follows:\n\n- Two IIS App Pools, each setup to use a different user account.\n- Load User Profile is false. As indicated in the log, this causes keys for both apps to be written to C:\\Windows\\system32\\config\\systemprofile\\AppData\\Local\\ASP.NET\\DataProtection-Keys.\n- Recycle App Pool 1 and restart the app.  An error may or may not occur in the log.\n- Recycle/restart App Pool 2.  An error now appears in the log.  It attempted to use the same key that was created by App Pool 1, but the decryption fails. I think this is because the key was created under a different user account.  App Pool 2 will create a new key due to the failure.\n- Recycle/restart App Pool 1 again.  Error occurs because it now attempts to load the key created by App Pool 2, which again was encrypted under a different user account.\n- The error appears intermittently depending on which account created the last key.\n\nEither of these solutions work for me:\n\n- Set Load User Profile to true.  This will cause the keys to be created in each user\u0027s profile folder rather than in the Windows folder.\n- Set both App Pools to use the same user account.  The error may occur one more time after doing this depending on which user account created the last key.  ",
                                           "updatedAt":  "2025-04-09T16:55:45Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86zmCWU",
                                           "createdAt":  "2025-06-27T13:27:45Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "johanlab",
                                           "body":  "Are there any other workarounds for this issue?\n\nUnfortunately cannot use workarounds mentioned by @JoelLeach above\n\n- We cannot load the user account as it messes with the server locales and time zones - can\u0027t change it as it gets reapplied via enterprise GPO from different domain (trust relationship)\n- We have to have 2 different accounts launching the app pools as access needs to be controlled separately",
                                           "updatedAt":  "2025-06-27T13:27:45Z"
                                       }
                                   ],
                         "totalCount":  20
                     },
        "title":  "DpapiXmlDecryptor - An exception occurred while trying to decrypt the element.",
        "labels":  [
                       "bug",
                       "area-dataprotection",
                       "affected-very-few",
                       "severity-blocking"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/36157",
        "createdAt":  "2021-09-03T20:11:34Z",
        "number":  36157,
        "author":  "blowdart",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHODMOlaA==",
                          "nodes":  [
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "mattiskan",
                                            "createdAt":  "2022-02-15T09:03:50Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "beryozavv",
                                            "createdAt":  "2022-07-05T13:11:22Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "joshsten",
                                            "createdAt":  "2022-08-05T06:34:18Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "bachratyg",
                                            "createdAt":  "2022-09-09T21:53:40Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "pantosha",
                                            "createdAt":  "2022-09-13T12:28:52Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "raphaelr",
                                            "createdAt":  "2022-09-22T21:03:36Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "krobbox",
                                            "createdAt":  "2022-10-28T05:48:22Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "rabberbock",
                                            "createdAt":  "2023-02-05T16:48:19Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "madelson",
                                            "createdAt":  "2023-04-05T09:57:39Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "sol-wasserman",
                                            "createdAt":  "2023-04-28T05:51:07Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "mmarinchenko",
                                            "createdAt":  "2023-09-10T14:41:08Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "BobT2022",
                                            "createdAt":  "2023-10-05T11:03:58Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "anvouk",
                                            "createdAt":  "2023-11-18T21:36:31Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "filipw",
                                            "createdAt":  "2023-12-01T08:48:48Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "0xfeeddeadbeef",
                                            "createdAt":  "2023-12-16T16:03:27Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "weirdyang",
                                            "createdAt":  "2024-03-05T16:07:16Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "dario-l",
                                            "createdAt":  "2024-05-14T11:01:59Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "DavidGHyde",
                                            "createdAt":  "2024-07-29T14:25:46Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "g7ed6e",
                                            "createdAt":  "2024-08-08T13:34:32Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "MarioGruda",
                                            "createdAt":  "2024-09-14T07:35:56Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "vchirikov",
                                            "createdAt":  "2024-09-16T08:49:28Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "adamashton",
                                            "createdAt":  "2024-11-27T12:07:08Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "krosn",
                                            "createdAt":  "2025-02-18T23:02:54Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "kanadaj",
                                            "createdAt":  "2025-03-27T17:49:26Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "medianick",
                                            "createdAt":  "2025-03-31T22:20:41Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "LieselThuriot",
                                            "createdAt":  "2025-06-30T09:52:15Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "KLuuKer",
                                            "createdAt":  "2025-08-22T03:16:03Z"
                                        }
                                    ],
                          "totalCount":  27
                      },
        "updatedAt":  "2025-08-22T19:07:22Z",
        "body":  "Meta-issue to look at the ongoing problems around data protection key sync/race on new keyring.\r\n\r\n- https://github.com/dotnet/aspnetcore/issues/3514\r\n- https://github.com/dotnet/aspnetcore/issues/22554\r\n- https://github.com/dotnet/aspnetcore/issues/26786\r\n- https://github.com/dotnet/aspnetcore/issues/30752\r\n- https://github.com/dotnet/aspnetcore/issues/33071\r\n- https://github.com/dotnet/aspnetcore/issues/33116\r\n- https://github.com/dotnet/aspnetcore/issues/48848\r\n- https://github.com/dotnet/aspnetcore/issues/50440\r\n- https://github.com/dotnet/aspnetcore/issues/51165\r\n- https://github.com/dotnet/aspnetcore/issues/52678",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOv4DeXQ==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde843N2hM",
                                           "createdAt":  "2021-09-24T06:24:21Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "Tanmaybhujade",
                                           "body":  "Add Data Protection Race condition.",
                                           "updatedAt":  "2021-09-24T06:24:21Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85KDotJ",
                                           "createdAt":  "2022-09-09T21:00:48Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "Thanks for contacting us.\n\nWe\u0027re moving this issue to the `.NET 8 Planning` milestone for future evaluation / consideration. We would like to keep this around to collect more feedback, which can help us with prioritizing this work. We will re-evaluate this issue, during our next planning meeting(s). \nIf we later determine, that the issue has no community involvement, or it\u0027s very rare and low-impact issue, we will close it - so that the team can focus on more important and high impact issues.\nTo learn more about what to expect next and how this issue will be handled you can read more about our triage process [here](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2022-09-09T21:00:48Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85taqWb",
                                           "createdAt":  "2023-12-01T08:50:25Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "filipw",
                                           "body":  "The milestone should probably be updated again",
                                           "updatedAt":  "2023-12-01T08:50:25Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde858M7tH",
                                           "createdAt":  "2024-04-29T22:06:28Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "This should be substantially better in 9.0 Preview 4.  If you continue to see key-not-found errors in Preview 4, please tag me.",
                                           "updatedAt":  "2024-04-29T22:06:28Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86OtMSH",
                                           "createdAt":  "2024-10-04T17:32:33Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "I\u0027m going to close this on the (admittedly optimistic assumption) that things will be better in 9.0.  If that\u0027s not the case, we can open a new issue.",
                                           "updatedAt":  "2024-10-04T17:32:33Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86OtOYv",
                                           "createdAt":  "2024-10-04T17:34:24Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "Changed my mind - I think it\u0027s better to have a sink for related requests so I\u0027m going to close the child issues instead and point people here.",
                                           "updatedAt":  "2024-10-04T17:43:19Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86z956L",
                                           "createdAt":  "2025-06-30T14:19:18Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "BennyM",
                                           "body":  "We\u0027ve also been affected by this issue multiple times in our production environment, running .NET 8 on Azure App Services. It\u0027s caused downtime on several occasions, and it\u0027s becoming a critical concern for us. We\u0027d really appreciate any updates or guidance on a reliable workaround. Happy to provide more details if needed.",
                                           "updatedAt":  "2025-06-30T14:19:18Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86_gN5d",
                                           "createdAt":  "2025-08-22T03:19:05Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "KLuuKer",
                                           "body":  "Maybe the answer is to just make it async.... OR have extra `IXmlDecryptorAsync` `IXmlEncryptorAsync` `IXmlRepositoryAsync`\n\nbecause i keep having to do `.GetAwaiter().GetResult()` everywhere\nalso httpclient CANNOT do http/2 calls in sync code\n\n*cough* https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.http.logging.ihttpclientasynclogger *cough*",
                                           "updatedAt":  "2025-08-22T03:25:07Z"
                                       }
                                   ],
                         "totalCount":  8
                     },
        "title":  "Meta Issue - Data Protection keyring sync/creation race investigation",
        "labels":  [
                       "area-dataprotection"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/40145",
        "createdAt":  "2022-02-11T14:55:06Z",
        "number":  40145,
        "author":  "msschl",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHOC8ZnaQ==",
                          "nodes":  [
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "ernestopye",
                                            "createdAt":  "2023-01-20T22:02:43Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "Flash619",
                                            "createdAt":  "2023-06-04T04:19:28Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "rhamzatov",
                                            "createdAt":  "2023-08-11T10:39:48Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "bratisword",
                                            "createdAt":  "2024-11-05T03:00:09Z"
                                        }
                                    ],
                          "totalCount":  4
                      },
        "updatedAt":  "2025-08-22T18:01:21Z",
        "body":  "### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Is your feature request related to a problem? Please describe the problem.\n\nProtecting keys at rest is a good practice and is often done via the  `ProtectKeysWith...` methods like `ProtectKeysWithCertificate`.\r\nHowever, protecting the keys with for example `ProtectKeysWithCertificate` and an `X509Certificate2` keeps the problem of rotating the certificate used for protecting the keys at rest. Is there a good pattern or some documentation on this topic on how to proceed with rotation certificates used for key protection at rest without restarting the application?\n\n### Describe the solution you\u0027d like\n\nSome docs or a API to configure propper certificate rotation for the protection of key in rest.\n\n### Additional context\n\n_No response_",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOZW9yLw==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde849ycKr",
                                           "createdAt":  "2022-02-11T21:20:20Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "Thanks for contacting us.\n\nWe\u0027re moving this issue to the `.NET 7 Planning` milestone for future evaluation / consideration. We would like to keep this around to collect more feedback, which can help us with prioritizing this work. We will re-evaluate this issue, during our next planning meeting(s). \nIf we later determine, that the issue has no community involvement, or it\u0027s very rare and low-impact issue, we will close it - so that the team can focus on more important and high impact issues.\nTo learn more about what to expect next and how this issue will be handled you can read more about our triage process [here](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2022-02-11T21:20:20Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde849yc45",
                                           "createdAt":  "2022-02-11T21:23:29Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "blowdart",
                                           "body":  "There\u0027s no good pattern if you\u0027re trying to keep things with certificate locally, rather than key store.\r\n\r\nThe flow would be \r\n\r\n- Generate new certificate\r\n- Load it along side the existing one (whether in Windows Certificate store, or the folder in linux where you have your cert files)\r\n- Deploy that to your servers\r\n- Then update your code or configure to point to the new certificate\r\n- Deploy that\r\n- Done\r\n\r\nAnd never, ever, delete old certificates, even once they\u0027ve expired, otherwise your old keys aren\u0027t going to work (if you know you haven\u0027t encrypted anything at rest with the old certs, then you can clean up eventually when you feel like it.",
                                           "updatedAt":  "2022-02-11T21:23:29Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde8491hkO",
                                           "createdAt":  "2022-02-12T20:08:13Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "msschl",
                                           "body":  "We do use ef core to persist the keys into a database. \r\n\r\n\u003e * Then update your code or configure to point to the new certificate\r\n\r\nUnfortunately, there is no way to update the configuration to point to the new certificates, or is there?\r\nAs soon as `ProtectKeysWithCertificate` is called it seems like the certificate is configured to be used for the application lifetime.",
                                           "updatedAt":  "2022-02-12T20:09:09Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85KDuS_",
                                           "createdAt":  "2022-09-09T21:20:52Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "Thanks for contacting us.\n\nWe\u0027re moving this issue to the `.NET 8 Planning` milestone for future evaluation / consideration. We would like to keep this around to collect more feedback, which can help us with prioritizing this work. We will re-evaluate this issue, during our next planning meeting(s). \nIf we later determine, that the issue has no community involvement, or it\u0027s very rare and low-impact issue, we will close it - so that the team can focus on more important and high impact issues.\nTo learn more about what to expect next and how this issue will be handled you can read more about our triage process [here](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2022-09-09T21:20:52Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85O20zd",
                                           "createdAt":  "2022-11-22T03:40:53Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOC9P64Q==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "jesperkristensen",
                                                                               "createdAt":  "2023-06-06T12:35:25Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "jeremy-morren",
                                           "body":  "I would like to state that the current API works, however there is practically no documentation or examples available online.  Having **literally any** documentation (beyond the fact that the methods exist) would be nice.  As mentioned, there is no way to change the certificates once the application has started. If you have long-running processes, this is a problem.\r\n\r\nAnother problem (not with .NET itself, all crypto has this problem) is that the private keys have to be stored *somewhere*.  The whole keyring must itself be encrypted, this is still the developers problem.\r\n\r\nThe current workflow is as follows (as far as I can make out) - it would be nice if this was officially documented somewhere:\r\n\r\n- At any time, there is 1 certificate that is used for encryption and decryption, and 0 or more used for decryption only.  These function as \u0027superkeys\u0027: i.e. encryption keys used to encrypt the encryption keys.  \r\n- To generate a new encryption key:\r\n  - The key is generated\r\n  - The key is encrypted using the current encryption certificate. This is done by the `CertificateXmlEncryptor` class.\r\n  - The *public* portion of the certificate is stored in the key.\r\n  - The key is persisted to the configured `IXmlRepository` (Redis, File etc).\r\n- When a key is loaded and needs to be decrypted\r\n  - The thumbprint of the encryption certificate is loaded from the previously stored public portion.\r\n  - The thumbprint is looked up in the internal `XmlKeyDecryptionOptions` class.  If the certificate is not found, an error occurs (i.e. no payloads encrypted with this key can be decrypted).\r\n  - The key is decrypted using the private key of the loaded certificate.\r\n\r\nAs already mentioned, this process is not officially documented anywhere I can find. I am also not 100% sure if that is a correct explanation either, due to the lack of documentation.\r\n",
                                           "updatedAt":  "2022-11-22T03:41:22Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85lb10b",
                                           "createdAt":  "2023-08-31T21:16:27Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@jeremy-morren We have some docs but they\u0027re not very discoverable.\r\n\r\nhttps://learn.microsoft.com/aspnet/core/security/data-protection/introduction\r\nhttps://learn.microsoft.com/aspnet/core/host-and-deploy/scaling-aspnet-apps/scaling-aspnet-apps\r\n\r\nI think the second one might have been authored after you made your comment.  Did you already have a look at these docs (at least, the ones that existed at the time) and find them inadequate or were they too hard to find?\r\n\r\nBy the way, were the steps you listed intended to address the original question in this issue (how do you swap out the cert that\u0027s protecting your keys) or were they just general steps for using Data Protection in aspnetcore?",
                                           "updatedAt":  "2023-08-31T21:17:34Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85lb3Iv",
                                           "createdAt":  "2023-08-31T21:20:44Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHODzFhuQ==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "heldersantovisma",
                                                                               "createdAt":  "2024-05-06T11:11:18Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "johnwc",
                                                                               "createdAt":  "2024-09-21T02:54:18Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  2
                                                         },
                                           "author":  "amcasey",
                                           "body":  "I see a few things going on here:\r\n\r\n1. There\u0027s no built-in way to rotate (non-key store) certificates without re-deploying\r\n2. There are no documents saying as much (generally speaking, I think not documenting missing functionality is fine if it\u0027s not a surprising gap that requires a mitigation)\r\n3. The general Data Protection documentation is lacking\r\n\r\nHave I missed anything?  If not, I\u0027d say this should be two issues - one for improving the docs and another proposing we add certificate rotation support (no promises).",
                                           "updatedAt":  "2023-08-31T21:20:44Z"
                                       }
                                   ],
                         "totalCount":  7
                     },
        "title":  "AspNetCore.DataProtection `ProtectKeysWithCertificate` rotation mechanism",
        "labels":  [
                       "area-dataprotection",
                       "Docs",
                       "net8_docathon"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/41252",
        "createdAt":  "2022-04-19T00:58:14Z",
        "number":  41252,
        "author":  "JamesNK",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHOCrkATA==",
                          "nodes":  [
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "KLuuKer",
                                            "createdAt":  "2022-11-22T11:24:34Z"
                                        }
                                    ],
                          "totalCount":  1
                      },
        "updatedAt":  "2024-09-25T16:15:26Z",
        "body":  "### Is there an existing issue for this?\r\n\r\n- [X] I have searched the existing issues\r\n\r\n### Is your feature request related to a problem? Please describe the problem.\r\n\r\nWe\u0027re annotating ASP.NET Core for trimming in .NET 7. In theory, the linker and trim warnings should ensure frameworks, libraries and apps work.\r\n\r\nWe should double-check that ASP.NET Core continues to run in some trimmed, published apps.\r\n\r\n### Describe the solution you\u0027d like\r\n\r\nWith trimming it\u0027s difficult to test trimmed features in isolation, e.g. an app uses features A and B. Did A and B only work because they were both used, etc. Building and running an app to test each feature in isolation isn\u0027t realistic.\r\n\r\nWe should do some basic smoke testing of core scenarios.\r\n\r\ne.g.\r\nMVC\r\nMinimal API\r\nSignalR\r\nAuthN/AuthZ\r\nKestrel/IIS/HttpSys\r\nData protection/security/identity\r\n\r\n### Additional context\r\n\r\n_No response_",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOjYgn5A==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde85BtU6k",
                                           "createdAt":  "2022-04-19T09:42:55Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "javiercn",
                                           "body":  "@JamesNK you can take inspiration on how we test trimming in Blazor Webassembly apps. We trim the projects on the CI only based on the Release configuration.",
                                           "updatedAt":  "2022-04-19T09:42:55Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85BvEmX",
                                           "createdAt":  "2022-04-19T16:35:10Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "mkArtakMSFT",
                                           "body":  "@JamesNK how do you want all of us to track this? Do you want to put out a PR to which everyone will contribute or file separate issues?",
                                           "updatedAt":  "2022-04-19T16:35:10Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85Bwdhm",
                                           "createdAt":  "2022-04-19T22:18:42Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "Thanks for contacting us.\n\nWe\u0027re moving this issue to the `.NET 7 Planning` milestone for future evaluation / consideration. We would like to keep this around to collect more feedback, which can help us with prioritizing this work. We will re-evaluate this issue, during our next planning meeting(s). \nIf we later determine, that the issue has no community involvement, or it\u0027s very rare and low-impact issue, we will close it - so that the team can focus on more important and high impact issues.\nTo learn more about what to expect next and how this issue will be handled you can read more about our triage process [here](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2022-04-19T22:18:42Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85Gx48t",
                                           "createdAt":  "2022-07-18T13:50:15Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "hez2010",
                                           "body":  "Seems that Blazor doesn\u0027t support `/p:TrimMode=full` (with .NET 7 nightly sdk). If I use `/p:TrimMode=full` while publishing, even a hello world blazor wasm website will fail to load because of trimming.",
                                           "updatedAt":  "2022-07-18T13:50:15Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85M8agy",
                                           "createdAt":  "2022-10-25T17:34:03Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "mkArtakMSFT",
                                           "body":  "\u003e Seems that Blazor doesn\u0027t support `/p:TrimMode=full` (with .NET 7 nightly sdk). If I use `/p:TrimMode=full` while publishing, even a hello world blazor wasm website will fail to load because of trimming.\r\n\r\n@hez2010 can you please file a separate issue for this? Thanks!",
                                           "updatedAt":  "2022-10-25T17:34:03Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85O2A_F",
                                           "createdAt":  "2022-11-21T23:14:34Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "Thanks for contacting us.\n\nWe\u0027re moving this issue to the `.NET 8 Planning` milestone for future evaluation / consideration. We would like to keep this around to collect more feedback, which can help us with prioritizing this work. We will re-evaluate this issue, during our next planning meeting(s). \nIf we later determine, that the issue has no community involvement, or it\u0027s very rare and low-impact issue, we will close it - so that the team can focus on more important and high impact issues.\nTo learn more about what to expect next and how this issue will be handled you can read more about our triage process [here](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2022-11-21T23:14:34Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85xp6do",
                                           "createdAt":  "2024-01-23T19:48:42Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@JamesNK I feel like we have a much more sophisticated understanding of our trimming needs now.  Is this issue still relevant?",
                                           "updatedAt":  "2024-01-23T19:48:42Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85xqwoW",
                                           "createdAt":  "2024-01-23T22:34:56Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "JamesNK",
                                           "body":  "Tests are still important. Does trimming have enough tests? If yes, then close this.",
                                           "updatedAt":  "2024-01-23T22:34:56Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86LnLbR",
                                           "createdAt":  "2024-09-10T22:56:19Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "captainsafia",
                                           "body":  "Assuming the coverage we want here is via the `Trimming.Tests` and `NativeAoT.Tests` infrastructure that is documented [in this doc](https://github.com/dotnet/aspnetcore/blob/951b6ead6510409a7847481f818963e696686ca9/docs/Trimming.md#adding-a-new-test-project), we have coverage for SignalR, OpenAPI, DataProtection, and WebApplicationBuilder so far. We also have source generator tests for minimal APIs that validate compile-time and runtime behavior.\r\n\r\nI think the authentication-related APIs are where we currently have a testing gap. @halter73 confirm if I am wrong.",
                                           "updatedAt":  "2024-09-10T22:56:19Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86MpsAE",
                                           "createdAt":  "2024-09-19T01:35:01Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "halter73",
                                           "body":  "We definitely have a gap for a lot of auth-related stuff. There are other areas we don\u0027t appear to test trimmed output including MVC/Razor Pages, gRPC, Blazor Server/Web, IIS/HttpSys, static files/assets, and various other middleware. I\u0027m pretty sure we don\u0027t have any plans to support trimming MVC. I\u0027m not sure about the other stuff.",
                                           "updatedAt":  "2024-09-19T01:35:53Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86NiCfk",
                                           "createdAt":  "2024-09-25T16:05:50Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "mkArtakMSFT",
                                           "body":  "@halter73 can you please file a separate issue for our part of this work, so that we can park it in .NET 10 planning and go from there.",
                                           "updatedAt":  "2024-09-25T16:05:50Z"
                                       }
                                   ],
                         "totalCount":  11
                     },
        "title":  "Testing ASP.NET Core with trimming",
        "labels":  [
                       "task",
                       "area-dataprotection",
                       "area-mvc",
                       "area-auth",
                       "area-signalr",
                       "linker-friendliness",
                       "area-networking"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/43278",
        "createdAt":  "2022-08-14T09:31:16Z",
        "number":  43278,
        "author":  "etki",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHODNkOrw==",
                          "nodes":  [
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "basilioss",
                                            "createdAt":  "2023-02-14T17:38:52Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "ZerdoX-x",
                                            "createdAt":  "2023-08-24T01:04:03Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "lordzsolt",
                                            "createdAt":  "2023-09-03T22:50:03Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "Qu4tro",
                                            "createdAt":  "2024-02-09T02:47:45Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "BorisWilhelms",
                                            "createdAt":  "2024-03-11T20:06:38Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "StringEpsilon",
                                            "createdAt":  "2024-03-31T15:26:41Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "ariellourenco",
                                            "createdAt":  "2024-04-13T18:27:03Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "samnung",
                                            "createdAt":  "2024-04-25T15:05:24Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "thefiredman",
                                            "createdAt":  "2025-05-01T04:32:10Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "chuckwolber",
                                            "createdAt":  "2025-08-12T13:06:14Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "Frestein",
                                            "createdAt":  "2025-08-12T19:01:50Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "KennethHoff",
                                            "createdAt":  "2025-08-31T18:02:29Z"
                                        }
                                    ],
                          "totalCount":  12
                      },
        "updatedAt":  "2025-08-30T21:47:16Z",
        "body":  "### Is there an existing issue for this?\r\n\r\n- [X] I have searched the existing issues\r\n\r\n### Is your feature request related to a problem? Please describe the problem.\r\n\r\nHenlo. This is a classic issue raised in any project.\r\nCurrently ASP.NET pollutes user $HOME directories by placing an unnecessary folder there:\r\n\r\n```js\r\nconst baseFolder =\r\n  process.env.APPDATA !== undefined \u0026\u0026 process.env.APPDATA !== \u0027\u0027\r\n    ? `${process.env.APPDATA}/ASP.NET/https`\r\n    : `${process.env.HOME}/.aspnet/https`;\r\n```\r\n\r\n```c#\r\n// Use*NIX conventions for a folder name.\r\nretVal = new DirectoryInfo(Path.Combine(homePath, \".aspnet\", DataProtectionKeysFolderName));\r\n```\r\n\r\nhttps://github.com/dotnet/aspnetcore/blob/d6047b42ffedcd24d45f627e0a96b92ead6c8e00/src/DataProtection/DataProtection/src/Repositories/DefaultKeyStorageDirectories.cs#L59-L60\r\n\r\nThis is a common pain for a long time for many people on unix-like platforms. I, as a user, want to have a sane output of directory listing, however any search that includes hidden dot-directories brings serious distraction when every tool strives to create a separate directory there:\r\n\r\n```\r\nfind $HOME -maxdepth 1 -name \u0027.*\u0027 | wc -l\r\n70\r\n```\r\n\r\n### Describe the solution you\u0027d like\r\n\r\nThere is a long-standing and widely adopted solution for that called [XDG convention](https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html). Long story short, it defines several folders for common usage (configuration, state, cache, etc.) which can be additionally configured via environmental variables, and suggests that applications should create sub-directories there and store their own files in an organized fashion. In example above JS code uses AppData folder, which is the experience i expect as user; XDG convention provides AppData folder equivalent for unix-like environments.\r\n\r\nI suggest adopting XDG convention and bring some relief to end users during one of the major releases, and also placing ASP.NET folder within `Microsoft` folder, since without any grouping `.config` listings are a pain as well.\r\n\r\n### Additional context\r\n\r\n_No response_",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOwRe-3w==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde85Ieeoz",
                                           "createdAt":  "2022-08-15T22:45:46Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "adityamandaleeka",
                                           "body":  "We should look into this in .NET 8.\r\n\r\nIt\u0027ll be important to make sure that the upgrade scenarios work (e.g. data protection keys in the old location don\u0027t get lost).",
                                           "updatedAt":  "2022-08-15T22:45:46Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85PBNny",
                                           "createdAt":  "2022-11-23T22:13:55Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOEgQtOA==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "ariellourenco",
                                                                               "createdAt":  "2025-08-30T21:47:41Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "Spacefish",
                                           "body":  "Maybe implement the following behaviour:\r\n- If `$HOME/.aspnet` exists -\u003e move `$HOME/.aspnet` to `$HOME/.config/Microsoft/ASP.NET` and create a Symlink under `$HOME/.aspnet` to the new folder\r\n- If it does not exists, don´t create a symlink\r\n\r\nratio: If the folder exists, the user might have used it with an older version, if it does not exist, it´s unlinkely that the user will use .NET 8 and switch back to .NET 7 or older later on an expect his configs from .NET 8.0 to carry over.\r\nFurthermore the user can just delete the symlink if he plans to only use .NET 8.0+",
                                           "updatedAt":  "2022-11-23T22:13:55Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85yAeTi",
                                           "createdAt":  "2024-01-26T21:35:04Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOEeCmTw==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_DOWN",
                                                                               "user":  "Qu4tro",
                                                                               "createdAt":  "2024-02-09T02:47:30Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_DOWN",
                                                                               "user":  "glyh",
                                                                               "createdAt":  "2024-03-22T15:33:54Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_DOWN",
                                                                               "user":  "StringEpsilon",
                                                                               "createdAt":  "2024-03-31T15:26:48Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_DOWN",
                                                                               "user":  "OreoLamp",
                                                                               "createdAt":  "2024-04-09T09:48:24Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_DOWN",
                                                                               "user":  "mayurankv",
                                                                               "createdAt":  "2024-06-07T09:02:22Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_DOWN",
                                                                               "user":  "ariellourenco",
                                                                               "createdAt":  "2024-08-22T11:00:45Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_DOWN",
                                                                               "user":  "Igetin",
                                                                               "createdAt":  "2024-10-12T11:50:12Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_DOWN",
                                                                               "user":  "mistekko",
                                                                               "createdAt":  "2025-02-27T04:24:08Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_DOWN",
                                                                               "user":  "thefiredman",
                                                                               "createdAt":  "2025-05-01T04:32:32Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_DOWN",
                                                                               "user":  "FracturedCode",
                                                                               "createdAt":  "2025-07-07T07:00:58Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_DOWN",
                                                                               "user":  "chuckwolber",
                                                                               "createdAt":  "2025-08-12T13:06:47Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_DOWN",
                                                                               "user":  "Frestein",
                                                                               "createdAt":  "2025-08-12T19:02:21Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  12
                                                         },
                                           "author":  null,
                                           "body":  "We\u0027ve moved this issue to the Backlog milestone. This means that it is not going to be worked on for the coming release. We will reassess the backlog following the current release and consider this item at that time. To learn more about our issue management process and to have better expectation regarding different types of issues you can read our [Triage Process](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2024-01-26T21:35:04Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde87BF77f",
                                           "createdAt":  "2025-08-30T21:44:56Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "ariellourenco",
                                           "body":  "On Mac, we should use `~/Library/Application Support`. Visual Studio Code, and other Microsoft products such as C# DevKit, already creates a folder called **Microsoft** which has a few subfolders on it, such as `DeveloperTools` and `Visual Studio`, which we can use to store these files.\n\n\u003chttps://github.com/microsoft/vscode-deviceid/blob/81de4b4a804505fd912ffbc7b738c8cf662b3d93/src/storage.ts#L15C1-L32C2\u003e\n\nSomething like: `˜/Library/Application Support/Microsoft/ASP.NET`",
                                           "updatedAt":  "2025-08-30T21:47:16Z"
                                       }
                                   ],
                         "totalCount":  4
                     },
        "title":  "Use $HOME/.config/Microsoft/ASP.NET instead of $HOME/.aspnet in unix-like environments",
        "labels":  [
                       "area-dataprotection"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/43500",
        "createdAt":  "2022-08-23T22:10:19Z",
        "number":  43500,
        "author":  "maganuk",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHODBsvzg==",
                          "nodes":  [
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "madelson",
                                            "createdAt":  "2023-04-05T09:57:16Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "sol-wasserman",
                                            "createdAt":  "2023-04-28T05:44:56Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "cfauchere",
                                            "createdAt":  "2024-01-26T04:33:05Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "dystopiandev",
                                            "createdAt":  "2025-04-25T01:34:19Z"
                                        }
                                    ],
                          "totalCount":  4
                      },
        "updatedAt":  "2024-01-26T21:31:18Z",
        "body":  "### Is there an existing issue for this?\r\n\r\n- [X] I have searched the existing issues\r\n\r\n### Is your feature request related to a problem? Please describe the problem.\r\n\r\nI have a multi-tenant application where I would like for each tenant to have their own data protection keys which are saved in a DB. I find that there is no way to do this (without writing my own DataProtectionProvider) since the keys are always cached. Even if I were to write my own XML Repository, I am unable to use it on a per-request basis as the keys are already valid for a period of 24 hours.\r\n\r\n### Describe the solution you\u0027d like\r\n\r\nProvide an option to not cache keys so that it may be possible for developers to use their own cache and resolve keys on a per request basis.",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOcgHUzg==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde85JBrEN",
                                           "createdAt":  "2022-08-24T04:27:31Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "adityamandaleeka",
                                           "body":  "Removing milestone temporarily so it comes up in triage.",
                                           "updatedAt":  "2022-08-24T04:27:31Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85xp8Xb",
                                           "createdAt":  "2024-01-23T19:54:29Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@maganuk Sorry for the delay.  Can you please elaborate a bit more on the problem you\u0027re encountering?  Why would caching prevent you from using [multi-tenancy](https://learn.microsoft.com/aspnet/core/security/data-protection/consumer-apis/purpose-strings-multitenancy)?",
                                           "updatedAt":  "2024-01-23T19:54:29Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85xqD0_",
                                           "createdAt":  "2024-01-23T20:16:23Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "maganuk",
                                           "body":  "@amcasey thanks for picking this up. \r\n\r\nSo assume that new tenants are being registered dynamically at runtime. I\u0027d like each tenant to have its own data protection key. \r\n\r\nCurrently, the way the Keyring provider is setup, the keys cannot be resolved at runtime. They are always picked up from the internal cache. Even if I try to implement my own IKeyManager, the keys will always be cached. \r\n\r\nIn my case I want to use my own caching layer and be able to resolve keys at runtime rather than depending on the framework to handle the caching. Further, I have a scoped Tenant Service which I need to access to resolve the current tenant to fetch the data protection key. I\u0027ve therefore had to write my own DataProtectionProvider to do this. Would be better if the framework allows more flexibility for doing this.",
                                           "updatedAt":  "2024-01-23T20:16:51Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85xrCbX",
                                           "createdAt":  "2024-01-23T23:52:03Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "Unfortunately, the term \"key\" is quite overloaded in this space, so I\u0027d like to make sure we\u0027re on the same page.  The way Data Protection expects to enable multi-tenancy is through [purpose strings](https://learn.microsoft.com/aspnet/core/security/data-protection/consumer-apis/purpose-strings), the values of which can be specified dynamically.  Separate derived keys (sometimes called Data Encryption Keys (DEKs)) will be created for each purpose.\r\n\r\nIs this the sort of key you\u0027re referring to when you say you \"like each tenant to have its own data protection key\"?",
                                           "updatedAt":  "2024-01-23T23:52:03Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85xrjPQ",
                                           "createdAt":  "2024-01-24T02:23:24Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHODULAIQ==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "cfauchere",
                                                                               "createdAt":  "2024-01-26T04:33:34Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "maganuk",
                                           "body":  "Actually no, I mean a separate master key for each tenant. The reason I say that is because as part of our product offering (it\u0027s an IAM service), we would like to offer our customers the ability to store these keys at their end or take the keys with them when they migrate away from us. We are using the derived keys too, but they are scoped to different purposes within a tenant.",
                                           "updatedAt":  "2024-01-24T02:23:24Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85xxL-g",
                                           "createdAt":  "2024-01-24T18:44:33Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "I think it\u0027s great that you\u0027re giving your customers that level of control, but that scenario\u0027s a bit outside the design goals of the data protection system.  In particular, it\u0027s only intended for ephemeral (i.e. expendable) data, which there would normally be no reason to export.  If you did want to offer some sort of export functionality, I would think you\u0027d want to decrypt the data on-demand and then re-encrypt it with a new key specifically for/from that customer.\r\n",
                                           "updatedAt":  "2024-01-24T18:44:33Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85xxMKe",
                                           "createdAt":  "2024-01-24T18:45:06Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "I remain a little unclear on which keys you want to have more control over.  Is it the ones that encrypt the keyring or the ones that encrypt the data?",
                                           "updatedAt":  "2024-01-24T18:45:06Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85xxRyN",
                                           "createdAt":  "2024-01-24T19:00:41Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "maganuk",
                                           "body":  "Thanks for your consideration. The key we\u0027re after are the ones that encrypt the data. \r\n\r\nEven though the comparison is a bit distant, but have a look at the Field level encryption key in MongoDB Atlas. They let you create as many keys as you want and each key can belong to a tenant. The idea there is that if you want to forget a customer, all you do is delete the respective key. \r\n\r\nWith the above approach that you have suggested we still cant have our customers own their keys. Our product is an authentication-as-a-service platform, where customers have users who may have long lived cookies encrypted by the Data Protection provider. Now if our customers want to migrate away from us, they would want to take these keys with them so that they don\u0027t loose these cookies, else their users would have lost state and would be required to re-authenticate. ",
                                           "updatedAt":  "2024-01-24T19:04:30Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85xxgRT",
                                           "createdAt":  "2024-01-24T19:43:02Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "Wow, changing authentication platforms without disrupting user sessions is a pretty ambitious goal.\r\n\r\nSo, I think the \"cache\" you\u0027re referring to is the fact that the keyring is (only) polled (e.g. from disk) every 24 hours.  Is that right?  If so, I\u0027m not sure I understand how going straight to disk (or whatever repository) every time would help, since it\u0027s actually derived keys that are used to encrypt data.  Without having stepped through the code, I would only expect the keyring keys to be accessed when a new purpose string is introduced.  Is that what you\u0027re doing - generating a lot of dynamic purpose strings and trying to use a (potentially) different keyring each time?  And the reason for doing that is to be able to offer your customer the backing keyring.xml file(s)?",
                                           "updatedAt":  "2024-01-24T19:43:02Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85xxkRy",
                                           "createdAt":  "2024-01-24T19:54:45Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "maganuk",
                                           "body":  "Ambitious indeed. Initially we plan to use it only to move customers from Public to Private cloud (without disruption). \r\n\r\nIn the KeyRingBasedDataProtector, it is this particular line:\r\n\r\n````\r\nvar currentKeyRing = _keyRingProvider.GetCurrentKeyRing();\r\n````\r\nOn every request, after resolving the tenant, we would like to fetch the key ring for the tenant (resolving a scoped instance of the keyring provider store).\r\n\r\nIn the custom provider that we have written, we are injecting a dataprotection store in the KeyRingBasedDataProtector and calling:\r\n\r\n```\r\nvar defaultKey = _dataProtectionStore.GetDefaultKey();\r\nvar defaultEncryptorInstance = defaultKey.CreateEncryptor();\r\n```\r\n\r\n",
                                           "updatedAt":  "2024-01-24T19:58:23Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85yAcq-",
                                           "createdAt":  "2024-01-26T21:28:58Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "#53455 is another request to be able to partition master keys (i.e. the ones in the keyring) by tenant.",
                                           "updatedAt":  "2024-01-26T21:28:58Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85yAdPr",
                                           "createdAt":  "2024-01-26T21:31:05Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHODUSt9A==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "maganuk",
                                                                               "createdAt":  "2024-01-27T05:45:44Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@maganuk Thanks for taking the time to lay out your requirements!  That\u0027s not a scenario we can prioritize right now, but the conversation above will make it much easier to collect additional support for the request and revisit it in the future.",
                                           "updatedAt":  "2024-01-26T21:31:05Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85yAdTO",
                                           "createdAt":  "2024-01-26T21:31:18Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "We\u0027ve moved this issue to the Backlog milestone. This means that it is not going to be worked on for the coming release. We will reassess the backlog following the current release and consider this item at that time. To learn more about our issue management process and to have better expectation regarding different types of issues you can read our [Triage Process](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2024-01-26T21:31:18Z"
                                       }
                                   ],
                         "totalCount":  13
                     },
        "title":  "Allow option for DataProtection keys to not be cached",
        "labels":  [
                       "enhancement",
                       "area-dataprotection"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/43682",
        "createdAt":  "2022-09-01T01:58:14Z",
        "number":  43682,
        "author":  "analogrelay",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHOCwnOnw==",
                          "nodes":  [
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "rajmondburgaj",
                                            "createdAt":  "2023-03-04T14:44:17Z"
                                        },
                                        {
                                            "content":  "EYES",
                                            "user":  "madelson",
                                            "createdAt":  "2023-04-05T09:55:29Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "F2",
                                            "createdAt":  "2023-06-10T12:07:58Z"
                                        }
                                    ],
                          "totalCount":  3
                      },
        "updatedAt":  "2025-03-17T11:04:33Z",
        "body":  "### Is there an existing issue for this?\r\n\r\n- [X] I have searched the existing issues\r\n\r\n### Describe the bug\r\n\r\nWe use Data Protection to encrypt sensitive values in long-term storage. While testing .NET 7.0, we found that our app was unable to decrypt payloads encrypted by .NET 6.0, even when the same keys were available and the same purpose was used. This means that upgrading to .NET 7 causes users to be logged out of our site (since the auth cookie cannot be validated) and our app is no longer able to decrypt data which it had previously encrypted and stored in durable storage (database, etc.).\r\n\r\nI was able to isolate this into a simple repro console app: https://github.com/anurse/dataprotection-repro\r\n\r\nThe app runs on both `net6.0` and `net7.0` and can protect/unprotect values. Running `.\\ReproApp protect \"Some string\"` on `net6.0` produces a Base64 protected value. Passing that same payload into `.\\ReproApp unprotect` on `net6.0` **successfully unprotects the string**. However, passing it in to the same `.\\ReproApp unprotect` command in the same app when running on `net7.0` fails with the following error:\r\n\r\n```\r\nUnhandled exception. System.Security.Cryptography.CryptographicException: The payload was invalid. For more information go to http://aka.ms/dataprotectionwarning\r\n   at Microsoft.AspNetCore.DataProtection.Managed.ManagedAuthenticatedEncryptor.Decrypt(ArraySegment`1 protectedPayload, ArraySegment`1 additionalAuthenticatedData)\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.UnprotectCore(Byte[] protectedData, Boolean allowOperationsOnRevokedKeys, UnprotectStatus\u0026 status)\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.Unprotect(Byte[] protectedData)\r\n   at Microsoft.AspNetCore.DataProtection.DataProtectionCommonExtensions.Unprotect(IDataProtector protector, String protectedData)\r\n   at Program.Main(String[] args) in /Users/anurse/code/anurse/dataprotection-repro/ReproApp/Program.cs:line 35\r\n   at Program.\u003cMain\u003e(String[] args)\r\n```\r\n\r\nFurther debugging traced this down to this line:\r\n\r\nhttps://github.com/dotnet/aspnetcore/blob/8f0d440d4251ae479966b65c7b331841adb70aa6/src/DataProtection/DataProtection/src/Managed/ManagedAuthenticatedEncryptor.cs#L235-L240\r\n\r\nThe MAC check appears to be failing. I wasn\u0027t using a Debug build, so I wasn\u0027t able to check if the MAC was _actually_ different, or if this is a bug in the equality comparison.\r\n\r\n### Expected Behavior\r\n\r\nWhen running the `run-repro` script in the provided repository, the output should be something like this:\r\n\r\n```\r\n... build output ...\r\n\r\nProtecting: \u0027This is a test message\u0027\r\n*** Protecting with .NET 6.0 ... ***\r\nProtected string: \u003ctrimmed\u003e\r\nUnprotecting with .NET 6.0 ...\r\nThis is a test message\r\nUnprotecting with .NET 7.0 ...\r\nThis is a test message\r\n*** Protecting with .NET 7.0 ... ***\r\nProtected string: \u003ctrimmed\u003e\r\nUnprotecting with .NET 6.0 ...\r\nThis is a test message\r\nUnprotecting with .NET 7.0 ...\r\nThis is a test message\r\n```\r\n\r\nThe actual behavior is that an exception is thrown when unprotecting with a different major version than the data was originally protected with:\r\n\r\n```\r\n... build output ...\r\n\r\nProtecting: \u0027This is a test message\u0027\r\n*** Protecting with .NET 6.0 ... ***\r\nProtected string: \u003ctrimmed\u003e\r\nUnprotecting with .NET 6.0 ...\r\nThis is a test message\r\nUnprotecting with .NET 7.0 ...\r\nUnhandled exception. System.Security.Cryptography.CryptographicException: The payload was invalid. For more information go to http://aka.ms/dataprotectionwarning\r\n   at Microsoft.AspNetCore.DataProtection.Managed.ManagedAuthenticatedEncryptor.Decrypt(ArraySegment`1 protectedPayload, ArraySegment`1 additionalAuthenticatedData)\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.UnprotectCore(Byte[] protectedData, Boolean allowOperationsOnRevokedKeys, UnprotectStatus\u0026 status)\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.Unprotect(Byte[] protectedData)\r\n   at Microsoft.AspNetCore.DataProtection.DataProtectionCommonExtensions.Unprotect(IDataProtector protector, String protectedData)\r\n   at Program.Main(String[] args) in /Users/anurse/code/anurse/dataprotection-repro/ReproApp/Program.cs:line 35\r\n   at Program.\u003cMain\u003e(String[] args)\r\n*** Protecting with .NET 7.0 ... ***\r\nProtected string: \u003ctrimmed\u003e\r\nUnprotecting with .NET 6.0 ...\r\nUnhandled exception. System.Security.Cryptography.CryptographicException: The payload was invalid. For more information go to http://aka.ms/dataprotectionwarning\r\n   at Microsoft.AspNetCore.DataProtection.Managed.ManagedAuthenticatedEncryptor.Decrypt(ArraySegment`1 protectedPayload, ArraySegment`1 additionalAuthenticatedData)\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.UnprotectCore(Byte[] protectedData, Boolean allowOperationsOnRevokedKeys, UnprotectStatus\u0026 status)\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.Unprotect(Byte[] protectedData)\r\n   at Microsoft.AspNetCore.DataProtection.DataProtectionCommonExtensions.Unprotect(IDataProtector protector, String protectedData)\r\n   at Program.Main(String[] args) in /Users/anurse/code/anurse/dataprotection-repro/ReproApp/Program.cs:line 35\r\n   at Program.\u003cMain\u003e(String[] args)\r\nUnprotecting with .NET 7.0 ...\r\nThis is a test message\r\n```\r\n\r\n### Steps To Reproduce\r\n\r\n1. Clone the repro repo: http://github.com/anurse/dataprotection-repro\r\n2. Ensure you have .NET 6 and .NET 7 installed\r\n3. Mac/Linux: Run `./run-repro` script\r\n4. Windows:\r\n    1. Run `dotnet run --project .\\ReproApp --framework net6.0 -- protect \"a test string\"`\r\n    2. Copy the output string\r\n    3. Run `dotnet run --project .\\ReproApp --framework net6.0 -- unprotect \"\u003cpaste\u003e\"`\r\n    4. Run `dotnet run --project .\\ReproApp --framework net7.0 -- unprotect \"\u003cpaste\u003e\"`\r\n\r\n### Exceptions (if any)\r\n\r\n```\r\nUnhandled exception. System.Security.Cryptography.CryptographicException: The payload was invalid. For more information go to http://aka.ms/dataprotectionwarning\r\n   at Microsoft.AspNetCore.DataProtection.Managed.ManagedAuthenticatedEncryptor.Decrypt(ArraySegment`1 protectedPayload, ArraySegment`1 additionalAuthenticatedData)\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.UnprotectCore(Byte[] protectedData, Boolean allowOperationsOnRevokedKeys, UnprotectStatus\u0026 status)\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.Unprotect(Byte[] protectedData)\r\n   at Microsoft.AspNetCore.DataProtection.DataProtectionCommonExtensions.Unprotect(IDataProtector protector, String protectedData)\r\n   at Program.Main(String[] args) in /Users/anurse/code/anurse/dataprotection-repro/ReproApp/Program.cs:line 35\r\n   at Program.\u003cMain\u003e(String[] args)\r\n```\r\n\r\n### .NET Version\r\n\r\n7.0.100-preview.7.22377.5\r\n\r\n### Anything else?\r\n\r\nSince multiple .NET runtimes are involved, here\u0027s my `dotnet --info` output:\r\n\r\n```\r\n.NET SDK:\r\n Version:   7.0.100-preview.7.22377.5\r\n Commit:    ba310d9309\r\n\r\nRuntime Environment:\r\n OS Name:     Mac OS X\r\n OS Version:  12.0\r\n OS Platform: Darwin\r\n RID:         osx.12-arm64\r\n Base Path:   /usr/local/share/dotnet/sdk/7.0.100-preview.7.22377.5/\r\n\r\nHost:\r\n  Version:      7.0.0-preview.7.22375.6\r\n  Architecture: arm64\r\n  Commit:       eecb028078\r\n\r\n.NET SDKs installed:\r\n  6.0.301 [/usr/local/share/dotnet/sdk]\r\n  6.0.400 [/usr/local/share/dotnet/sdk]\r\n  7.0.100-preview.7.22377.5 [/usr/local/share/dotnet/sdk]\r\n\r\n.NET runtimes installed:\r\n  Microsoft.AspNetCore.App 6.0.6 [/usr/local/share/dotnet/shared/Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 6.0.8 [/usr/local/share/dotnet/shared/Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 7.0.0-preview.7.22376.6 [/usr/local/share/dotnet/shared/Microsoft.AspNetCore.App]\r\n  Microsoft.NETCore.App 6.0.6 [/usr/local/share/dotnet/shared/Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 6.0.8 [/usr/local/share/dotnet/shared/Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 7.0.0-preview.7.22375.6 [/usr/local/share/dotnet/shared/Microsoft.NETCore.App]\r\n```",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOoqqDYg==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde85Jk_8q",
                                           "createdAt":  "2022-09-01T15:25:13Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOC7XRaw==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "EYES",
                                                                               "user":  "brockallen",
                                                                               "createdAt":  "2022-09-07T20:10:19Z"
                                                                           },
                                                                           {
                                                                               "content":  "EYES",
                                                                               "user":  "szpejarka",
                                                                               "createdAt":  "2023-05-09T13:37:28Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  2
                                                         },
                                           "author":  "blowdart",
                                           "body":  "@adityamandaleeka this should get triaged asap. If upgrading breaks data protection with an existing keyring that\u0027s bad.",
                                           "updatedAt":  "2022-09-01T15:25:13Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85JmTCI",
                                           "createdAt":  "2022-09-01T21:00:07Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "HaoK",
                                           "body":  "@wtgodbe this might be related to https://github.com/dotnet/aspnetcore/issues/40964 again, maybe there\u0027s a different code path that also needs normalization",
                                           "updatedAt":  "2022-09-01T21:00:07Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J023W",
                                           "createdAt":  "2022-09-06T20:00:02Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOCrwj1A==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "HOORAY",
                                                                               "user":  "analogrelay",
                                                                               "createdAt":  "2022-09-06T20:02:18Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "wtgodbe",
                                           "body":  "@anurse thanks for the report! I\u0027m investigating this now",
                                           "updatedAt":  "2022-09-06T20:00:02Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J46xF",
                                           "createdAt":  "2022-09-07T17:05:57Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "wtgodbe",
                                           "body":  "It turns out this repros on _any_ version-to-version upgrade (3.1 to 5.0, 5.0 to 6.0, 6.0 to 7.0) - if you protect with one version of .Net, you can\u0027t unprotect with another. Maybe it\u0027s expected? CC @GrabYourPitchforks - it could be because part of the protected string is ContentRoot, which by default is the output path of the app, which includes the TFM (e.g. `\"C:\\\\code\\\\dataprotection\\\\dataprotection-repro-7\\\\ReproApp\\\\bin\\\\Debug\\\\net7.0\\\\\"`)",
                                           "updatedAt":  "2022-09-07T17:05:57Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J5ESU",
                                           "createdAt":  "2022-09-07T17:46:47Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "GrabYourPitchforks",
                                           "body":  "Answered this in an email thread, but the app discriminator should be stable across app upgrades. If it includes the TFM, that would explain the behavior we\u0027re seeing.\r\n\r\nIf you trace the history and unit tests for the DataProtection component, you\u0027ll find that it traditionally has used stable strings like the IIS virtual directory as the app discriminator. I don\u0027t know why the application directory is being passed in here.",
                                           "updatedAt":  "2022-09-07T17:46:47Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J5Hd7",
                                           "createdAt":  "2022-09-07T18:01:19Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "wtgodbe",
                                           "body":  "It looks like `HostingApplicationDiscriminator` has been using ContentRoot since at least 2.1:\r\n\r\nhttps://github.com/dotnet/aspnetcore/blob/fd6923ccfef2c37553510d968f6daadfb83eedba/src/DataProtection/DataProtection/src/Internal/HostingApplicationDiscriminator.cs#L23\r\n\r\nWhich is used by the ServiceCollectionExtensions for DataProtection (What Andrew is using in their app): \r\n\r\nhttps://github.com/dotnet/aspnetcore/blob/fd6923ccfef2c37553510d968f6daadfb83eedba/src/DataProtection/DataProtection/src/DataProtectionServiceCollectionExtensions.cs#L79\r\n\r\nWhereas the the Builder extension method has traditionally used the app name:\r\n\r\nhttps://github.com/dotnet/aspnetcore/blob/fd6923ccfef2c37553510d968f6daadfb83eedba/src/DataProtection/DataProtection/src/DataProtectionBuilderExtensions.cs#L47",
                                           "updatedAt":  "2022-09-07T18:01:19Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J5fZF",
                                           "createdAt":  "2022-09-07T19:51:56Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "Tratcher",
                                           "body":  "The TFM is only in the ContentRoot for an un-published app (e.g. dotnet run). A published app shouldn\u0027t discriminate by the TFM. I think that would explain your sample, but there might be a second underlying issue.\r\n\r\nContentRoot is used as the discriminator so you can run multiple instances of a site and keep them separate. We shouldn\u0027t change that.",
                                           "updatedAt":  "2022-09-07T19:54:06Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J5m7c",
                                           "createdAt":  "2022-09-07T20:28:54Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "wtgodbe",
                                           "body":  "I just confirmed this works (5.0 -\u003e 6.0 \u0026 6.0 -\u003e 7.0) if the app has been `dotnet published` first, but not if you\u0027re just running `dotnet run` - so I don\u0027t think we\u0027ll be breaking customers in production. @anurse were you testing this w/ just `dotnet run`? In that scenario ContentRoot will have the TFM string in it, which explains the behavior.",
                                           "updatedAt":  "2022-09-07T20:28:54Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J54NP",
                                           "createdAt":  "2022-09-07T21:27:48Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "analogrelay",
                                           "body":  "I was running the repro app with `dotnet run`, and I was testing our app via launching it in Rider. I expect that runs from the build output, which includes the TFM in it.\r\n\r\nThe fact that the ContentRoot is the app discriminator indicates a bigger problem in using Data Protection for \"durable\" storage of protected values, since we are currently in the process of changing how we deploy our production app and will likely change the ContentRoot as a result.\r\n\r\nIt feels surprising that the path on which the app was deployed is used as part of the encryption since that\u0027s definitely not guaranteed to be stable over the lifetime of an app. Consider the case where the app is moved to a different deployment model (for example, from App Service to Docker) and suddenly all the previously-encrypted values are lost.\r\n\r\nTo solve the immediate problem, we can specify an explicit `ApplicationDiscriminator` (likely just using the old ContentRoot-based value explicitly for now). It just feels like a surprising behavior to me that moving my app to a different directory would break it\u0027s access to all encrypted payloads. Perhaps a model more like User Secrets would be more stable, where the project file specifies a \"DataProtectionAppDiscriminator\" property that\u0027s generated once when the project is created and should remain stable unless explicitly changed.",
                                           "updatedAt":  "2022-09-07T21:33:28Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J55oF",
                                           "createdAt":  "2022-09-07T21:33:24Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "brockallen",
                                           "body":  "\u003e It feels surprising that the path on which the app was deployed is used as part of the encryption since that\u0027s definitely not guaranteed to be stable over the lifetime of an app. Consider the case where the app is moved to a different deployment model (for example, from App Service to Docker) and suddenly all the previously-encrypted values are lost.\r\n\r\nThis is one of the biggest support problems we have for customers. The ultimate solution is that they need to explicitly configure things, because the ambient values to make it F5 experience work well don\u0027t work all that well in practice. I get the rational for it all, so not a criticism -- it\u0027s just that data protection is an afterthought, and the fact that it\u0027s not more in the forefront of developers\u0027 mind is unfortunate. Education here is important. ",
                                           "updatedAt":  "2022-09-07T21:33:24Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J6Bzd",
                                           "createdAt":  "2022-09-07T21:59:43Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "analogrelay",
                                           "body":  "\u003e It looks like `HostingApplicationDiscriminator` has been using ContentRoot since at least 2.1:\r\n\r\nIt\u0027s also notable that the 7.0 version is doing normalization of the trailing slash that wasn\u0027t being done before. The 6.0 version is:\r\n\r\nhttps://github.com/dotnet/aspnetcore/blob/6a01dd1e69c8b9bd1ae005ea465ef2bcd26294bf/src/DataProtection/DataProtection/src/Internal/HostingApplicationDiscriminator.cs#L23\r\n\r\nWhereas the version in main is:\r\n\r\nhttps://github.com/dotnet/aspnetcore/blob/e40c0fd4c87f82de4b685d050df542a52d4fa816/src/DataProtection/DataProtection/src/Internal/HostingApplicationDiscriminator.cs#L30-L43\r\n\r\nOn my macOS machine, when launching from Rider, the ContentRoot is:\r\n\r\n```\r\n/Users/anurse/code/aseriousbiz/abbot/src/product/Abbot.Web\r\n```\r\n\r\nThis is the same in both .NET 6.0 and .NET 7.0, but because of the normalization, the .NET 7.0 version ends up putting a trailing slash on the end:\r\n\r\n```\r\n/Users/anurse/code/aseriousbiz/abbot/src/product/Abbot.Web/\r\n```\r\n\r\nI don\u0027t _think_ `dotnet publish` has an impact on the trailing slashes in ContentRootPath, so it seems from that like there is still a risk of breaking things in production.",
                                           "updatedAt":  "2022-09-07T21:59:43Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J6CK8",
                                           "createdAt":  "2022-09-07T22:01:34Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "analogrelay",
                                           "body":  "I _can_ confirm that setting `ApplicationDiscriminator` to `hostEnvironment.ContentRootPath` _directly_, with **no** normalization (rather than using the `IApplicationDiscriminator`) solved the problem in local development for our app.",
                                           "updatedAt":  "2022-09-07T22:01:34Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J6HWG",
                                           "createdAt":  "2022-09-07T22:27:50Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "wtgodbe",
                                           "body":  "\u003e  I can confirm that setting ApplicationDiscriminator to hostEnvironment.ContentRootPath directly, with no normalization (rather than using the IApplicationDiscriminator) solved the problem in local development for our app.\r\n\r\nCan you elaborate on what you did here? I\u0027d be surprised if a development build worked at all when using version N to protect and N+1 to unprotect, given that ContentRoot will have the TFM in it whether we normalize or not",
                                           "updatedAt":  "2022-09-07T22:27:58Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J6KoF",
                                           "createdAt":  "2022-09-07T22:48:47Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "analogrelay",
                                           "body":  "Rider (and I believe Visual Studio) don\u0027t launch out of the build directory, they launch with the Project Directory as the Current Working Directory (which is what ContentRoot is derived from). I _believe_ `dotnet run` does that as well, at least for web apps?",
                                           "updatedAt":  "2022-09-07T22:48:47Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J6LIb",
                                           "createdAt":  "2022-09-07T22:52:13Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "wtgodbe",
                                           "body":  "\u003e Rider (and I believe Visual Studio) don\u0027t launch out of the build directory, they launch with the Project Directory as the Current Working Directory (which is what ContentRoot is derived from). I believe dotnet run does that as well, at least for web apps?\r\n\r\nI was able to confirm with your repro app that `dotnet run` _does_ get different ContentRoots per TFM:\r\n\r\n`\"C:\\\\code\\\\dataprotection\\\\dataprotection-repro-7\\\\ReproApp\\\\bin\\\\Debug\\\\net6.0\\\\\"\r\n \"C:\\\\code\\\\dataprotection\\\\dataprotection-repro-7\\\\ReproApp\\\\bin\\\\Debug\\\\net7.0\\\\\"`\r\n\r\nIf Rider doesn\u0027t do that, and still breaks on upgrade from 6 to 7, then it sounds like we have 2 issues - a discussion on whether we should stop using ContentRoot at all, and a difference in the default `Discriminator` between 6 and 7 (which would definitely be a bug). Would you be able to confirm what you get from `IApplicationDiscriminator` thru rider between 6 and 7?",
                                           "updatedAt":  "2022-09-07T22:52:36Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J6Le5",
                                           "createdAt":  "2022-09-07T22:54:47Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "analogrelay",
                                           "body":  "Yep, I can do a little more digging there.",
                                           "updatedAt":  "2022-09-07T22:54:47Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J6MTf",
                                           "createdAt":  "2022-09-07T23:01:26Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "analogrelay",
                                           "body":  "My repro app was, admittedly, oversimplified (now that we know the issue is related to the ContentRootPath). The app I\u0027m having difficulty with is a Web App, so let\u0027s use one of those. I created a new Web App and `dotnet run`ed it and got the following output:\r\n\r\n```\r\ninfo: Microsoft.Hosting.Lifetime[0]\r\n      Content root path: /Users/anurse/code/anurse/dataprotection-repro/WebApp\r\n```\r\n\r\nThe Content Root path has no TFM information in it.",
                                           "updatedAt":  "2022-09-07T23:01:26Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J6QmP",
                                           "createdAt":  "2022-09-07T23:15:00Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "analogrelay",
                                           "body":  "I did notice something. Our app is still using `WebHost.CreateDefaultBuilder`, rather than the newer \"minimal\" Program.cs format. If I convert my example Web App to do that, and emit the IApplicationDiscriminator.Discriminator value during startup, this is what I see:\r\n\r\n```\r\n❯ dotnet run --project ./WebApp --framework net6.0\r\nBuilding...\r\nApp Discriminator: /Users/anurse/code/anurse/dataprotection-repro/WebApp\r\nHosting environment: Development\r\nContent root path: /Users/anurse/code/anurse/dataprotection-repro/WebApp\r\nNow listening on: http://localhost:5255\r\nApplication started. Press Ctrl+C to shut down.\r\nApplication is shutting down...\r\n\r\n❯ dotnet run --project ./WebApp --framework net7.0\r\nBuilding...\r\nApp Discriminator: /Users/anurse/code/anurse/dataprotection-repro/WebApp/\r\nHosting environment: Development\r\nContent root path: /Users/anurse/code/anurse/dataprotection-repro/WebApp\r\nNow listening on: http://localhost:5255\r\nApplication started. Press Ctrl+C to shut down.\r\nApplication is shutting down...\r\n```\r\n\r\nI\u0027ve pushed the repro with the `WebApp` to the repository.",
                                           "updatedAt":  "2022-09-07T23:15:00Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J6UFB",
                                           "createdAt":  "2022-09-07T23:39:20Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "Tratcher",
                                           "body":  "This would be @halter73\u0027s normalizations. We broke this by mistake between 5 and 6 and were trying to re-unify.",
                                           "updatedAt":  "2022-09-07T23:39:20Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J-AG_",
                                           "createdAt":  "2022-09-08T17:09:59Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOCr6qiA==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "halter73",
                                                                               "createdAt":  "2022-09-08T17:37:18Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "analogrelay",
                                                                               "createdAt":  "2022-09-08T18:23:43Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  2
                                                         },
                                           "author":  "wtgodbe",
                                           "body":  "Ok, yes, this looks like https://github.com/dotnet/aspnetcore/issues/40964 + https://github.com/dotnet/aspnetcore/pull/41849. We changed ContentRoot between 5 and 6 and then again between 6 and 7 to try to \"fix\" the 5 -\u003e 6 change. We had to choose between breaking people using HostBuilder and people using WebApplicationBuilder, and we chose the latter. It\u0027s an unfortunate situation - if we\u0027re right that this is the issue, the workaround would be to manually set your Discriminator to be the same as it was in 6 when you upgrade your app to 7. We should communicate this very loudly for 7 - @halter73 @blowdart where is the right place to do that?\r\n\r\n(Of course, I\u0027ll play with the repro app to confirm this suspicion, but all signs are currently pointing towards it)",
                                           "updatedAt":  "2022-09-08T17:09:59Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85J-TR-",
                                           "createdAt":  "2022-09-08T18:18:42Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "analogrelay",
                                           "body":  "\u003e the workaround would be to manually set your Discriminator to be the same as it was in 6 when you upgrade your app to 7\r\n\r\nThat\u0027s our plan for now. Eventually we\u0027ll switch over to a fixed Application Discriminator as well. It would, perhaps, be good to consider how to improve this experience in .NET 8 and beyond. Using Content Root Path is brittle even without issues like this, since moving the app to be hosted at a different path would silently break all encrypted payloads.\r\n\r\nIt seems to me that there might be a need for a kind of universal \"Application Name\" identifier of some kind, generated into the csproj on `dotnet new` (much like how User Secret IDs work today).\r\n\r\nAnyway, thanks for all the investigative work here. We have a solution that will allow us to upgrade safely now!",
                                           "updatedAt":  "2022-09-08T18:18:42Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85N9JP8",
                                           "createdAt":  "2022-11-08T21:51:16Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "wtgodbe",
                                           "body":  "TODO - come up with plan for .net 8",
                                           "updatedAt":  "2022-11-08T21:51:16Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85OWkZN",
                                           "createdAt":  "2022-11-14T23:22:49Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "blowdart",
                                           "body":  "Add it to the aka.ms page for the errors? Also very clearly in the docs in lots of places.",
                                           "updatedAt":  "2022-11-14T23:22:49Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85O--L9",
                                           "createdAt":  "2022-11-23T14:11:42Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOC9oNVA==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "F2",
                                                                               "createdAt":  "2023-06-10T12:07:46Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "frabe1579",
                                           "body":  "Same killing problem here, my app now has a `/` at the end of `ApplicationDiscriminator`.\r\nSolved, for now, with this:\r\n```\r\n      services.PostConfigure\u003cDataProtectionOptions\u003e(p =\u003e {\r\n        if (p.ApplicationDiscriminator != null \u0026\u0026 (p.ApplicationDiscriminator.EndsWith(\"/\") || p.ApplicationDiscriminator.EndsWith(\"\\\\\")))\r\n          p.ApplicationDiscriminator = p.ApplicationDiscriminator[..^1];\r\n      });\r\n```",
                                           "updatedAt":  "2022-11-23T14:11:42Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85Q_1DR",
                                           "createdAt":  "2022-12-20T06:46:33Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHODEaoBw==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "frabe1579",
                                                                               "createdAt":  "2022-12-20T15:15:05Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "shaunbowe",
                                                                               "createdAt":  "2023-01-27T17:28:43Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "tbalasavage",
                                                                               "createdAt":  "2023-07-20T19:06:22Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "GuidoNeele",
                                                                               "createdAt":  "2023-08-22T14:22:02Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  4
                                                         },
                                           "author":  "altenstedt",
                                           "body":  "Just to comment on the code from @frabe1579  above for future readers, Microsoft documents a slightly different approach:\r\n\r\n```\r\nvar trimmedContentRootPath = Environment.ContentRootPath.TrimEnd(Path.DirectorySeparatorChar);\r\n\r\nservices.AddDataProtection()\r\n    .SetApplicationName(trimmedContentRootPath)\r\n    ...\r\n```\r\n\r\nIt is documented in the \"Warning\" section here:\r\n\r\nhttps://learn.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview?tabs=aspnetcore2x\u0026view=aspnetcore-7.0#setapplicationname\r\n\r\n",
                                           "updatedAt":  "2022-12-20T06:46:33Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85bEEMF",
                                           "createdAt":  "2023-04-28T16:16:14Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "wldevries",
                                           "body":  "I have the exact same issue when using `ProtectedLocalStorage.GetAsync`. If the data was stored using .NET 6.0 the call will fail after updating to .NET 7.0 with a `CryptographicException` similar to the OP.",
                                           "updatedAt":  "2023-04-28T16:16:14Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85pMvNv",
                                           "createdAt":  "2023-10-16T17:30:01Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "We\u0027ve moved this issue to the Backlog milestone. This means that it is not going to be worked on for the coming release. We will reassess the backlog following the current release and consider this item at that time. To learn more about our issue management process and to have better expectation regarding different types of issues you can read our [Triage Process](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2023-10-16T17:30:01Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86ikGC1",
                                           "createdAt":  "2025-03-16T12:31:48Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "dazinator",
                                           "body":  "Why was there no breaking change recorded for this? I was just upgrading from dotnet 6 to dotnet 8 and data protection broke. Can\u0027t see anything listed here: https://learn.microsoft.com/en-us/dotnet/core/compatibility/8.0",
                                           "updatedAt":  "2025-03-16T12:32:20Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86iqLAc",
                                           "createdAt":  "2025-03-17T10:22:13Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "frabe1579",
                                           "body":  "@dazinator This is not a breaking change, the behavior depends on a multitude of factors, all together defining application path, which is used by default as discriminator.\nDocumentation: https://learn.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview?view=aspnetcore-8.0",
                                           "updatedAt":  "2025-03-17T10:22:13Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86iqoNi",
                                           "createdAt":  "2025-03-17T11:04:07Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "dazinator",
                                           "body":  "@frabe1579 I was upgrading my application from dotnet 6 to dotnet 8, and this behavioural change (somewhere) resulted in a breakage of data protection payloads... So at some level, there is a breaking change no? Even if its to do with how the host formulates this default descriminator and not within the data protection library itself - thats still a behaviour change that causes a potential breakage. When I am upgrading from dotnet 6 to dotnet 8, I carefully review all of the breaking changes and look for guides to help me understand the factors involved when upgrading.. This seems to be one you are aware of, but isn\u0027t mentioned anywhere where it would be useful or helpful. A developer considering upgrading from dotnet 6 to 8 is highly unlikely to read every single individual library page to parse for potential issues in the form of a warning somewhere. Its more likely they just want a consolidated list of braking changes that they need to consider - with guidance on how to address them no?",
                                           "updatedAt":  "2025-03-17T11:04:32Z"
                                       }
                                   ],
                         "totalCount":  30
                     },
        "title":  "On upgrade to .NET 7, Data Protection throws \"Payload was invalid\" error when unprotecting values from .NET 6",
        "labels":  [
                       "area-dataprotection"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/44758",
        "createdAt":  "2022-10-27T07:07:20Z",
        "number":  44758,
        "author":  "KLuuKer",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHOC9yOBg==",
                          "nodes":  [
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "BrennanConroy",
                                            "createdAt":  "2022-10-27T17:06:48Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "agertenbach",
                                            "createdAt":  "2022-11-11T14:41:07Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "KevinH-MS",
                                            "createdAt":  "2023-05-18T02:22:33Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "0xfeeddeadbeef",
                                            "createdAt":  "2023-09-01T20:45:06Z"
                                        },
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "k-wojcik",
                                            "createdAt":  "2024-12-30T13:00:34Z"
                                        }
                                    ],
                          "totalCount":  5
                      },
        "updatedAt":  "2025-06-30T12:04:05Z",
        "body":  "## Background and Motivation\r\n\r\nAdd `ReadOnlySpan\u003cbyte\u003e` overrides so consumer apps are able to avoid a extra array allocation+blockbuffer.copy every time they try to protect\\unprotect data.\r\n\r\n## Proposed API\r\n\r\n```diff\r\nnamespace Microsoft.AspNetCore.DataProtection;\r\n\r\npublic interface IDataProtector : IDataProtectionProvider\r\n{\r\n+    byte[] Protect(ReadOnlySpan\u003cbyte\u003e plaintext);\r\n\r\n+    byte[] Unprotect(ReadOnlySpan\u003cbyte\u003e protectedData);\r\n}\r\n```\r\n\r\n## Usage Examples\r\n\r\n```csharp\r\nvar buffer = new ArrayBufferWriter\u003cbyte\u003e();\r\n\r\n// write some data to buffer\r\nvar blob = new Data { Some = \"Payload\" };\r\nMessagePackSerializer.Serialize(buffer, blob);\r\n\r\nIDataProtector protector = provider.CreateProtector(\"demo\");\r\nreturn protector.Protect(buffer.WrittenSpan);\r\n```\r\n\r\n## Alternative Designs\r\n\r\n```diff\r\nnamespace Microsoft.AspNetCore.DataProtection;\r\n\r\npublic interface IDataProtector : IDataProtectionProvider\r\n{\r\n+    byte[] Protect(ReadOnlySpan\u003cbyte\u003e plaintext) =\u003e this.Protect(plaintext.ToArray())\r\n\r\n+    byte[] Unprotect(ReadOnlySpan\u003cbyte\u003e protectedData) =\u003e this.Unprotect(protectedData.ToArray())\r\n}\r\n```\r\n\r\n## Risks\r\n\r\nAll of the existing protector implementations have to be changed to implement this change.\r\nWe could also have a default interface implementation to prevent it breaking to aggressively.\r\n\r\nPerformance impact should be minimal, and actually open the possibility for apps to avoid a unnecessary array copy, if people use the api correctly\r\n",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOr3LroA==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde85NVbFR",
                                           "createdAt":  "2022-10-31T17:56:33Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "halter73",
                                           "body":  "@KLuuKer We\u0027re interested in learning more about your use case. Do you plan to use it with `MessagePackSerializer`? Anything else? This seems potentially useful if you need to slice byte arrays. Perhaps we could use this internally if/when we\u0027re using array pools.\r\n\r\nNote: We\u0027d have to ifdef the new API out of netstandard unless we make a whole new interface because netstandard does not support default interface methods, and we cannot make breaking changes to this interface.",
                                           "updatedAt":  "2022-10-31T17:56:33Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85NvANB",
                                           "createdAt":  "2022-11-04T20:19:40Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "Thanks for contacting us.\n\nWe\u0027re moving this issue to the `.NET 8 Planning` milestone for future evaluation / consideration. We would like to keep this around to collect more feedback, which can help us with prioritizing this work. We will re-evaluate this issue, during our next planning meeting(s). \nIf we later determine, that the issue has no community involvement, or it\u0027s very rare and low-impact issue, we will close it - so that the team can focus on more important and high impact issues.\nTo learn more about what to expect next and how this issue will be handled you can read more about our triage process [here](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2022-11-04T20:19:40Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85NvBDq",
                                           "createdAt":  "2022-11-04T20:21:18Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOCvRpow==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "KLuuKer",
                                                                               "createdAt":  "2022-11-09T07:44:03Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "adityamandaleeka",
                                           "body":  "Triage: optimizing this is likely going to help in some hot paths. We believe the API needs some design work though.\r\n\r\nNote: We\u0027ll need to make sure netstandard2.0 works.",
                                           "updatedAt":  "2022-11-04T20:21:18Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85N-w-G",
                                           "createdAt":  "2022-11-09T07:00:12Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "KLuuKer",
                                           "body":  "@halter73 yes I do use it with `MessagePackSerializer` (now with a extra array copy unfortunately), but I do write my own payloads first to the buffer before I read\\write to it with messagepack (like version\\compatibility flags etc).\r\n\r\nSometimes I also end up writing custom byte\u0027s rented from a `ArrayPool` that ends up returning a slightly larger buffer then my actual payload, and apparently I also use `WebEncoders.Base64UrlEncode` (decode) allot.\r\n\r\nCan\u0027t wait until net8.0 so I can start using it :shipit: \r\np.s. anybody have a working time machine handy?",
                                           "updatedAt":  "2022-11-09T07:00:12Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85OKZPn",
                                           "createdAt":  "2022-11-11T07:48:10Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHODwLfpA==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "0xfeeddeadbeef",
                                                                               "createdAt":  "2023-09-01T20:45:49Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "polewskm",
                                                                               "createdAt":  "2024-04-12T20:29:23Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "stevejgordon",
                                                                               "createdAt":  "2024-08-29T10:24:49Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  3
                                                         },
                                           "author":  "KLuuKer",
                                           "body":  "Maybe something like a `TryProtect` \\ `TryUnprotect` and people can input their own source and destination span\u0027s.\r\nI understand the potential ways \"normal\" developers might be able to shoot themselves in the foot with it, if they actually put secret data back into the buffer pool before sanitizing the bytes first.",
                                           "updatedAt":  "2022-11-11T07:48:10Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85chnmA",
                                           "createdAt":  "2023-05-18T02:21:53Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHODP0jiQ==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "0xfeeddeadbeef",
                                                                               "createdAt":  "2023-12-16T16:33:09Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "KevinH-MS",
                                           "body":  "My team\u0027s services would benefit from this API as well. Our scenario involves StackExchange.Redis, where the values we want to encrypt are of type `RedisValue` (which can be implicit converted to `ReadOnlyMemory\u003cbyte\u003e`).\r\n\r\nhttps://github.com/StackExchange/StackExchange.Redis/blob/ae6419a164600b4b54dd7ce8a699efe8e98d8f1c/src/StackExchange.Redis/RedisValue.cs#L855\r\n\r\nI *think* it would be sufficient for us to call `ReadOnlyMemory\u003cbyte\u003e.Span` if an overload that accepted `ReadOnlySpan\u003cbyte\u003e` was provided. Initially, I thought it would be nice if `IDataProtector` provided a method that accepted `ReadOnlyMemory\u003cbyte\u003e`, but if it did, I think it\u0027d need to call `.Span` internally to iterate/consume the contents of the array it\u0027s pointing at anyway, right?",
                                           "updatedAt":  "2023-05-18T14:00:43Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85cmx_I",
                                           "createdAt":  "2023-05-18T21:29:58Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHODP0jkQ==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "KLuuKer",
                                                                               "createdAt":  "2023-05-19T10:46:14Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "0xfeeddeadbeef",
                                                                               "createdAt":  "2023-12-16T16:33:28Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  2
                                                         },
                                           "author":  "amcasey",
                                           "body":  "To get the perf win, we\u0027d have to avoid allocating the array in the API implementation as well, so we\u0027d probably need/want to update these too:\r\n```\r\nMicrosoft.AspNetCore.DataProtection.AuthenticatedEncryption.IAuthenticatedEncryptor.Decrypt(System.ArraySegment\u003cbyte\u003e ciphertext, System.ArraySegment\u003cbyte\u003e additionalAuthenticatedData) -\u003e byte[]!\r\nMicrosoft.AspNetCore.DataProtection.AuthenticatedEncryption.IAuthenticatedEncryptor.Encrypt(System.ArraySegment\u003cbyte\u003e plaintext, System.ArraySegment\u003cbyte\u003e additionalAuthenticatedData) -\u003e byte[]!\r\nMicrosoft.AspNetCore.DataProtection.ISecret.WriteSecretIntoBuffer(System.ArraySegment\u003cbyte\u003e buffer) -\u003e void\r\nMicrosoft.AspNetCore.DataProtection.Secret.Secret(System.ArraySegment\u003cbyte\u003e value) -\u003e void\r\nMicrosoft.AspNetCore.DataProtection.Secret.WriteSecretIntoBuffer(System.ArraySegment\u003cbyte\u003e buffer) -\u003e void\r\n```\r\n\r\nAnd probably these, if only for consistency:\r\n```\r\nstatic Microsoft.AspNetCore.Cryptography.KeyDerivation.KeyDerivation.Pbkdf2(string! password, byte[]! salt, Microsoft.AspNetCore.Cryptography.KeyDerivation.KeyDerivationPrf prf, int iterationCount, int numBytesRequested) -\u003e byte[]!\r\nMicrosoft.AspNetCore.DataProtection.IPersistedDataProtector.DangerousUnprotect(byte[]! protectedData, bool ignoreRevocationErrors, out bool requiresMigration, out bool wasRevoked) -\u003e byte[]!\r\nMicrosoft.AspNetCore.DataProtection.Secret.Secret(byte[]! value) -\u003e void\r\nMicrosoft.AspNetCore.DataProtection.ITimeLimitedDataProtector.Protect(byte[]! plaintext, System.DateTimeOffset expiration) -\u003e byte[]!\r\nMicrosoft.AspNetCore.DataProtection.ITimeLimitedDataProtector.Unprotect(byte[]! protectedData, out System.DateTimeOffset expiration) -\u003e byte[]!\r\nstatic Microsoft.AspNetCore.DataProtection.DataProtectionAdvancedExtensions.Protect(this Microsoft.AspNetCore.DataProtection.ITimeLimitedDataProtector! protector, byte[]! plaintext, System.TimeSpan lifetime) -\u003e byte[]!\r\n```",
                                           "updatedAt":  "2023-05-18T21:29:58Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85xrHlP",
                                           "createdAt":  "2024-01-24T00:12:49Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHODT3akA==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "0xfeeddeadbeef",
                                                                               "createdAt":  "2024-01-24T07:46:42Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "amcasey",
                                           "body":  "This is a pretty big change, but we\u0027ll give it further consideration in 9.0.",
                                           "updatedAt":  "2024-01-24T00:12:49Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86KHqnA",
                                           "createdAt":  "2024-08-29T10:27:39Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOD53oxw==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "HEART",
                                                                               "user":  "KLuuKer",
                                                                               "createdAt":  "2024-11-07T16:20:55Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "stevejgordon",
                                           "body":  "Just weighing in to support this proposal. Right now I am writing some serialised data to a cookie which I\u0027d like to protect. While I can do much of the serialisation without allocating by using rented arrays and spans, etc., as soon as I need to protect that data, I\u0027m forced to allocate the `byte[]`. I\u0027d second @KLuuKer\u0027s idea of having this via `TryXyz` methods so the destination span can also be passed in.",
                                           "updatedAt":  "2024-08-29T10:27:39Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86sfeu7",
                                           "createdAt":  "2025-05-20T11:05:53Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "DeagleGross",
                                           "body":  "I am working on [Antiforgery improvements](https://github.com/dotnet/aspnetcore/issues/50065) and it uses `IDataProtector` under the hood:\nhttps://github.com/dotnet/aspnetcore/blob/08cff58bd5774b29573fcdc40ee6fbe79251fef1/src/Antiforgery/src/Internal/DefaultAntiforgeryTokenSerializer.cs#L46\n\nWe can improve there only if we make a change in DataProtection layer: so far for example validation scenario in Antiforgery cant be impacted due to `Protect` and `Unprotect` receiving and returning a byte array.\n\n## Proposal\nI reviewed all the new APIs we have to expose and here they are:\n```diff\nnamespace Microsoft.AspNetCore.DataProtection;\n\npublic interface IDataProtector : IDataProtectionProvider\n{\n+    bool TryProtect(ReadOnlySpan\u003cbyte\u003e plainText, Span\u003cbyte\u003e destination, out int bytesWritten);\n+    bool TryUnprotect(ReadOnlySpan\u003cbyte\u003e protectedData, Span\u003cbyte\u003e destination, out int bytesWritten);\n}\n```\n\n`IDataProtector` calls `IAuthenticatedEncryptor` internally, therefore:\n```diff\nnamespace Microsoft.AspNetCore.DataProtection.AuthenticatedEncryption;\n\npublic interface IAuthenticatedEncryptor\n{\n+    bool TryDecrypt(ReadOnlySpan\u003cbyte\u003e cipherText, ReadOnlySpan\u003cbyte\u003e additionalAuthenticatedData, Span\u003cbyte\u003e destination, out int bytesWritten);\n+    bool TryEncrypt(ReadOnlySpan\u003cbyte\u003e plaintText, ReadOnlySpan\u003cbyte\u003e additionalAuthenticatedData, Span\u003cbyte\u003e destination, out int bytesWritten);\n}\n```\n\n## Other APIs\nI reviewed proposition by @amcasey and I think those can be left for now (`ArraySegment\u003cbyte\u003e` is somewhat similar to `Span\u003cbyte\u003e` and we can get perf improvement without changing those to `Span\u003cbyte\u003e` explicitly. For example we managed to squeeze perf in `byte[]` overloads without changing `ArraySegment\u003cbyte\u003e`:\nhttps://github.com/dotnet/aspnetcore/blob/08cff58bd5774b29573fcdc40ee6fbe79251fef1/src/DataProtection/DataProtection/src/Managed/ManagedAuthenticatedEncryptor.cs#L194\n\n\u003e - Microsoft.AspNetCore.DataProtection.ISecret.WriteSecretIntoBuffer(System.ArraySegment\u003cbyte\u003e buffer) -\u003e void\n\u003e - Microsoft.AspNetCore.DataProtection.Secret.Secret(System.ArraySegment\u003cbyte\u003e value) -\u003e void\n\u003e - Microsoft.AspNetCore.DataProtection.Secret.WriteSecretIntoBuffer(System.ArraySegment\u003cbyte\u003e buffer) -\u003e void\n\nthese ones should be also recreated with `Span` overload for consistency, but personally we can do that in waves / per request probably?\n\u003e - static Microsoft.AspNetCore.Cryptography.KeyDerivation.KeyDerivation.Pbkdf2(string! password, byte[]! salt, Microsoft.AspNetCore.Cryptography.KeyDerivation.KeyDerivationPrf prf, int iterationCount, int numBytesRequested) -\u003e byte[]!\n\u003e - static Microsoft.AspNetCore.DataProtection.DataProtectionAdvancedExtensions.Protect(this Microsoft.AspNetCore.DataProtection.ITimeLimitedDataProtector! protector, byte[]! plaintext, System.TimeSpan lifetime) -\u003e byte[]!\n\nthere are also other types of `IDataProtector`, but again - can come later per request, because implementing so many new API methods will result in a **huge** PR. \n\u003e - Microsoft.AspNetCore.DataProtection.ITimeLimitedDataProtector.Protect(byte[]! plaintext, System.DateTimeOffset expiration) -\u003e byte[]!\n\u003e - Microsoft.AspNetCore.DataProtection.ITimeLimitedDataProtector.Unprotect(byte[]! protectedData, out System.DateTimeOffset expiration) -\u003e byte[]!\n\u003e - Microsoft.AspNetCore.DataProtection.IPersistedDataProtector.DangerousUnprotect(byte[]! protectedData, bool ignoreRevocationErrors, out bool requiresMigration, out bool wasRevoked) -\u003e byte[]!\n\n",
                                           "updatedAt":  "2025-05-20T11:05:53Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86sspnJ",
                                           "createdAt":  "2025-05-21T10:07:40Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "dotnet-policy-service",
                                           "body":  "Thank you for submitting this for API review. This will be reviewed by @dotnet/aspnet-api-review at the next meeting of the ASP.NET Core API Review group. Please ensure you take a look at [the API review process documentation](https://github.com/dotnet/aspnetcore/blob/main/docs/APIReviewProcess.md) and ensure that:\n\n* The PR contains changes to the reference-assembly that describe the API change. **Or**, you have included a snippet of reference-assembly-style code that illustrates the API change.\n* The PR describes the impact to users, both positive (useful new APIs) and negative (breaking changes).\n* Someone is assigned to \"champion\" this change in the meeting, and they understand the impact and design of the change.\n\u003c!-- Policy app identification https://img.shields.io/static/v1?label=PullRequestIssueManagement. --\u003e",
                                           "updatedAt":  "2025-05-21T10:07:40Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86sxeYe",
                                           "createdAt":  "2025-05-21T17:05:19Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOEUNUKA==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "KLuuKer",
                                                                               "createdAt":  "2025-05-29T03:29:42Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "DeagleGross",
                                           "body":  "concerns from @BrennanConroy: \n1) adding members to interface is a breaking change and especially for netstandard due to default interface implementations, so cover with `#if NETCOREAPP` for sure\n2) default implementation should exist to call `Protect` from `TryProtect` due to possible user custom implementation which we would call eventually (to not break user)",
                                           "updatedAt":  "2025-05-21T17:05:19Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86uF0vK",
                                           "createdAt":  "2025-05-29T22:54:48Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "halter73",
                                           "body":  "- What scenarios are we trying to improve?\n  - Antiforgery token generation and validation.\n  - Are we introducing DIMs for this?\n    - Yes. For .NET 10, we\u0027ll allocate and call the existing array-based overloads. We\u0027ll #ifdef out for netstandard.\n- Is the bool return sufficient? Should we use the operation status pattern to indicate how large the destination buffer needs to be?\n  - Do these methods only return false if the destination is too small?\n  - Do we need a second out parameter for bytes required? Can we combine these out parameters considering they are mutually exclusive.\n    - No. We looked at IPAddress.TryWrite and BigInteger.TryWrite and they don\u0027t do this.\n    - We also looked at variaous OperationStatus encoder APIs that don\u0027t appear to have multiple out parameters for bytes written.\n- Can we add a `GetProtectedSize(ReadOnlySpan\u003cbyte\u003e plainText)` and `GetUnprotectedSize(ReadOnlySpan\u003cbyte\u003e cypherText)`?\n  - Maybe? This needs investigation.\n  - Would this change the design of anything else? \n\nThis is looking good, but we want to have a better understanding if we need the `GetProtectedSize(ReadOnlySpan\u003cbyte\u003e plainText)` and `GetUnprotectedSize(ReadOnlySpan\u003cbyte\u003e cypherText)` APIs before giving final approval.\n\n```diff\npublic interface IDataProtector : IDataProtectionProvider\n{\n+ #if NET\n+    bool TryProtect(ReadOnlySpan\u003cbyte\u003e plainText, Span\u003cbyte\u003e destination, out int bytesWritten);\n+    bool TryUnprotect(ReadOnlySpan\u003cbyte\u003e protectedData, Span\u003cbyte\u003e destination, out int bytesWritten);\n+ #endif\n}\n\npublic interface IAuthenticatedEncryptor\n{\n+ #if NET\n+    bool TryDecrypt(ReadOnlySpan\u003cbyte\u003e cipherText, ReadOnlySpan\u003cbyte\u003e additionalAuthenticatedData, Span\u003cbyte\u003e destination, out int bytesWritten);\n+    bool TryEncrypt(ReadOnlySpan\u003cbyte\u003e plaintText, ReadOnlySpan\u003cbyte\u003e additionalAuthenticatedData, Span\u003cbyte\u003e destination, out int bytesWritten);\n+ #endif\n}\n```",
                                           "updatedAt":  "2025-05-29T22:54:48Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86vcuug",
                                           "createdAt":  "2025-06-05T10:01:08Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "KLuuKer",
                                           "body":  "@halter73 from my limited knowledge AES GCM is a fixed size input and output\nsame goes for ChaCha20-Poly1305 because padding isn\u0027t needed\n\nthe only variables would be how big the IV\\nonces\\authentication tags would be\nand if for whatever reason (in the future) someone decides to increase\\change the length of the nonces\\auth tags (or even a whole different future algo)\nit would be a breaking change....\n\nin my opinion having something that can calculate the (un)encrypted payload length would be nice\nso people consuming the api wouldn\u0027t have to assume anything about all the extra headers data protection adds\\removes to the payload\n",
                                           "updatedAt":  "2025-06-05T10:01:08Z"
                                       }
                                   ],
                         "totalCount":  14
                     },
        "title":  "API proposal: Add ReadOnlySpan\u003cbyte\u003e to IDataProtector (un)Protect ",
        "labels":  [
                       "area-dataprotection",
                       "Perf",
                       "api-needs-work"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/45942",
        "createdAt":  "2023-01-07T17:38:49Z",
        "number":  45942,
        "author":  "joymon",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  null,
                          "nodes":  [

                                    ],
                          "totalCount":  0
                      },
        "updatedAt":  "2024-02-13T01:46:17Z",
        "body":  "\u003c!--\r\nThis template is useful to build consensus about whether work should be done, and if so, the high-level shape of how it should be approached. Use this before fixating on a particular implementation.\r\n--\u003e\r\n\r\n## Summary\r\n\r\nCurrently, it seems the DataProtection settings need to be configured via code. We are looking for support via appsettings.json or in general via configuration without recompiling the application for different deployment environment types.\r\n\r\n## Motivation and goals\r\n\r\nAs developers, we would like to code once and deploy in various environment types by tuning the configuration. Currently, the DataProtection configuration seems to support only via code. Though we can read configuration in a custom way, it would be great if the library provides the configuration options out of box.\r\n\r\n## In scope\r\n\r\nConfigure the DataProtection options from appsettings.json. In code, we will be adding `services.AddDataProtection();`\r\n\r\n## Out of scope\r\n\r\n\r\n\r\n## Risks / unknowns\r\n\r\nHow might developers misinterpret/misuse this? How might implementing it restrict us from other enhancements in the future? Also list any perf/security/correctness concerns.\r\n\r\n## Examples\r\n\r\n`services.AddDataProtection()` - This will be loading the settings from the appsettings.json before defaulting to the values in the code.\r\n\r\nex: By default, the keys are stores at %USERPROFILE%\\AppData\\Local\\ASP.NET\\DataProtection-Keys. To change this folder we have to write code. This path should be configurable via appsettings.json\r\n\r\n\u003c!--\r\n# Detailed design\r\n\r\nIt\u0027s often best not to fill this out until you get basic consensus about the above. When you do, consider adding an implementation proposal with the following headings:\r\n\r\nDetailed design\r\nDrawbacks\r\nConsidered alternatives\r\nOpen questions\r\nReferences\r\n\r\nIf there\u0027s one clear design you have consensus on, you could do that directly in a PR.\r\n--\u003e\r\n",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOcgHobw==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde85R8IBe",
                                           "createdAt":  "2023-01-08T05:47:12Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "davidfowl",
                                           "body":  "Can you provide more details? Are you just trying to change this one thing? Can you show what the code looks like today and what you\u0027d like the setting to express?",
                                           "updatedAt":  "2023-01-08T05:47:12Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85R8p5c",
                                           "createdAt":  "2023-01-08T14:54:08Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "joymon",
                                           "body":  "The current way we are enabling the DataProtection is `services.AddDataProtection()` . When it runs on a desktop, it creates the key file %USERPROFILE%\\AppData\\Local\\ASP.NET\\DataProtection-Keys. When it runs in a load-balanced environment, it still creates files in the same place and fails as other machines has different keys. In load balanced environment, we have to point to a \\\\SharedSMB path. It is possible via `services.AddDataProtection().PersistKeysToFileSystem(new DirectoryInfo(@\"\\\\SMBSharedPath\"));` but it needs code change. We are trying to use only `services.AddDataProtection()` and rest to be configurable from appsettings.json. Hope it clears",
                                           "updatedAt":  "2023-01-08T14:54:08Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85R8t6n",
                                           "createdAt":  "2023-01-08T16:09:48Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "davidfowl",
                                           "body":  "Sure, but you can write this code:\r\n\r\n```C#\r\nvar path = configuration[\"DataProtection:Path\"];\r\nservices.AddDataProtection().PersistKeysToFileSystem(path);\r\n```\r\n\r\nThen the code doesn\u0027t need to change.",
                                           "updatedAt":  "2023-01-08T16:10:18Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85R_3kG",
                                           "createdAt":  "2023-01-09T14:21:38Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "joymon",
                                           "body":  "Hi @davidfowl,\r\nAs mentioned in the original question, we can do the custom way by reading the configuration. But looking for an official / out-of-the-box way to read the config.  Similar to the \"Logging\" section in appsettings.json. Does the DataProtection supports reading the configuration out of the box as of now?",
                                           "updatedAt":  "2023-01-09T14:21:38Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85SA6p_",
                                           "createdAt":  "2023-01-09T17:13:24Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "davidfowl",
                                           "body":  "\u003e  Does the DataProtection supports reading the configuration out of the box as of now?\r\n\r\nNo, it doesn\u0027t. We could add support for this similar to logging yes. A few things that we\u0027d need to design:\r\n- What options can you configure\r\n- How do you get this behavior by default? Is it opt-in or out.\r\n- Is there a new API?",
                                           "updatedAt":  "2023-01-09T17:13:24Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85SJBFb",
                                           "createdAt":  "2023-01-11T00:56:02Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "joymon",
                                           "body":  "Response inline\r\n- What options can you configure _[Joy] We are looking for configuring the location of keys. But if you are designing I would recommend all the settings that can be done via code should be present in configuration_\r\n- How do you get this behavior by default? Is it opt-in or out.  _[Joy] Default behavior is to read from config similar to logging_\r\n- Is there a new API?_[Joy] Not sure what you mean. Not expecting any new .Net class or method. The `services.AddDataProtection()` is expected to read from config_",
                                           "updatedAt":  "2023-01-11T00:56:02Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85STpm3",
                                           "createdAt":  "2023-01-12T19:11:22Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "blowdart",
                                           "body":  "The problem with using config is there is no common config between the providers, unlike the logging example @davidfowl talks about. The file path is unique to the file keyring provider, the key vault location is unique to keyvault etc.\r\n\r\nGiven there\u0027s a way to check environments already that would be the approach I\u0027d take in my program.cs",
                                           "updatedAt":  "2023-01-12T19:11:22Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85SahLL",
                                           "createdAt":  "2023-01-14T07:36:05Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOC0ajIg==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "joymon",
                                                                               "createdAt":  "2023-01-18T20:52:17Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "davidfowl",
                                           "body":  "I think it\u0027s reasonable to provide a way to configure this (answering some of [these questions](https://github.com/dotnet/aspnetcore/issues/45942#issuecomment-1375971967))",
                                           "updatedAt":  "2023-01-14T07:36:05Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85SoIVM",
                                           "createdAt":  "2023-01-17T23:50:31Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "Thanks for contacting us.\n\nWe\u0027re moving this issue to the `.NET 8 Planning` milestone for future evaluation / consideration. We would like to keep this around to collect more feedback, which can help us with prioritizing this work. We will re-evaluate this issue, during our next planning meeting(s). \nIf we later determine, that the issue has no community involvement, or it\u0027s very rare and low-impact issue, we will close it - so that the team can focus on more important and high impact issues.\nTo learn more about what to expect next and how this issue will be handled you can read more about our triage process [here](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2023-01-17T23:50:31Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85TNnAj",
                                           "createdAt":  "2023-01-18T20:56:44Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "joymon",
                                           "body":  "\u003e The problem with using config is there is no common config between the providers, unlike the logging example @davidfowl talks about. The file path is unique to the file keyring provider, the key vault location is unique to keyvault etc.\r\n\u003e \r\n\u003e Given there\u0027s a way to check environments already that would be the approach I\u0027d take in my program.cs\r\n\r\n@blowdart I agree that the settings are different for different providers. Though not exactly the same, the logging also works similarly. If we are logging into the console, no or very fewer options, but if it\u0027s to Azure App Insights, it requires an instrumentation key. I am not able to envision how the JSON should look as I am not aware of all the options. Once I am free from the busy schedule I will put some through. Hope by the time the current team get some time to look at this featue.",
                                           "updatedAt":  "2023-01-18T20:56:44Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85yAehv",
                                           "createdAt":  "2024-01-26T21:35:59Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "We\u0027ve moved this issue to the Backlog milestone. This means that it is not going to be worked on for the coming release. We will reassess the backlog following the current release and consider this item at that time. To learn more about our issue management process and to have better expectation regarding different types of issues you can read our [Triage Process](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2024-01-26T21:35:59Z"
                                       }
                                   ],
                         "totalCount":  11
                     },
        "title":  "Configuring the DataProtection options via appsettings.json file",
        "labels":  [
                       "area-dataprotection",
                       "design-proposal"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/46308",
        "createdAt":  "2023-01-29T11:40:32Z",
        "number":  46308,
        "author":  "dozer75",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  null,
                          "nodes":  [

                                    ],
                          "totalCount":  0
                      },
        "updatedAt":  "2024-02-13T01:44:12Z",
        "body":  "### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Is your feature request related to a problem? Please describe the problem.\n\nI was trying to figure out how `UnprotectKeysWithAnyCertificate` worked, but I did not manage any code without it to fail when trying to unprotect an old secret created by a another certificate than the one provided in `ProtectKeysWithCertificate`.\r\n\r\nWhile trying to figure out why we have a `UnprotectKeysWithAnyCertificate` (which in my point at the time seem quite useless) I wrote the dotnet/AspNetCore.Docs#28213 issue. And after I got answer on that I realized that the problem was the fact that even though I hadn\u0027t referenced any relationships to the Windows user certificate store, the data protection key certificate logic still tries to search the certificate store on Windows operating systems. And if it finds the thumbprint there it uses that which gave me a great amount of wasted time trying to understand the usage of `UnprotectKeysWithAnyCertificate`.\n\n### Describe the solution you\u0027d like\n\nWhile (as the previous mentioned issue states) it can be documented better how the certificate key protection works and how it differs between operating environments, it would be nice if the logic is consistent in the fact that the certificate store isn\u0027t used unless defined to be doing this by the application.\r\n\r\nI can see a couple of different ways that this could be done:\r\n1. By *not* using the windows certificate store if the `ProtectKeysWithCertificate` is used with a `X509Certificate2`, only when a thumbnail is provided.\r\n2. By having a another extension method called something like e.g. `ProtectKeysWithCertificateStore` that takes a thumbnail (and optional a `X509Store` if the user wants to override the store to be used) and let the `ProtectKeysWithCertificate` only accept a `X509Certificate2` and thus not using certificate store at all.\r\n3. Remove (or obsolete) the `ProtectKeysWithCertificate` version that takes a `X509Certificate2` and create an extension method called something like `ProtectKeysWithExplicitCertificate` which make the certificate key protection ignore any certificate stores.\r\n\r\nEither of these ways will (while will be breaking changes except for option 3 with obsoleting the method) make the certificate key protection a bit clearer how they work.\r\n\r\nAlso, note, as mentioned in option 2, it would be nice if you gave us the opportunity to somehow specify a `X509Store` for certificate retrieval.\n\n### Additional context\n\n_No response_",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOcgHpbg==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde85UHWjy",
                                           "createdAt":  "2023-01-31T23:27:42Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOC1cF6w==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "dozer75",
                                                                               "createdAt":  "2023-02-04T09:50:06Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "captainsafia",
                                           "body":  "Triage: Sticking this in .NET 8 Planning for now to evaluate whether this will bubble up as high-pri work in the data protection area.",
                                           "updatedAt":  "2023-01-31T23:27:42Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85yAelu",
                                           "createdAt":  "2024-01-26T21:36:15Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "We\u0027ve moved this issue to the Backlog milestone. This means that it is not going to be worked on for the coming release. We will reassess the backlog following the current release and consider this item at that time. To learn more about our issue management process and to have better expectation regarding different types of issues you can read our [Triage Process](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2024-01-26T21:36:15Z"
                                       }
                                   ],
                         "totalCount":  2
                     },
        "title":  "Stop using Windows user certificate store as default for data protection keys.",
        "labels":  [
                       "enhancement",
                       "area-dataprotection"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/46310",
        "createdAt":  "2023-01-29T12:36:43Z",
        "number":  46310,
        "author":  "dozer75",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHOCvTKCg==",
                          "nodes":  [
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "madelson",
                                            "createdAt":  "2023-04-05T09:54:20Z"
                                        }
                                    ],
                          "totalCount":  1
                      },
        "updatedAt":  "2024-02-13T01:44:08Z",
        "body":  "### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Is your feature request related to a problem? Please describe the problem.\n\nToday, there is only one `UnprotectKeysWith*` configuration. The `UnprotectKeysWithAnyCertificate` logic that makes it possible to unprotect keys generated with old rotated certificates when the data protection protection is configured using `ProtectKeysWithCertificate`. While this functionality works perfectly. However, it is limited to ONLY work when the data protection is using `ProtectKeysWithCertificate` and not in other situations which makes it difficult to switch key protection system from e.g. Certificate to Azure Key Vault.\r\n\r\nIt would be nice if there was a solution that made `UnprotectKeysWithAnyCertificate` independent of the `ProtectKeysWithCertificate` and making other `UnprotectKeysWith*` methods for other key providers as well like e.g. Azure Key Vault.\r\n\r\nThis would make it easy e.g. with transition from one environment to e.g. Azure environment or to any other combination.\n\n### Describe the solution you\u0027d like\n\nI would like the Unprotect logic to be separated from the Protected logic so that:\r\n1. The unprotect logic can be extended to include other key providers as well.\r\n2. The unprotect logic can be added to other protect logic that isn\u0027t of the same type e.g. Azure Key Vault protection with unprotect logic from old certificates.\n\n### Additional context\n\n_No response_",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOcgHpuA==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde85UHWgd",
                                           "createdAt":  "2023-01-31T23:27:26Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOC1cF5w==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "dozer75",
                                                                               "createdAt":  "2023-02-04T09:49:51Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "captainsafia",
                                           "body":  "Triage: Sticking this in .NET 8 Planning for now to evaluate whether this will bubble up as high-pri work in the data protection area.",
                                           "updatedAt":  "2023-01-31T23:27:26Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85yAem4",
                                           "createdAt":  "2024-01-26T21:36:19Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "We\u0027ve moved this issue to the Backlog milestone. This means that it is not going to be worked on for the coming release. We will reassess the backlog following the current release and consider this item at that time. To learn more about our issue management process and to have better expectation regarding different types of issues you can read our [Triage Process](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2024-01-26T21:36:19Z"
                                       }
                                   ],
                         "totalCount":  2
                     },
        "title":  "Add a more general UnprotectKeyWith* solution for data protection",
        "labels":  [
                       "enhancement",
                       "area-dataprotection",
                       "api-suggestion"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/47185",
        "createdAt":  "2023-03-14T08:32:27Z",
        "number":  47185,
        "author":  "weirdyang",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHODCxbqw==",
                          "nodes":  [
                                        {
                                            "content":  "EYES",
                                            "user":  "1nf0rmagician",
                                            "createdAt":  "2024-07-11T16:04:24Z"
                                        },
                                        {
                                            "content":  "EYES",
                                            "user":  "FaisalAl-Rayes",
                                            "createdAt":  "2024-12-15T16:56:46Z"
                                        },
                                        {
                                            "content":  "EYES",
                                            "user":  "s-beji",
                                            "createdAt":  "2025-05-24T15:43:47Z"
                                        }
                                    ],
                          "totalCount":  3
                      },
        "updatedAt":  "2024-12-24T20:27:40Z",
        "body":  "### Is there an existing issue for this?\r\n\r\n- [X] I have searched the existing issues\r\n\r\n### Describe the bug\r\n\r\n```\r\nAn exception was thrown while deserializing the token.\r\nMicrosoft.AspNetCore.Antiforgery.AntiforgeryValidationException: The antiforgery token could not be decrypted.\r\n---\u003e System.Security.Cryptography.CryptographicException: The key {669d513e-a172-4851-b160-04b523abbc1e} was not found in the key ring.\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.UnprotectCore(Byte[] protectedData, Boolean allowOperationsOnRevokedKeys, UnprotectStatus\u0026 status)\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.DangerousUnprotect(Byte[] protectedData, Boolean ignoreRevocationErrors, Boolean\u0026 requiresMigration, Boolean\u0026 wasRevoked)\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.Unprotect(Byte[] protectedData)\r\n   at Microsoft.AspNetCore.Antiforgery.DefaultAntiforgeryTokenSerializer.Deserialize(String serializedToken)\r\n   --- End of inner exception stack trace ---\r\n   at Microsoft.AspNetCore.Antiforgery.DefaultAntiforgeryTokenSerializer.Deserialize(String serializedToken)\r\n   at Microsoft.AspNetCore.Antiforgery.DefaultAntiforgery.GetCookieTokenDoesNotThrow(HttpContext httpContext)\r\n\r\n\r\n```\r\n\r\nWe insert an anti-forgery token into the form using `@Html.AntiForgeryToken()` and validate the request using the `       [ValidateAntiForgeryToken]`, however we occasionally get the error above when one user tries to submit.\r\n\r\nHow is the key generated? Why does the user affect the generation of the token?\r\n\r\n\r\n\r\n### Expected Behavior\r\n\r\nWhen user submit a form, the request token is valid and the user request is accepted.\r\n\r\n### Steps To Reproduce\r\n\r\n1. Create a cshtml page\r\n2. Include an antiforgery token in the form using `@Html.AntiForgeryToken()` \r\n3. Annotate the controller method with  `[ValidateAntiForgeryToken]`\r\n4. Make a post request with the token\r\n\r\n### Exceptions (if any)\r\n\r\nAn exception was thrown while deserializing the token.\r\nMicrosoft.AspNetCore.Antiforgery.AntiforgeryValidationException: The antiforgery token could not be decrypted.\r\n\r\n### .NET Version\r\n\r\nnetcoreapp3.1\r\n\r\n### Anything else?\r\n\r\nWe have tried this with different users, different devices and different browsers.\r\n\r\nOnly this user has the issue, and it is correlated with the logs\u0027 timestamp.\r\n\r\nI\u0027ve checked the source code, and was wondering could it be due to special characters in the user name?\r\n\r\nhttps://github.com/dotnet/aspnetcore/blob/main/src/Antiforgery/src/Internal/DefaultAntiforgeryTokenGenerator.cs\r\n_No response_",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOmKuqEw==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde85ctSm1",
                                           "createdAt":  "2023-05-19T23:43:31Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "\u003e I\u0027ve checked the source code, and was wondering could it be due to special characters in the user name?\r\n\r\n I suppose it\u0027s not impossible - are you able to share the user\u0027s name?  Or maybe just the non-ASCII characters in it?  Or what sort of non-ASCII characters it contains (Latin with accents?  Japanese?  emoji?)?\r\n\r\n\u003e it is correlated with the logs\u0027 timestamp\r\n\r\nI wasn\u0027t sure quite what you meant by this.  I think maybe the user is seeing some sort of failure in their browser and when you look for failures in the log at the corresponding time, this is the stack you see?\r\n\r\nSome boilerplate questions:\r\n\r\n1. What is your hosting environment? IIS? Kestrel? Azure? A container of some sort?\r\n2. Do you have multiple instances running?",
                                           "updatedAt":  "2023-05-19T23:43:31Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85kTDc2",
                                           "createdAt":  "2023-08-17T17:49:48Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "NitinSinghSF",
                                           "body":  "We are having this same error running aspnet core web api  6.0 on AWS ECS ",
                                           "updatedAt":  "2023-08-17T17:49:48Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85r8eVT",
                                           "createdAt":  "2023-11-14T19:11:41Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHODpz8Iw==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "CONFUSED",
                                                                               "user":  "SankarraoKolli",
                                                                               "createdAt":  "2024-07-15T18:11:42Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "ChadEQ",
                                           "body":  "I had the same issue in asp.net 7.0 on windows/IIS. One instance. And no special characters in the user name.",
                                           "updatedAt":  "2023-11-14T19:11:41Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85r-iow",
                                           "createdAt":  "2023-11-14T23:30:49Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "weirdyang",
                                           "body":  "\u003e \u003e I\u0027ve checked the source code, and was wondering could it be due to special characters in the user name?\n\u003e \n\u003e \n\u003e \n\u003e  I suppose it\u0027s not impossible - are you able to share the user\u0027s name?  Or maybe just the non-ASCII characters in it?  Or what sort of non-ASCII characters it contains (Latin with accents?  Japanese?  emoji?)?\n\u003e \n\u003e \n\u003e \n\u003e \u003e it is correlated with the logs\u0027 timestamp\n\u003e \n\u003e \n\u003e \n\u003e I wasn\u0027t sure quite what you meant by this.  I think maybe the user is seeing some sort of failure in their browser and when you look for failures in the log at the corresponding time, this is the stack you see?\n\u003e \n\u003e \n\u003e \n\u003e Some boilerplate questions:\n\u003e \n\u003e \n\u003e \n\u003e 1. What is your hosting environment? IIS? Kestrel? Azure? A container of some sort?\n\u003e \n\u003e 2. Do you have multiple instances running?\n\nHi,\n\nIt doesn\u0027t contain any special characters or ascii.\n\nYes, I had the user share their screen, trigger the error and check the logs to ensure it\u0027s that error preventing them from submitting a form.\n\nNo, I do not have multiple instances running.",
                                           "updatedAt":  "2023-11-14T23:30:49Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85r-wIw",
                                           "createdAt":  "2023-11-15T00:33:48Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@weirdyang If you\u0027re in contact with the user, it might be interesting to ask them to try again after clearing their cookies.\r\n\r\n@weirdyang @NitinSinghSF @ChadEQ How is your key ring stored?  Is it a file on disk?  A blob in Azure Storage?",
                                           "updatedAt":  "2023-11-15T00:33:48Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85r-wkq",
                                           "createdAt":  "2023-11-15T00:36:07Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "Does anyone have a log including namespace `Microsoft.AspNetCore.DataProtection`, ideally at the `Trace` level?",
                                           "updatedAt":  "2023-11-15T00:36:07Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85r-wva",
                                           "createdAt":  "2023-11-15T00:37:02Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHODpz83g==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "CONFUSED",
                                                                               "user":  "SankarraoKolli",
                                                                               "createdAt":  "2024-07-15T18:14:03Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "weirdyang",
                                           "body":  "Hi\r\n\r\nWe have tried the following:\n\r\n1. Private browsing session\n\r\n2. Clearing cookies and cache\n\r\n3. On an iPad and iPhone\n\r\n4. On an android phone\n\r\n5. On another user’s laptop\r\n\r\nWe still run into the same error.\r\n\r\nOn Wed, 15 Nov 2023 at 8:34 AM, Andrew Casey ***@***.***\u003e\r\nwrote:\r\n\r\n\u003e @weirdyang \u003chttps://github.com/weirdyang\u003e If you\u0027re in contact with the\r\n\u003e user, it might be interesting to ask them to try again after clearing their\r\n\u003e cookies.\r\n\u003e\r\n\u003e @weirdyang \u003chttps://github.com/weirdyang\u003e @NitinSinghSF\r\n\u003e \u003chttps://github.com/NitinSinghSF\u003e @ChadEQ \u003chttps://github.com/ChadEQ\u003e How\r\n\u003e is your key ring stored? Is it a file on disk? A blob in Azure Storage?\r\n\u003e\r\n\u003e —\r\n\u003e Reply to this email directly, view it on GitHub\r\n\u003e \u003chttps://github.com/dotnet/aspnetcore/issues/47185#issuecomment-1811612208\u003e,\r\n\u003e or unsubscribe\r\n\u003e \u003chttps://github.com/notifications/unsubscribe-auth/AGDEEVXX32FPULLO3FNWH5TYEQEXRAVCNFSM6AAAAAAV2DUB7GVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMYTQMJRGYYTEMRQHA\u003e\r\n\u003e .\r\n\u003e You are receiving this because you were mentioned.Message ID:\r\n\u003e ***@***.***\u003e\r\n\u003e\r\n",
                                           "updatedAt":  "2023-11-15T00:38:10Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85r-xAu",
                                           "createdAt":  "2023-11-15T00:38:25Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@weirdyang To confirm, this happens on _every_ form submission from this user?\r\n\r\n@NitinSinghSF @ChadEQ Are you seeing the same?  There are multiple ways this error could arise.",
                                           "updatedAt":  "2023-11-15T00:38:25Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85r-zs-",
                                           "createdAt":  "2023-11-15T00:51:17Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "All sorts of default behaviors are overridable, e.g. with `AntiforgeryOptions`, but it\u0027s not immediately obvious to me how the user\u0027s name/ID could be incorporated into the anti-forgery token or the data protection key.\r\n\r\nEdit: it\u0027s in the anti-forgery [token](https://github.com/dotnet/aspnetcore/blob/5478946653b8c4aaf67842a4cf80bc5e48acee63/src/Antiforgery/src/Internal/DefaultAntiforgeryTokenSerializer.cs#L72), which _might_ explain why the problem follows the user.  _Maybe_ something about the way the user is encoded in the token breaks deserialization so that a bad data protection key ID is retrieved?",
                                           "updatedAt":  "2023-11-15T18:15:36Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85r-zxE",
                                           "createdAt":  "2023-11-15T00:51:41Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "I\u0027m assuming no one has a repro project they\u0027re able to share?",
                                           "updatedAt":  "2023-11-15T00:51:41Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85sEkX0",
                                           "createdAt":  "2023-11-15T19:31:41Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHODMumpw==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "weirdyang",
                                                                               "createdAt":  "2023-11-15T22:43:33Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "amcasey",
                                           "body":  "Just for the record, I suppose I should mention that netcoreapp3.1 is out of support and wouldn\u0027t be patched if that ended up being the fix.  I\u0027m tentatively operating on the assumption that @NitinSinghSF and @ChadEQ are seeing the same exception in 6.0 and 7.0, but it would be nice if they could confirm that they\u0027re seeing the same symptoms - the problem follows particular users across devices / cookie wipes.",
                                           "updatedAt":  "2023-11-15T19:31:41Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85sEpmw",
                                           "createdAt":  "2023-11-15T19:43:45Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "ChadEQ",
                                           "body":  "I\u0027m on .net 7.0. And for me, it\u0027s extremely rare, not consistent. ",
                                           "updatedAt":  "2023-11-15T19:43:45Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85sFXvg",
                                           "createdAt":  "2023-11-15T22:14:15Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@ChadEQ Are you seeing it for particular users or do you just occasionally see that log message?",
                                           "updatedAt":  "2023-11-15T22:14:15Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85sFZd7",
                                           "createdAt":  "2023-11-15T22:21:05Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@weirdyang Is the username unusually long or short?",
                                           "updatedAt":  "2023-11-15T22:21:05Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85sFfZP",
                                           "createdAt":  "2023-11-15T22:38:55Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@weirdyang Are you working with @apetrut?  #51165 appears to have an error message with the same GUID.",
                                           "updatedAt":  "2023-11-15T22:38:55Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85sFgYI",
                                           "createdAt":  "2023-11-15T22:42:45Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "weirdyang",
                                           "body":  "\u003e @weirdyang Are you working with @apetrut?  #51165 appears to have an error message with the same GUID.\n\nNo\n\nThe user name is not unusually long",
                                           "updatedAt":  "2023-11-15T22:42:45Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85sFjAr",
                                           "createdAt":  "2023-11-15T22:52:13Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "ChadEQ",
                                           "body":  "Currently only see it for one user. It seems to be the first submit (the user is logging in) for the user after an IIS app pool recycle. The user name is 3 characters, but so are all the others.",
                                           "updatedAt":  "2023-11-15T22:52:13Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85sFv8V",
                                           "createdAt":  "2023-11-15T23:25:50Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "And is that user seeing in on multiple devices and/or after clearing cookies?",
                                           "updatedAt":  "2023-11-15T23:25:50Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85sFwIq",
                                           "createdAt":  "2023-11-15T23:26:21Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "Also, can you please confirm you\u0027re seeing a different GUID in your error message?  I\u0027m going to get creeped out if there are three of these.",
                                           "updatedAt":  "2023-11-15T23:26:21Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85seNs0",
                                           "createdAt":  "2023-11-20T21:50:11Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "Serialization format for the anti-forgery token:\r\n```csharp\r\n/* The serialized format of the anti-XSRF token is as follows:\r\n * Version: 1 byte integer\r\n * SecurityToken: 16 byte binary blob\r\n * IsCookieToken: 1 byte Boolean\r\n * [if IsCookieToken != true]\r\n *   +- IsClaimsBased: 1 byte Boolean\r\n *   |  [if IsClaimsBased = true]\r\n *   |    `- ClaimUid: 32 byte binary blob\r\n *   |  [if IsClaimsBased = false]\r\n *   |    `- Username: UTF-8 string with 7-bit integer length prefix\r\n *   `- AdditionalData: UTF-8 string with 7-bit integer length prefix\r\n */\r\n```\r\n\r\nThis blob of binary is then encrypted.  From the stack, this is done using a `KeyRingBasedDataProtector`, which produces output starting with the magic header `0x09F0C9F0` and the bytes of the GUID key ID (`669d513e-a172-4851-b160-04b523abbc1e` in the original report), followed by the encrypted data, etc.\r\n\r\nFinally, the encrypted payload is base64 encoded.\r\n\r\nReversing this to deserialize, we expect only to have to base64 decode and discard 4 bytes of magic header to access the 16 bytes of the key ID.\r\n\r\nWhile user-specific data does appear in the payload, particularly in the `Username` or `ClaimUid`, these come _after_ the key ID, so it\u0027s not clear to me how they could cause the key ID to be deserialized incorrectly.\r\n\r\nThere are some nuances around endianness, but we\u0027ve said that this repros across a number of widely-used devices.\r\n\r\nThere are definitely scenarios/bugs where you could fail to find a key, but I\u0027m having trouble thinking of a way it could affect only particular users.",
                                           "updatedAt":  "2023-11-20T21:50:11Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85seOIt",
                                           "createdAt":  "2023-11-20T21:51:33Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "I gather these apps are authenticated.  What mechanism are people using?  Claims-based?  Which provider?",
                                           "updatedAt":  "2023-11-20T21:51:33Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85sehJ2",
                                           "createdAt":  "2023-11-20T22:57:47Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "ChadEQ",
                                           "body":  "To answer your previous questions first, but not sure if any of them where directed at me. Different key than what\u0027s reported in this issue. User hasn\u0027t tried different devices, but has tried Edge and Chrome. Interestingly but probably coincidental, it seems to be easier to reproduce using Edge than Chrome. Yes, using authentication. Cookie authentication scheme and yes using claims. But for us, the error is happening on an anonymous page, before the user has logged in, so no authentication cookie is sent, just the anti-forgery.",
                                           "updatedAt":  "2023-11-20T22:57:47Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85se3tN",
                                           "createdAt":  "2023-11-21T00:39:37Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@ChadEQ Thanks!  Sorry for not being clearer with tags.\r\n\r\nI\u0027m relieved to hear that the guid is different. 😅 \r\n\r\nEdge and Chrome are pretty similar these days, though that should at least get you a fresh cookie.  Trying on a different device would be interesting, if that\u0027s an option.\r\n\r\nThe fact that this is happening before authentication is interesting - I think it will still put a blank username in the token, but that should be the same for all users.  Is the user themself distinguished in some way?  Are they the first to sign in every morning (e.g. because of time zones)?",
                                           "updatedAt":  "2023-11-21T00:39:37Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85se3zJ",
                                           "createdAt":  "2023-11-21T00:40:06Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@weirdyang @ChadEQ Are either of you able to debug the server while this is failing?  We have public symbols and I can suggest breakpoints.",
                                           "updatedAt":  "2023-11-21T00:40:06Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85sgLLO",
                                           "createdAt":  "2023-11-21T07:30:03Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "apetrut",
                                           "body":  "@amcasey I had a similar issue when using same browser with 2 tabs. If tried using 2 different browsers then I didn\u0027t get that issue anymore.",
                                           "updatedAt":  "2023-11-21T07:30:03Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85sj38o",
                                           "createdAt":  "2023-11-21T17:20:05Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@apetrut I think two tabs in the same browser would use the same cookie and require the same key for decryption.",
                                           "updatedAt":  "2023-11-21T17:20:05Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85sj4LI",
                                           "createdAt":  "2023-11-21T17:20:42Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@apetrut Any insights on the GUID collision?  I\u0027m assuming you didn\u0027t copy-paste yours from this bug.",
                                           "updatedAt":  "2023-11-21T17:20:42Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85srrSR",
                                           "createdAt":  "2023-11-22T19:28:08Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "apetrut",
                                           "body":  "@amcasey I don\u0027t recall seeing this ticket when I opened mine.\r\n\r\n@weirdyang  This is what I\u0027ve tried in order to get rid of the error and it worked for me:\r\n\r\nservices.AddAntiforgery(options =\u003e\r\n            {\r\n                options.FormFieldName = \"AntiforgeryFieldname\";\r\n                options.HeaderName = \"X-CSRF-TOKEN-HEADERNAME\";\r\n                options.SuppressXFrameOptionsHeader = false;\r\n            });\r\n\r\nand also:\r\n\r\nservices.AddDataProtection()\r\n                    .SetApplicationName(\"yourAppName\")\r\n                    .PersistKeysToFileSystem(new DirectoryInfo(string.Format(@\"{0}opt{0}app{0}sysfiles{0}\", Path.DirectorySeparatorChar)))\r\n                    .ProtectKeysWithCertificate(new X509Certificate2(string.Format(@\"{0}certificates{0}verify-cert.pfx\", Path.DirectorySeparatorChar), Configuration[\"ApplicationSettings:CertificatePassword\"]))\r\n                    .SetDefaultKeyLifetime(TimeSpan.FromDays(15));",
                                           "updatedAt":  "2023-11-22T19:28:08Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85ssJPR",
                                           "createdAt":  "2023-11-22T21:13:04Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "It\u0027s not obvious to me how changing the anti-forgery options could help, but explicitly configuring data protection might well bypass whatever bug/surprising behavior is causing this error.",
                                           "updatedAt":  "2023-11-22T21:13:04Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85ssJXv",
                                           "createdAt":  "2023-11-22T21:13:39Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "FYI, we\u0027re going into a long weekend here, so responses are likely to be slow until next week.",
                                           "updatedAt":  "2023-11-22T21:13:39Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85yAhCb",
                                           "createdAt":  "2024-01-26T21:46:30Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "Thanks for contacting us.\n\nWe\u0027re moving this issue to the `.NET 9 Planning` milestone for future evaluation / consideration. We would like to keep this around to collect more feedback, which can help us with prioritizing this work. We will re-evaluate this issue, during our next planning meeting(s). \nIf we later determine, that the issue has no community involvement, or it\u0027s very rare and low-impact issue, we will close it - so that the team can focus on more important and high impact issues.\nTo learn more about what to expect next and how this issue will be handled you can read more about our triage process [here](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2024-01-26T21:46:30Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85yMQML",
                                           "createdAt":  "2024-01-30T00:18:51Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "brackert",
                                           "body":  "I didn\u0027t read this entire thread, so I apologize if someone already suggested this... \r\n\r\nOne possible cause: If you are using IIS, make sure the application pool (Advanced Settings) has \u0027Load User Profile\u0027 set to True.",
                                           "updatedAt":  "2024-01-30T00:18:51Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85yxnti",
                                           "createdAt":  "2024-02-04T07:27:22Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOEYTkYw==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "weirdyang",
                                                                               "createdAt":  "2024-03-05T16:06:53Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "ebeeraheem",
                                                                               "createdAt":  "2025-06-28T13:40:01Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  2
                                                         },
                                           "author":  "Sajad-dev720",
                                           "body":  "Hi!\r\nI get the same error for every user, but not in Mozilla and Mozilla Developer Edition, only in MS Edge and Chrome. The error I get in the logs is as follows:\r\n`Microsoft.AspNetCore.Antiforgery.AntiforgeryValidationException: The antiforgery token could not be decrypted.\r\n ---\u003e System.Security.Cryptography.CryptographicException: The key {946d4fa4-6290-4104-a4d6-d0eb9dfa3006} was not found in the key ring. For more information go to http://aka.ms/dataprotectionwarning\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.UnprotectCore(Byte[] protectedData, Boolean allowOperationsOnRevokedKeys, UnprotectStatus\u0026 status)\r\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.Unprotect(Byte[] protectedData)\r\n   at Microsoft.AspNetCore.Antiforgery.DefaultAntiforgeryTokenSerializer.Deserialize(String serializedToken)\r\n   --- End of inner exception stack trace ---\r\n   at Microsoft.AspNetCore.Antiforgery.DefaultAntiforgeryTokenSerializer.Deserialize(String serializedToken)\r\n   at Microsoft.AspNetCore.Antiforgery.DefaultAntiforgery.GetCookieTokenDoesNotThrow(HttpContext httpContext)`\r\n\r\nA point to be considered is, it rarely happens on our production server, but it happens every time on our test server, where we set the same PasswordHash for all users. Now as far as I could trace it, the authentication is done successfully, but afterwards, when redirecting to a protected endpoint, this error happens and the user is unable to log in.\r\n\r\n\r\n\r\n\u003e I didn\u0027t read this entire thread, so I apologize if someone already suggested this...\r\n\u003e \r\n\u003e One possible cause: If you are using IIS, make sure the application pool (Advanced Settings) has \u0027Load User Profile\u0027 set to True.\r\n\r\nI also did that and the result was the same.",
                                           "updatedAt":  "2024-02-04T07:27:22Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde8529qFz",
                                           "createdAt":  "2024-03-13T21:24:09Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "enkelmedia",
                                           "body":  "I have the same error, especially in development - the error is logged on each startup even after cleaning cookies in the browser. Also using Chrome.\r\n\r\nEDIT:\r\nIn our case we had the right setup, storing keys on disk etc. but the application that we where running (Umbraco CMS) did some shady stuff with custom anti-forgery tokens and did not consider the configuration that we added during startup.",
                                           "updatedAt":  "2024-04-29T09:36:49Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde854wfML",
                                           "createdAt":  "2024-03-28T19:40:22Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "joepietrzak",
                                           "body":  "same issue here, just tapping in so I get notified if/when there\u0027s a resolution",
                                           "updatedAt":  "2024-03-28T19:40:22Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde854wsma",
                                           "createdAt":  "2024-03-28T20:13:56Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@enkelmedia @joepietrzak I just want to confirm: there are lots of reasons you might see key not found errors - what\u0027s special about this thread is that the error somehow follows a particular user, even across devices, but other users are unaffected.  Is that\u0027s what you\u0027re seeing?",
                                           "updatedAt":  "2024-03-28T20:13:56Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde8540yHL",
                                           "createdAt":  "2024-03-29T11:24:09Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "enkelmedia",
                                           "body":  "@amcasey It seems like that, one solution we work on works on my colleges computer but I get this issue. The issue is also not present on test, stage or prod machines.\r\n\r\nTo be fair - i did not try to clone the solution into a clean folder - might be worth trying.",
                                           "updatedAt":  "2024-03-29T11:24:09Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde857byC6",
                                           "createdAt":  "2024-04-22T20:18:26Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHODtDSaA==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "davidliang2008",
                                                                               "createdAt":  "2024-07-01T07:05:55Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_DOWN",
                                                                               "user":  "weirdyang",
                                                                               "createdAt":  "2024-08-07T01:37:48Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  2
                                                         },
                                           "author":  "VahidN",
                                           "body":  "If you are running your app on a web farm or cloud environment, you should persist the data protection key, otherwise it will be different on each machine. [more info](https://learn.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview?view=aspnetcore-8.0#persistkeystodbcontext)\r\nThe same thing will happen if you recycle the application\u0027s pool on IIS. The old key will be disappeared. [more info](https://learn.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/default-settings?view=aspnetcore-8.0)",
                                           "updatedAt":  "2024-04-22T20:18:26Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86HZBbY",
                                           "createdAt":  "2024-08-06T14:49:09Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "boukenka",
                                           "body":  "Any update? Facing the same issue.",
                                           "updatedAt":  "2024-08-06T14:49:09Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86KZjpU",
                                           "createdAt":  "2024-08-30T16:48:24Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "scharada",
                                           "body":  "same issue here ... ",
                                           "updatedAt":  "2024-08-30T16:48:24Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86Ka6xR",
                                           "createdAt":  "2024-08-30T20:43:50Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOD5FBCg==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "SolarOsQuiere",
                                                                               "createdAt":  "2024-10-29T14:20:35Z"
                                                                           },
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "chrisfcarroll",
                                                                               "createdAt":  "2024-11-01T17:38:26Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  2
                                                         },
                                           "author":  "madjar4-cssmb",
                                           "body":  "I have a case that is not user specific. I will report it here, as I am not fully certain that it is an issue or expected behaviour. It might help with this.\r\n\r\nContext:\r\n- a blazor .NET 8 Web App. App \u0026 Routes configured for interactive server.\r\n- the entrypoint is anonymous, no auth cookie required.\r\n- the application is hosted on IIS, on a path (example: `my.website.com/ThisIsTheBasePathOfTheApp`)\r\n  - The base path is configured with `/ThisIsTheBasePathOfTheApp/`.\r\n\r\nSimply navigating to `my.website.com/ThisIsTheBasePathOfTheApp` works no problem.\r\nNow, if we navigate to it after we **change the casing** of a single letter, I get a familiar error exception. For example, if we go to `my.website.com/thisIsTheBasePathOfTheApp` (first `t` is lowercase).\r\n\r\n## Exception: The antiforgery token could not be decrypted.\r\nSource: `Microsoft.AspNetCore.Antiforgery`\r\nStackTrace:\r\n- at Microsoft.AspNetCore.Antiforgery.DefaultAntiforgeryTokenSerializer.Deserialize(String serializedToken)\r\n- at Microsoft.AspNetCore.Antiforgery.DefaultAntiforgery.GetCookieTokenDoesNotThrow(HttpContext httpContext)\r\n \r\n### InnerException: The key {597fc0e8-bbce-4963-b068-0f809a667142} was not found in the key ring. For more information go to https://aka.ms/aspnet/dataprotectionwarning\r\nSource: `Microsoft.AspNetCore.DataProtection`\r\nStackTrace:\r\n- at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.UnprotectCore(Byte[] protectedData, Boolean allowOperationsOnRevokedKeys, UnprotectStatus\u0026 status)\r\n- at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.Unprotect(Byte[] protectedData)\r\n- at Microsoft.AspNetCore.Antiforgery.DefaultAntiforgeryTokenSerializer.Deserialize(String serializedToken)\r\n\r\n## Edit:\r\nI suppose this is more related with #5405, but I cannot be certain.",
                                           "updatedAt":  "2024-08-30T20:59:01Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86QvDVT",
                                           "createdAt":  "2024-10-22T04:54:11Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "varunmydala",
                                           "body":  "I face same issue in my local IIS. It is fine in Staging and production envs.\n.NET code web app running on .NET 6.\n",
                                           "updatedAt":  "2024-10-22T04:54:45Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86QywTh",
                                           "createdAt":  "2024-10-22T13:00:56Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "madjar4-cssmb",
                                           "body":  "As a workaround, a middleware \"standardizing\" the request path has been added in our app **right after** `UsePathBase`. It basically does the following:\n\n```csharp\n// context is the HttpContext.\nvar basePath = context.Request.PathBase;\nif (basePath.StartsWithSegments(_basePathWithoutSlash, StringComparison.InvariantCultureIgnoreCase)\n               \u0026\u0026 !basePath.StartsWithSegments(_basePathWithoutSlash, StringComparison.Ordinal))\n{\n    // Redirect to _basePathWithoutSlash + context.Request.Path\n}\n// carry on\n```\n",
                                           "updatedAt":  "2024-10-22T13:00:56Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86Rsuts",
                                           "createdAt":  "2024-10-29T14:24:03Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOD5FB6g==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "chrisfcarroll",
                                                                               "createdAt":  "2024-11-01T17:39:59Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "SolarOsQuiere",
                                           "body":  "Same issue:\n\nBlazor Net8 : Rendermode Auto (with server and client components)\n\nDeployed Windows Server 2019 on 2 nodes.\n\nWhen the app is deployed first time i get the exception, in the logs:\n\n```\nMicrosoft.AspNetCore.Antiforgery.AntiforgeryValidationException: The antiforgery token could not be decrypted.\n ---\u003e System.Security.Cryptography.CryptographicException: The key {d8ffbea2-4fff-4fd2-ade3-f0fb72b71a12} was not found in the key ring. For more information go to https://aka.ms/aspnet/dataprotectionwarning\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.UnprotectCore(Byte[] protectedData, Boolean allowOperationsOnRevokedKeys, UnprotectStatus\u0026 status)\n   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.Unprotect(Byte[] protectedData)\n   at Microsoft.AspNetCore.Antiforgery.DefaultAntiforgeryTokenSerializer.Deserialize(String serializedToken)\n   --- End of inner exception stack trace ---\n   at Microsoft.AspNetCore.Antiforgery.DefaultAntiforgeryTokenSerializer.Deserialize(String serializedToken)\n   at Microsoft.AspNetCore.Antiforgery.DefaultAntiforgery.GetCookieTokenDoesNotThrow(HttpContext httpContext)\n```\nBut somehow the app its up with no problems\n\nTried following the code recommended in the guides:\n\n```\npublic static IServiceCollection ConfiguracionAntiforgeryToken(\n    this IServiceCollection services,\n    WebApplicationBuilder config\n)\n{\n    var keysFolder = Path.Combine(config.Environment.ContentRootPath, \"Keys\");\n    Directory.CreateDirectory(keysFolder);\n    config\n        .Services.AddDataProtection()\n        .UseCryptographicAlgorithms(\n            new AuthenticatedEncryptorConfiguration\n            {\n                EncryptionAlgorithm = EncryptionAlgorithm.AES_256_CBC,\n                ValidationAlgorithm = ValidationAlgorithm.HMACSHA256\n            }\n        )\n        .PersistKeysToFileSystem(new DirectoryInfo(keysFolder))\n        .SetApplicationName(\"MyWebsite\")\n        .SetDefaultKeyLifetime(TimeSpan.FromDays(90));\n    return services;\n}\n```\n\nBut nothing changes, i get the error only when the app is deployed for the first time\n\nUpdate: i think its related with this : #46124\n\n",
                                           "updatedAt":  "2024-10-29T14:25:16Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86Yq6oT",
                                           "createdAt":  "2024-12-24T20:25:42Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "omuleanu",
                                           "body":  "I\u0027m not using the `ValidateAntiForgeryToken` attribute anywhere in my app (asp.net core 8), and I\u0027m getting sometimes this error.\n\n\u003e DefaultAntiforgeryTokenSerializer.cs in AntiforgeryToken DefaultAntiforgeryTokenSerializer.Deserialize(string serializedToken) at line 69\n\n```\n// if we reached this point, something went wrong deserializing\nthrow new AntiforgeryValidationException(Resources.AntiforgeryToken_DeserializationFailed, innerException); \n```\nit starts here:\nhttps://github.com/dotnet/aspnetcore/blob/47576478939fdd59b4400ad135f47938af486ab3/src/Antiforgery/src/Internal/DefaultAntiforgeryTokenSerializer.cs#L31",
                                           "updatedAt":  "2024-12-24T20:27:40Z"
                                       }
                                   ],
                         "totalCount":  45
                     },
        "title":  "The antiforgery token could not be decrypted - Only for specific user",
        "labels":  [
                       "area-dataprotection"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/48944",
        "createdAt":  "2023-06-21T14:57:49Z",
        "number":  48944,
        "author":  "madelson",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHOCw2yWQ==",
                          "nodes":  [
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "yonail",
                                            "createdAt":  "2023-06-22T07:28:48Z"
                                        }
                                    ],
                          "totalCount":  1
                      },
        "updatedAt":  "2024-02-13T01:32:46Z",
        "body":  "## Background and Motivation\r\n\r\n\u003c!--\r\nWe welcome API proposals! We have a process to evaluate the value and shape of new API. There is an overview of our process [here](https://github.com/dotnet/aspnetcore/blob/main/docs/APIReviewProcess.md). This template will help us gather the information we need to start the review process.\r\nFirst, please describe the purpose and value of the new API here.\r\n--\u003e\r\n\r\nToday, `DataProtectionProvider` offers a number of different `Create` factory methods. All of them take either an application name or a key directory, along with a few other parameters. \r\n\r\nHowever, it is possible to use data protection without storing keys on the file system. This is doable with the API today via the setup action parameter, but it is awkward because you still have to pass a key directory which is not used. For example:\r\n\r\n```\r\n\tvar provider = DataProtectionProvider.Create(\r\n\t\tnew DirectoryInfo(@\"X:\\fake\\directory\"), // ignored\r\n\t\tb =\u003e\r\n\t\t{\r\n\t\t\tb.SetApplicationName(\"APTPlatform\");\r\n\t\t\tb.Services.AddSingleton\u003cIConfigureOptions\u003cKeyManagementOptions\u003e\u003e(services =\u003e\r\n\t\t\t{\r\n\t\t\t\treturn new ConfigureOptions\u003cKeyManagementOptions\u003e(o =\u003e\r\n\t\t\t\t{\r\n\t\t\t\t\to.XmlRepository = new MyRepository();\r\n\t\t\t\t\t...\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n```\r\n\r\n## Proposed API\r\n\r\n\u003c!--\r\nPlease provide the specific public API signature diff that you are proposing. For example:\r\n```diff\r\nnamespace Microsoft.AspNetCore.Http;\r\n\r\npublic static class HttpResponseWritingExtensions\r\n{\r\n+    public Task WriteAsync(this HttpResponse response, StringBuilder builder);\r\n}\r\n```\r\nYou may find the [Framework Design Guidelines](https://github.com/dotnet/runtime/blob/master/docs/coding-guidelines/framework-design-guidelines-digest.md) helpful.\r\n--\u003e\r\n```\r\nnamespace Microsoft.AspNetCore.DataProtection;\r\n\r\npublic static class DataProtectionProvider\r\n{\r\n+    public static IDataProtectionProvider Create(Action\u003cIDataProtectionBuilder\u003e setupAction);\r\n}\r\n```\r\n\r\n## Usage Examples\r\n\r\n\u003c!--\r\nPlease provide code examples that highlight how the proposed API additions are meant to be consumed.\r\nThis will help suggest whether the API has the right shape to be functional, performant and useable.\r\nYou can use code blocks like this:\r\n```csharp\r\n// some lines of code here\r\n```\r\n--\u003e\r\n```\r\nvar provider = DataProtectionProvider.Create(\r\n    b =\u003e b.SetApplicationName(...).PersistKeysTo...().ProtectKeysWith...()\r\n);\r\n```\r\n\r\n## Alternative Designs\r\n\r\n\u003c!--\r\nWere there other options you considered, such as alternative API shapes?\r\nHow does this compare to analogous APIs in other ecosystems and libraries?\r\n--\u003e\r\nRather than requiring _only_ setupAction, we could offer a creation method with application name + setup action. I\u0027m not sure why the current set of create methods were designed the way they were (e.g. why do we think users will either know the key directory or the application name?).\r\n\r\n## Risks\r\n\r\n\u003c!--\r\nPlease mention any risks that to your knowledge the API proposal might entail, such as breaking changes, performance regressions, etc.\r\n--\u003e\r\nThe risk seems low, since you can effectively do this today by just overriding the key persistence in your setup action. However, it would make the code a bit easier to understand.",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOcgHtcA==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde85yAe1w",
                                           "createdAt":  "2024-01-26T21:37:18Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "We\u0027ve moved this issue to the Backlog milestone. This means that it is not going to be worked on for the coming release. We will reassess the backlog following the current release and consider this item at that time. To learn more about our issue management process and to have better expectation regarding different types of issues you can read our [Triage Process](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2024-01-26T21:37:18Z"
                                       }
                                   ],
                         "totalCount":  1
                     },
        "title":  "DataProtectionProvider should expose a Create method which only takes setupAction",
        "labels":  [
                       "area-dataprotection",
                       "api-suggestion"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/50560",
        "createdAt":  "2023-09-06T20:30:00Z",
        "number":  50560,
        "author":  "amcasey",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHOC1Ec7g==",
                          "nodes":  [
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "WhitWaldo",
                                            "createdAt":  "2024-01-10T04:28:50Z"
                                        }
                                    ],
                          "totalCount":  1
                      },
        "updatedAt":  "2025-08-22T18:01:26Z",
        "body":  "The remaining work in #22029 is to create a new doc page explaining the [error messages](https://github.com/dotnet/aspnetcore/issues/22029#issuecomment-1699772926) containing the link https://aka.ms/aspnet/dataprotectionwarning.  Once that\u0027s done, we can update the aka.ms link to point to the new, more specific documentation.",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOZd40yg==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde85l3jTK",
                                           "createdAt":  "2023-09-06T20:30:22Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "Thanks for contacting us.\n\nWe\u0027re moving this issue to the `.NET 9 Planning` milestone for future evaluation / consideration. We would like to keep this around to collect more feedback, which can help us with prioritizing this work. We will re-evaluate this issue, during our next planning meeting(s). \nIf we later determine, that the issue has no community involvement, or it\u0027s very rare and low-impact issue, we will close it - so that the team can focus on more important and high impact issues.\nTo learn more about what to expect next and how this issue will be handled you can read more about our triage process [here](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2023-09-06T20:30:22Z"
                                       }
                                   ],
                         "totalCount":  1
                     },
        "title":  "Create a new documentation page elaborating on various Data Protection error messages",
        "labels":  [
                       "area-dataprotection",
                       "Docs"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/52916",
        "createdAt":  "2023-12-19T21:27:27Z",
        "number":  52916,
        "author":  "amcasey",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  null,
                          "nodes":  [

                                    ],
                          "totalCount":  0
                      },
        "updatedAt":  "2025-08-25T16:56:13Z",
        "body":  "### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Is your feature request related to a problem? Please describe the problem.\n\nSame as #52915.  We want to separate keyring reads from keyring writes to avoid races when there are multiple consumers.  If we make consumers read-only, we need a dedicated writer to ensure there\u0027s an active key in a newly-created keyring and an unexpired key in an existing one.\n\n### Describe the solution you\u0027d like\n\nWe could make a simple command-line executable that can be run either periodically or on a dynamic schedule.  It needs only basic data protection functionality:\r\n1. Read the existing keyring, if any\r\n2. Generate a new key if there isn\u0027t one or if the active one is near/past expiration\r\n3. Revoke all keys (we probably don\u0027t want to deal with the complexity of specifying particular keys to revoke)\r\n4. Delete long-unused keys to avoid unbounded keyring growth\r\n5. Output the next time it should be run (if it\u0027s not going to happen on a fixed cadence)\n\n### Additional context\n\nFor compatibility, this component basically has to consume the existing Data Protection APIs.  That effectively locks us to C#, but our Data Protection usage should be simple enough to allow AOT for consumers that don\u0027t have a CLR available.\r\n\r\nWe probably don\u0027t want to expose an API for all the possible storage locations of the keyring, so it will probably just be a path.\r\n\r\nIt\u0027s not yet clear whether this will be a reusable component or merely a sample/template that can be customized per-application.",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOv_zVjQ==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde85vKTHv",
                                           "createdAt":  "2023-12-20T18:44:42Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "Tratcher",
                                           "body":  "This could be a comparable tool to dotnet-ef that used all of the configuration from the current project but ignored the read-only flag. That way it could support all the different types of data stores without additional configuration (e.g. key-vault, EF, files, custom). https://learn.microsoft.com/en-us/ef/core/cli/dotnet\r\n\r\n*edit* project integration might make less sense if this is primarily intended for use in production.",
                                           "updatedAt":  "2023-12-20T18:46:26Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde85yAhF0",
                                           "createdAt":  "2024-01-26T21:46:45Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  null,
                                           "body":  "Thanks for contacting us.\n\nWe\u0027re moving this issue to the `.NET 9 Planning` milestone for future evaluation / consideration. We would like to keep this around to collect more feedback, which can help us with prioritizing this work. We will re-evaluate this issue, during our next planning meeting(s). \nIf we later determine, that the issue has no community involvement, or it\u0027s very rare and low-impact issue, we will close it - so that the team can focus on more important and high impact issues.\nTo learn more about what to expect next and how this issue will be handled you can read more about our triage process [here](https://github.com/dotnet/aspnetcore/blob/main/docs/TriageProcess.md).",
                                           "updatedAt":  "2024-01-26T21:46:45Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86Invvn",
                                           "createdAt":  "2024-08-15T20:05:49Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "The proof-of-concept system seems to be working, so we should probably write this up.",
                                           "updatedAt":  "2024-08-15T20:05:49Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86OvCT8",
                                           "createdAt":  "2024-10-04T21:28:11Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "I put some draft text [here](https://github.com/dotnet/AspNetCore.Docs/pull/33104/).",
                                           "updatedAt":  "2024-10-04T21:28:11Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86hfbWh",
                                           "createdAt":  "2025-03-10T04:01:24Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "WeihanLi",
                                           "body":  "How about the EF support? Any plan to support deleting key in the EF extension?",
                                           "updatedAt":  "2025-03-10T04:01:24Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86__NWN",
                                           "createdAt":  "2025-08-25T16:56:08Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "DeagleGross",
                                           "body":  "Seems not urgent: moving to net11 planning since some work is already done by amcasey",
                                           "updatedAt":  "2025-08-25T16:56:08Z"
                                       }
                                   ],
                         "totalCount":  6
                     },
        "title":  "Define a pattern for a component that ensures a data protection keyring has an active key",
        "labels":  [
                       "area-dataprotection"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/54451",
        "createdAt":  "2024-03-08T22:03:54Z",
        "number":  54451,
        "author":  "amcasey",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHOC2nIDA==",
                          "nodes":  [
                                        {
                                            "content":  "HEART",
                                            "user":  "claudiaregio",
                                            "createdAt":  "2024-03-18T17:59:22Z"
                                        }
                                    ],
                          "totalCount":  1
                      },
        "updatedAt":  "2025-08-22T18:01:28Z",
        "body":  "### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Is your feature request related to a problem? Please describe the problem.\n\n_No response_\n\n### Describe the solution you\u0027d like\n\nWe should have `KestrelMetrics`-style metrics for Data Protection.  In particular, we should have simple (vs up-down) counters for the most important error conditions, especially key-not-found.\n\n### Additional context\n\n_No response_",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOhV5UzA==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde852bCX9",
                                           "createdAt":  "2024-03-09T08:57:19Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "gfoidl",
                                           "body":  "\u003e We should have `KestrelMetrics`-style metrics for Data Protection.\r\n\r\nDid you mean _OTEL-style_ metrics? (😉)\r\n\r\n\u003e especially key-not-found.\r\n\r\nFor easier diagnostics should this be expanded to add an (failure) event to `Activity.Current`?",
                                           "updatedAt":  "2024-03-09T08:57:19Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde852i3ri",
                                           "createdAt":  "2024-03-11T16:24:58Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "\u003e For easier diagnostics should this be expanded to add an (failure) event to Activity.Current?\r\n\r\n@gfoidl Tell me more?  I\u0027m new to OTEL conventions.",
                                           "updatedAt":  "2024-03-11T16:24:58Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86FXlTM",
                                           "createdAt":  "2024-07-18T20:50:19Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "Personally, I think [this](https://github.com/dotnet/aspnetcore/pull/54846) is the highest ROI telemetry we could add, but there\u0027s some concern about whether it should be dotnet-wide or, conversely, whether this offers any value over log querying, so it\u0027s on hold for now.",
                                           "updatedAt":  "2024-07-18T20:50:19Z"
                                       }
                                   ],
                         "totalCount":  3
                     },
        "title":  "Add Data Protection Metrics",
        "labels":  [
                       "area-dataprotection"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/54708",
        "createdAt":  "2024-03-22T20:58:00Z",
        "number":  54708,
        "author":  "amcasey",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  null,
                          "nodes":  [

                                    ],
                          "totalCount":  0
                      },
        "updatedAt":  "2024-03-22T20:58:41Z",
        "body":  "### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Describe the bug\n\n`CacheableKeyRing.WithTemporaryExtendedLifetime` should not extend the cache lifetime beyond the lifetime of the key ring\u0027s default key in order to avoid protecting data with an expired key.  It only extends by two minutes but, AFAICT, it can be extended repeatedly, if each new attempt fails.\n\n### Expected Behavior\n\nUnfortunately, `CacheableKeyRing` doesn\u0027t expose a way to get to the default `IKey` - only the `IAuthenticatedEncryptor`, which doesn\u0027t have an expiration date.  It would be straightforward to expose it on `IKeyRing`, but that type is public for historical reasons.\n\n### Steps To Reproduce\n\nI think you\u0027d have to start the app in a state where the only available key was about to expire and then have generation of a new key fail (e.g. because of lack of access to AKV).  But this is just theoretical and it\u0027s possible it can\u0027t arise in practice.\n\n### Exceptions (if any)\n\n_No response_\n\n### .NET Version\n\n_No response_\n\n### Anything else?\n\n_No response_",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOeCgrEw==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde854KCsT",
                                           "createdAt":  "2024-03-22T20:58:40Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "Backlogging, but we might revisit this if the types involve are made internal.",
                                           "updatedAt":  "2024-03-22T20:58:40Z"
                                       }
                                   ],
                         "totalCount":  1
                     },
        "title":  "Don\u0027t extend the key ring cache lifetime beyond the default key lifetime",
        "labels":  [
                       "area-dataprotection"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/57833",
        "createdAt":  "2024-09-12T09:15:49Z",
        "number":  57833,
        "author":  "MichaelRomer",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHOC8CJ4Q==",
                          "nodes":  [
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "suikkanen-pulseon",
                                            "createdAt":  "2024-10-22T10:29:40Z"
                                        }
                                    ],
                          "totalCount":  1
                      },
        "updatedAt":  "2025-08-22T18:00:57Z",
        "body":  "### Is there an existing issue for this?\r\n\r\n- [X] I have searched the existing issues\r\n\r\n### Is your feature request related to a problem? Please describe the problem.\r\n\r\nI am trying to integration test my application which uses the DataProtectionAPI to encrypt user session data. My tests should also cover some time-related aspects. Therefore I am using the [TimeProvider](https://learn.microsoft.com/en-us/dotnet/api/system.timeprovider?view=net-8.0) and [FakeTimeProvider](https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.time.testing.faketimeprovider?view=net-8.0) which where introduced with Dotnet8. Unfortunately, the DataProtectionAPI still uses the static DateTimeOffset instead of the new TimeProvider and therefore does not react to time changes in my tests.\r\n\r\n### Describe the solution you\u0027d like\r\n\r\nReplace the DateTimeOffset class with the TimeProvider to determine the current time in the DataProtectionAPI implementation \r\n\r\n### Additional context\r\n\r\n_No response_",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOjDyDqQ==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde86L7a_t",
                                           "createdAt":  "2024-09-13T00:30:13Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "I remember this being a friction point when I was validating data protection using a [simulator](https://github.com/dotnet/aspnetcore/blob/main/src/DataProtection/samples/KeyManagementSimulator/Program.cs).  I ended up giving myself a [test hook](https://github.com/dotnet/aspnetcore/blob/bb3b2e963d8a93198b8a982dfeccc95cb8c27632/src/DataProtection/samples/KeyManagementSimulator/Program.cs#L357).  I think I decided against `TimeProvider` because it would have required a nuget package reference, but we could probably revisit that.",
                                           "updatedAt":  "2024-09-13T15:49:33Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86MPIOp",
                                           "createdAt":  "2024-09-16T12:27:13Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "MichaelRomer",
                                           "body":  "I really appreciate that you are considering to use the TimeProvider.\r\n\r\nThe additional NuGet package would be required for using the `FakeTimeProvider`, right?. From a users perspective it would be a huge benefit if the time could be mocked while the additional NuGet dependency project will be probably not even noticed.",
                                           "updatedAt":  "2024-09-16T12:27:13Z"
                                       }
                                   ],
                         "totalCount":  2
                     },
        "title":  "Use TimeProvider instead of DateTimeOffset in DataProtectionAPI",
        "labels":  [
                       "area-dataprotection"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/57920",
        "createdAt":  "2024-09-17T16:15:46Z",
        "number":  57920,
        "author":  "maiemy",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  null,
                          "nodes":  [

                                    ],
                          "totalCount":  0
                      },
        "updatedAt":  "2025-08-22T18:01:32Z",
        "body":  "### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Describe the bug\n\nThe problem start when deploy my Blazor aspnet core 8 app on IIS like the image below.\r\n\r\n![image](https://github.com/user-attachments/assets/605597b0-6811-4792-a0a3-9b33acbecc50)\r\n\r\nIf I use the url in browser with the same name in the base tag everything works. \r\n\r\n![image](https://github.com/user-attachments/assets/26b24cb1-4971-4ad6-96c5-cbf3df53338b)\r\n\r\nIf the url is correct but with the web app name with different case I receve the error below. For example portal instead of Portal\r\n\r\n![image](https://github.com/user-attachments/assets/8714dc81-9709-4188-9953-133d8424406b)\r\n\r\ncould you help me? \r\nI think the url should be case insentitive in the management of the Antiforgery.\r\n\r\nthanks\r\n\r\n\n\n### Expected Behavior\n\nI think the url should be case insentitive in the management of the Antiforgery.\n\n### Steps To Reproduce\n\n_No response_\n\n### Exceptions (if any)\n\n_No response_\n\n### .NET Version\n\nnet 8\n\n### Anything else?\n\n_No response_",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOju5RNQ==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde86MdCC-",
                                           "createdAt":  "2024-09-17T16:41:54Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "MackinnonBuck",
                                           "body":  "This looks like a DataProtection issue.",
                                           "updatedAt":  "2024-09-17T16:41:54Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86MePXx",
                                           "createdAt":  "2024-09-17T19:33:41Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@MackinnonBuck I think you might be saying that the case-sensitivity is a red herring and this is a \"normal\" data protection error where a subsequent access (generally, on a different instance) fails to decrypt an anti-forgery key?  Is that right?",
                                           "updatedAt":  "2024-09-17T19:33:41Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86MePs1",
                                           "createdAt":  "2024-09-17T19:34:32Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@maiemy If you make repeated queries, does it always succeed with \"Portal\" and always fail with \"portal\"?  How many instances does your app have?",
                                           "updatedAt":  "2024-09-17T19:34:32Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86MfBws",
                                           "createdAt":  "2024-09-17T21:11:40Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "maiemy",
                                           "body":  "\u003e @maiemy If you make repeated queries, does it always succeed with \"Portal\" and always fail with \"portal\"? How many instances does your app have?\r\n\r\nYes correct\r\nWith the same name likes base tag Always succede. In lowercase fail\r\n\r\nI Have only one instance os iis and only one server",
                                           "updatedAt":  "2024-09-17T21:11:40Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86MfFcS",
                                           "createdAt":  "2024-09-17T21:22:05Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "Hmm, it\u0027s not immediately clear how that could be a data protection bug.  Do you know if anti-forgery is using a different purpose string for each endpoint, @MackinnonBuck?",
                                           "updatedAt":  "2024-09-17T21:22:05Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86MfFvD",
                                           "createdAt":  "2024-09-17T21:22:53Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@maiemy Are you configuring data protection explicitly, or just using the defaults?",
                                           "updatedAt":  "2024-09-17T21:22:53Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86MfGKI",
                                           "createdAt":  "2024-09-17T21:24:03Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "maiemy",
                                           "body":  "\u003e @maiemy Are you configuring data protection explicitly, or just using the defaults?\r\n\r\nDefault",
                                           "updatedAt":  "2024-09-17T21:24:03Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86MiCQ8",
                                           "createdAt":  "2024-09-18T07:40:33Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "maiemy",
                                           "body":  "\u003e @maiemy Are you configuring data protection explicitly, or just using the defaults?\r\n\r\nConfiguration summary\r\n\r\nIIS run on Windows Server 2022 Standard\r\nVersion\t21H2\r\nOS build\t20348.2582\r\nIIS version 10.0.20348.1\r\n\r\none application pool dedicated to the application. Managed pipeline: managed\r\n\r\nprogram.cs in image\r\n\r\n![image](https://github.com/user-attachments/assets/b3b1b955-f4ce-4510-92fc-e56c858e6e89)\r\n\r\nif call in lowercase fail\r\n\r\n![image](https://github.com/user-attachments/assets/f674c232-1534-4d87-9c29-d1e11333acbb)\r\n\r\n\r\nif call with correct name is ok\r\n\r\n![image](https://github.com/user-attachments/assets/957f421f-3fcf-4754-bb68-898da942b198)\r\n\r\n\r\nthis is the log when fail\r\n\r\n![image](https://github.com/user-attachments/assets/31a66839-ba01-4728-8e49-8cfba97399f1)\r\n\r\n\r\n\r\n",
                                           "updatedAt":  "2024-09-18T07:40:33Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86M8G9e",
                                           "createdAt":  "2024-09-20T20:26:12Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "Sorry for the delay - I had to fix something in 9.0 RC2 at the last minute.\r\n\r\nThe log in your last screenshot seems to show a different exception?  It appears to be about the lack of middleware, rather than about failing to decrypt the anti-forgery token.  Perhaps your reduced repro behaves differently than your full app?  Or maybe the decryption failure leads to the middleware being considered unavailable?  I can\u0027t see that I\u0027ve seen that before, but I\u0027ve only looked from the data protection end.\r\n\r\nSo, if you request lowercase, uppercase, lowercase, uppercase, etc, _every_ call to lowercase fails and every call to uppercase succeeds?  Or is it random (which is more common with these key decryption errors)?",
                                           "updatedAt":  "2024-09-20T20:26:12Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86M93er",
                                           "createdAt":  "2024-09-21T06:35:10Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHODzO8gg==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "amcasey",
                                                                               "createdAt":  "2024-09-23T14:26:02Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "maiemy",
                                           "body":  "\u003e Sorry for the delay - I had to fix something in 9.0 RC2 at the last minute.\r\n\u003e \r\n\u003e The log in your last screenshot seems to show a different exception? It appears to be about the lack of middleware, rather than about failing to decrypt the anti-forgery token. Perhaps your reduced repro behaves differently than your full app? Or maybe the decryption failure leads to the middleware being considered unavailable? I can\u0027t see that I\u0027ve seen that before, but I\u0027ve only looked from the data protection end.\r\n\u003e \r\n\u003e So, if you request lowercase, uppercase, lowercase, uppercase, etc, _every_ call to lowercase fails and every call to uppercase succeeds? Or is it random (which is more common with these key decryption errors)?\r\n\r\nno problem for the delay in replying.  :-)\r\n\r\nYes, always fail all calls where the name of the app is not the same as the name entered in the base tag in my application.\r\ni think it\u0027s something about the anti-forgery token. in my the old applications i don\u0027t get this error. it came with .net8 of which I read that the handling of form edits was changed with the introduction by default of the anti-forgery token",
                                           "updatedAt":  "2024-09-21T06:35:10Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86NYe6b",
                                           "createdAt":  "2024-09-24T18:26:07Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "Anti-forgery [appears](https://github.com/dotnet/aspnetcore/blob/e9160bede6d2dd80e6a46428647270b82837bbcc/src/Antiforgery/src/Internal/DefaultAntiforgeryTokenSerializer.cs#L12) to use a single purpose string for all anti-forgery tokens, so it\u0027s really not clear how the route could play a role in looking up the key.\r\n\r\nThings you could try:\r\n1. Enable `Trace` level logging for `Microsoft.AspNetCore.DataProtection` and possibly `Microsoft.AspNetCore.Antiforgery`.\r\n2. Find the key storage location (possibly `C:\\Windows\\System32\\config\\systemprofile\\AppData\\Local\\ASP.NET\\DataProtection-Keys`) and check how many keys have been generated and whether the one mentioned in the error message is present.\r\n3. **CAUTION** You could delete all of your data protection keys to get back to a clean state.  *Any data encrypted with those keys will be lost* (so definitely back up the file/folder) and *any in-flight session will be broken*.  I\u0027d only suggest doing this if you\u0027re playing with a toy version of your app locally - not if you have actual users and/or data.",
                                           "updatedAt":  "2024-09-24T18:26:07Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86OK06C",
                                           "createdAt":  "2024-10-01T08:54:54Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "maiemy",
                                           "body":  "\u003e 1. Enable `Trace` level logging for `Microsoft.AspNetCore.DataProtection` and possibly `Microsoft.AspNetCore.Antiforgery`\r\n\r\nSorry for late reply.\r\nI enabled tracing as you recommended. \r\nI will attach the result.\r\n\r\ndo you need anything else?\r\n\r\n\r\ninfo: Microsoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager[61]\r\n      User profile not available. Using \u0027HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\ASP.NET\\4.0.30319.0\\AutoGenKeys\\S-1-5-82-2741126922-417464934-677490404-2862504394-2741784047\\DataProtection\u0027 as key repository and Windows DPAPI to encrypt keys at rest.\r\ndbug: Microsoft.AspNetCore.DataProtection.Repositories.RegistryXmlRepository[40]\r\n      Reading data from registry key \u0027HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\ASP.NET\\4.0.30319.0\\AutoGenKeys\\S-1-5-82-2741126922-417464934-677490404-2862504394-2741784047\\DataProtection\u0027, value \u0027key-dd935a0b-3ad2-4beb-95c7-d9753e2be312\u0027.\r\ndbug: Microsoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager[18]\r\n      Found key {dd935a0b-3ad2-4beb-95c7-d9753e2be312}.\r\ndbug: Microsoft.AspNetCore.DataProtection.KeyManagement.DefaultKeyResolver[13]\r\n      Considering key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} with expiration date 2024-12-16 10:09:18Z as default key.\r\ndbug: Microsoft.AspNetCore.DataProtection.TypeForwardingActivator[0]\r\n      Forwarded activator type request from Microsoft.AspNetCore.DataProtection.XmlEncryption.DpapiXmlDecryptor, Microsoft.AspNetCore.DataProtection, Version=8.0.0.0, Culture=neutral, PublicKeyToken=adb9793829ddae60 to Microsoft.AspNetCore.DataProtection.XmlEncryption.DpapiXmlDecryptor, Microsoft.AspNetCore.DataProtection, Culture=neutral, PublicKeyToken=adb9793829ddae60\r\ndbug: Microsoft.AspNetCore.DataProtection.XmlEncryption.DpapiXmlDecryptor[51]\r\n      Decrypting secret element using Windows DPAPI.\r\ndbug: Microsoft.AspNetCore.DataProtection.TypeForwardingActivator[0]\r\n      Forwarded activator type request from Microsoft.AspNetCore.DataProtection.AuthenticatedEncryption.ConfigurationModel.AuthenticatedEncryptorDescriptorDeserializer, Microsoft.AspNetCore.DataProtection, Version=8.0.0.0, Culture=neutral, PublicKeyToken=adb9793829ddae60 to Microsoft.AspNetCore.DataProtection.AuthenticatedEncryption.ConfigurationModel.AuthenticatedEncryptorDescriptorDeserializer, Microsoft.AspNetCore.DataProtection, Culture=neutral, PublicKeyToken=adb9793829ddae60\r\ndbug: Microsoft.AspNetCore.DataProtection.AuthenticatedEncryption.CngCbcAuthenticatedEncryptorFactory[4]\r\n      Opening CNG algorithm \u0027AES\u0027 from provider \u0027(null)\u0027 with chaining mode CBC.\r\ndbug: Microsoft.AspNetCore.DataProtection.AuthenticatedEncryption.CngCbcAuthenticatedEncryptorFactory[3]\r\n      Opening CNG algorithm \u0027SHA256\u0027 from provider \u0027(null)\u0027 with HMAC.\r\ndbug: Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingProvider[2]\r\n      Using key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} as the default key.\r\ndbug: Microsoft.AspNetCore.DataProtection.Internal.DataProtectionHostedService[65]\r\n      Key ring with default key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} was loaded during application startup.\r\ninfo: Microsoft.Hosting.Lifetime[0]\r\n      Application started. Press Ctrl+C to shut down.\r\ninfo: Microsoft.Hosting.Lifetime[0]\r\n      Hosting environment: Production\r\ninfo: Microsoft.Hosting.Lifetime[0]\r\n      Content root path: D:\\inetpub\\wwwroot\\PRGWebPortal\r\ntrce: Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector[31]\r\n      Performing protect operation to key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} with purposes (\u0027D:\\inetpub\\wwwroot\\PRGWebPortal\\\u0027, \u0027Microsoft.AspNetCore.Components.ComponentDescriptorSerializer,V1\u0027, \u0027Microsoft.AspNetCore.DataProtection.TimeLimitedDataProtector.v1\u0027).\r\ntrce: Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector[5]\r\n      Performing unprotect operation to key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} with purposes (\u0027D:\\inetpub\\wwwroot\\PRGWebPortal\\\u0027, \u0027Microsoft.AspNetCore.Antiforgery.AntiforgeryToken.v1\u0027).\r\ntrce: Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector[31]\r\n      Performing protect operation to key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} with purposes (\u0027D:\\inetpub\\wwwroot\\PRGWebPortal\\\u0027, \u0027Microsoft.AspNetCore.Antiforgery.AntiforgeryToken.v1\u0027).\r\ndbug: Microsoft.AspNetCore.Antiforgery.DefaultAntiforgery[6]\r\n      An antiforgery cookie token was reused.\r\ntrce: Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector[31]\r\n      Performing protect operation to key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} with purposes (\u0027D:\\inetpub\\wwwroot\\PRGWebPortal\\\u0027, \u0027Microsoft.AspNetCore.Components.Server.State\u0027).\r\ndbug: Microsoft.AspNetCore.Antiforgery.DefaultAntiforgery[6]\r\n      An antiforgery cookie token was reused.\r\ntrce: Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector[5]\r\n      Performing unprotect operation to key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} with purposes (\u0027D:\\inetpub\\wwwroot\\PRGWebPortal\\\u0027, \u0027Microsoft.AspNetCore.Components.Server.State\u0027).\r\ntrce: Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector[31]\r\n      Performing protect operation to key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} with purposes (\u0027D:\\inetpub\\wwwroot\\PRGWebPortal\\\u0027, \u0027Microsoft.AspNetCore.Components.Server.CircuitIdFactory,V1\u0027).\r\ntrce: Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector[5]\r\n      Performing unprotect operation to key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} with purposes (\u0027D:\\inetpub\\wwwroot\\PRGWebPortal\\\u0027, \u0027Microsoft.AspNetCore.Components.ComponentDescriptorSerializer,V1\u0027, \u0027Microsoft.AspNetCore.DataProtection.TimeLimitedDataProtector.v1\u0027).\r\ntrce: Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector[5]\r\n      Performing unprotect operation to key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} with purposes (\u0027D:\\inetpub\\wwwroot\\PRGWebPortal\\\u0027, \u0027Microsoft.AspNetCore.Components.Server.State\u0027).\r\ntrce: Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector[31]\r\n      Performing protect operation to key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} with purposes (\u0027D:\\inetpub\\wwwroot\\PRGWebPortal\\\u0027, \u0027Microsoft.AspNetCore.Components.ComponentDescriptorSerializer,V1\u0027, \u0027Microsoft.AspNetCore.DataProtection.TimeLimitedDataProtector.v1\u0027).\r\ntrce: Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector[5]\r\n      Performing unprotect operation to key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} with purposes (\u0027D:\\inetpub\\wwwroot\\PRGWebPortal\\\u0027, \u0027Microsoft.AspNetCore.Antiforgery.AntiforgeryToken.v1\u0027).\r\ntrce: Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector[31]\r\n      Performing protect operation to key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} with purposes (\u0027D:\\inetpub\\wwwroot\\PRGWebPortal\\\u0027, \u0027Microsoft.AspNetCore.Antiforgery.AntiforgeryToken.v1\u0027).\r\ndbug: Microsoft.AspNetCore.Antiforgery.DefaultAntiforgery[6]\r\n      An antiforgery cookie token was reused.\r\ntrce: Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector[31]\r\n      Performing protect operation to key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} with purposes (\u0027D:\\inetpub\\wwwroot\\PRGWebPortal\\\u0027, \u0027Microsoft.AspNetCore.Components.Server.State\u0027).\r\ndbug: Microsoft.AspNetCore.Antiforgery.DefaultAntiforgery[6]\r\n      An antiforgery cookie token was reused.\r\ntrce: Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector[5]\r\n      Performing unprotect operation to key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} with purposes (\u0027D:\\inetpub\\wwwroot\\PRGWebPortal\\\u0027, \u0027Microsoft.AspNetCore.Components.Server.CircuitIdFactory,V1\u0027).\r\ntrce: Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector[5]\r\n      Performing unprotect operation to key {dd935a0b-3ad2-4beb-95c7-d9753e2be312} with purposes (\u0027D:\\inetpub\\wwwroot\\PRGWebPortal\\\u0027, \u0027Microsoft.AspNetCore.Components.Server.State\u0027).\r\ninfo: Microsoft.Hosting.Lifetime[0]\r\n\r\n\r\n![image](https://github.com/user-attachments/assets/3656fd49-421f-4ed8-a758-d2d0428baec0)\r\n",
                                           "updatedAt":  "2024-10-01T08:54:54Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86OcGcO",
                                           "createdAt":  "2024-10-02T21:31:51Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "You posted a screenshot of a folder, but the log says that the keys are being stored in the registry:\r\n`HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\ASP.NET\\4.0.30319.0\\AutoGenKeys\\S-1-5-82-2741126922-417464934-677490404-2862504394-2741784047\\DataProtection`\r\n",
                                           "updatedAt":  "2024-10-02T21:31:51Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86OcHBc",
                                           "createdAt":  "2024-10-02T21:33:40Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "None of the purpose strings in the log seem to include page names, so they shouldn\u0027t be affected by the lettercasing in the URL.",
                                           "updatedAt":  "2024-10-02T21:33:40Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86OcHRA",
                                           "createdAt":  "2024-10-02T21:34:25Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "Does the log fragment above cover a period during which you saw the exception?",
                                           "updatedAt":  "2024-10-02T21:34:25Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86OwB8C",
                                           "createdAt":  "2024-10-05T06:55:14Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "maiemy",
                                           "body":  "\u003e Does the log fragment above cover a period during which you saw the exception?\r\n\r\nYes, I took the log during the execution of the error.\r\nthis week I\u0027ll do another test to retrieve more logs to send you. I\u0027ll also check where it gets the key from and if you need it I can send it to you.",
                                           "updatedAt":  "2024-10-05T06:55:14Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86O7lE1",
                                           "createdAt":  "2024-10-07T21:52:30Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "\u003e Yes, I took the log during the execution of the error.\r\n\r\nI\u0027m a little confused because it doesn\u0027t seem to show any errors.  What errors/behaviors are you using to confirm the scenario is broken?",
                                           "updatedAt":  "2024-10-07T21:52:30Z"
                                       }
                                   ],
                         "totalCount":  17
                     },
        "title":  "AntiforgeryValidationException preventing Blazor app to start on IIS Web App. (case sensitive url)",
        "labels":  [
                       "area-dataprotection",
                       "Needs: Attention :wave:"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/58224",
        "createdAt":  "2024-10-03T15:23:44Z",
        "number":  58224,
        "author":  "debracey",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  null,
                          "nodes":  [

                                    ],
                          "totalCount":  0
                      },
        "updatedAt":  "2024-10-04T18:16:18Z",
        "body":  "### Is there an existing issue for this?\r\n\r\n- [X] I have searched the existing issues\r\n\r\n### Describe the bug\r\n\r\n`RegistryXmlRepository` takes a `RegistryKey` as a parameter in its constructor ([code ref](https://github.com/dotnet/aspnetcore/blob/main/src/DataProtection/DataProtection/src/Repositories/RegistryXmlRepository.cs#L36)), but that key is never disposed. Furthermore, if you construct this class inside a using block (see example), the class could attempt to access a closed registry key.\r\n\r\n### Expected Behavior\r\n\r\n - Class should be disposable and dispose/close the key correctly.\r\n - Possibly the class should reopen the key? Not sure.\r\n\r\n### Steps To Reproduce\r\n\r\n1. Setup a standard ASP.NET core web app\r\n2. Enable data protection for the app, persisting the data to the registry\r\n3. Ensure that the registry key is disposed in the setup method\r\n4. Notice that, when the protection information is accessed, the code will fail with an exception\r\n\r\n```csharp\r\nusing var registryKey = RegistryKey\r\n      .OpenBaseKey(RegistryHive.LocalMachine, RegistryView.Registry64)\r\n      .OpenSubKey(some_registry_path, true);\r\n\r\ndataProtectionBuilder.ProtectKeysWithDpapi(true).PersistKeysToRegistry(registryKey);                \r\n```\r\n\r\n### Exceptions (if any)\r\n\r\n```\r\n\"Type\":\"System.ObjectDisposedException\", \r\n\"Message\":\"Cannot access a closed registry key.\"\r\n\"Object name: \u0027key path set in code\u0027.\"\r\n```\r\n\r\n### .NET Version\r\n\r\n8.0.400\r\n\r\n### Anything else?\r\n\r\n- Is the key even supposed to be closed/disposed?\r\n- If not, maybe the documentation for these extension methods/classes just needs updating",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOjqxygg==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde86Ol-YX",
                                           "createdAt":  "2024-10-03T20:55:53Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "I think the usual pattern is that the creator of the object disposes of it - normally, it\u0027s not a class or method that accepts it as an argument.  I\u0027m certainly open to examples or guidance showing evidence of a different approach.\r\n\r\nIn the meantime, it seems like we mostly want to update the doc comment on `PersistKeysToRegistry` to let people know they shouldn\u0027t close the key?\r\n\r\nI could also imagine having the registry close and re-open the regkey on demand, but I haven\u0027t thought through all the consequences of that.",
                                           "updatedAt":  "2024-10-03T20:55:53Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86OmJNG",
                                           "createdAt":  "2024-10-03T21:23:49Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "debracey",
                                           "body":  "@amcasey Agree that normally the creator would dispose of the object. In this case it becomes a bit annoying for the consumer since they\u0027d have to maintain a reference to the (opened) registry key for (potentially) the whole life of the application.",
                                           "updatedAt":  "2024-10-03T21:23:49Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86OmkdI",
                                           "createdAt":  "2024-10-03T22:55:30Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "@debracey Can you elaborate?  At that point, wouldn\u0027t you just declare it without a `using`?  The finalizer should close the regkey.",
                                           "updatedAt":  "2024-10-03T22:55:30Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86Omnnf",
                                           "createdAt":  "2024-10-03T23:08:59Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "amcasey",
                                           "body":  "[Here](https://source.dot.net/#Microsoft.AspNetCore.DataProtection/KeyManagement/XmlKeyManager.cs,690)\u0027s where DataProtection creates its own instance (as a fallback).  It looks like it just doesn\u0027t use a `using`.  Are you aware of a concrete problem that holding that key open causes?",
                                           "updatedAt":  "2024-10-03T23:08:59Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86OrHKC",
                                           "createdAt":  "2024-10-04T13:05:48Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOD04Y3g==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "amcasey",
                                                                               "createdAt":  "2024-10-04T18:00:17Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "debracey",
                                           "body":  "@amcasey Yeah - what I meant to say was that, if you want to manually close/dispose the key, you\u0027d have to maintain a reference to that key for the whole life of the application. Since the finalizer will take care of it, there\u0027s no practical reason to do this.\r\n\r\nYes - the workaround I plan to use is to just remove the `using` statement from the example code shared previously. \r\n\r\nI am not aware of any problem with leaving the key open. We only found this issue after we were testing some stylecop/sonarqube suggestions and found that the suggestion(s) failed our pipelines with the exception mentioned above.",
                                           "updatedAt":  "2024-10-04T13:05:48Z"
                                       }
                                   ],
                         "totalCount":  5
                     },
        "title":  "Should RegistryXmlRepository close the regkey between reads?",
        "labels":  [
                       "area-dataprotection"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/59461",
        "createdAt":  "2024-12-12T19:02:18Z",
        "number":  59461,
        "author":  "kikaragyozov",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  null,
                          "nodes":  [

                                    ],
                          "totalCount":  0
                      },
        "updatedAt":  "2025-08-25T17:02:15Z",
        "body":  "When running ASP.NET Core on Kestrel/IIS Express, everything works as expected.\n\nThe following method gets called before the app is built:\n\n```\n        public static IDataProtectionProvider Create(string discriminator)\n        {\n            // build the service collection\n            var serviceCollection = new ServiceCollection();\n            var builder = serviceCollection.AddDataProtection()\n                .SetApplicationName(discriminator)\n                   .ProtectKeysWithDpapi(true);\n\n            return serviceCollection.BuildServiceProvider().GetRequiredService\u003cIDataProtectionProvider\u003e();\n        }\n```\n\nThis works in IIS Express, Kestrel. I haven\u0027t tested this in docker, but I\u0027m guessing because it uses Kestrel under the hood, it\u0027ll work as well.\n\nThe moment we move to using IIS though, all hell breaks lose. My Unprotect call fails with the error \n```\nSystem.Security.Cryptography.CryptographicException: The key {XXXXXX-XXXX-XXXX-XXXXX} was not found in the key ring. For more information go to https://aka.ms/aspnet/dataprotectionwarning\n```\n\nWhat\u0027s going on here? The IIS configured is running on my local machine, the same machine from which both the other methods worked.\nFurthermore, I\u0027ve manually added permissions to the default location of where the keys are being stored, verified that indeed the GUID mentioned EXISTS in the folder, i.e the file is there. \n\nI\u0027ve also tried specifying manually a folder, via `PersistKeysToFileSystem` **which fixes the issue**, but why doesn\u0027t it work via the default location _(`%LOCALAPPDATA%\\ASP.NET\\DataProtection-Keys`)_\n\nIs there something specific that needs to be done on IIS for it to work out of the box?\n\n`Load User Profile` is set to `true` in the Application pool.\n\nTested on .NET 9/.NET 8",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOv_0U3Q==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde86Xbg2H",
                                           "createdAt":  "2024-12-13T05:15:29Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "adityamandaleeka",
                                           "body":  "Can you please take a look here: https://learn.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/default-settings?view=aspnetcore-9.0#key-management\n\nI wonder if the environment isn\u0027t flowing properly (see the part about `setProfileEnvironment` in that doc).",
                                           "updatedAt":  "2024-12-13T05:15:29Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86XdMub",
                                           "createdAt":  "2024-12-13T09:46:48Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "kikaragyozov",
                                           "body":  "```\n        \u003capplicationPools\u003e\n            \u003cadd name=\"DefaultAppPool\" /\u003e\n            \u003cadd name=\"rdf\" autoStart=\"true\" managedRuntimeVersion=\"\" /\u003e\n            \u003capplicationPoolDefaults managedRuntimeVersion=\"v4.0\"\u003e\n                \u003cprocessModel identityType=\"ApplicationPoolIdentity\" loadUserProfile=\"true\" setProfileEnvironment=\"true\" /\u003e\n            \u003c/applicationPoolDefaults\u003e\n        \u003c/applicationPools\u003e\n```\n\nsetProfileEnvironment was set to `false`. I changed it and restarted the IIS server from the IIS application window by clicking \"Stop\" and then \"Start\". The issue still occurs.",
                                           "updatedAt":  "2024-12-13T09:46:48Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86__RTd",
                                           "createdAt":  "2025-08-25T17:02:09Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "DeagleGross",
                                           "body":  "Moving to backlog: we will try to come back once we have time to repro and investigate.",
                                           "updatedAt":  "2025-08-25T17:02:09Z"
                                       }
                                   ],
                         "totalCount":  3
                     },
        "title":  "DataProtectionProvider fails to unprotect when hosted on IIS with keys persisted to the default location",
        "labels":  [
                       "area-dataprotection"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/59717",
        "createdAt":  "2025-01-04T19:20:50Z",
        "number":  59717,
        "author":  "toiyabe",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHOC_CORg==",
                          "nodes":  [
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "jvalkeejarvi",
                                            "createdAt":  "2025-02-12T21:22:12Z"
                                        }
                                    ],
                          "totalCount":  1
                      },
        "updatedAt":  "2025-08-25T17:58:15Z",
        "body":  "### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Describe the bug\n\nCosmos DB Entity Framework for .Net 9 now requires all LINQ functions to be asynchronous.  When attempting to use the synchronous method, it throws the following error:\n\n`\u0027Microsoft.EntityFrameworkCore.Database.SyncNotSupported\u0027: Azure Cosmos DB does not support synchronous I/O. Make sure to use and correctly await only async methods when using Entity Framework Core to access Azure Cosmos DB.`\n\nFor example, Entity.ToList() will fail while Entity.ToListAsync() will succeed.\n\nI have found that the following code changes to `EntityFrameworkCoreXmlRepository` will solve the problem.  Note where I check if DB is Cosmos, and there make async calls.  Someone more cleaver than I can probably simplify this.\n\nQuestion, can all EF providers support asynchronous methods? If so, then maybe make this async for all and not worry if this is for Cosmos or not?\n\n```csharp\npublic virtual IReadOnlyCollection\u003cXElement\u003e GetAllElements()\n{\n    // forces complete enumeration\n    return GetAllElementsCore().ToList().AsReadOnly();\n\n    IEnumerable\u003cXElement\u003e GetAllElementsCore()\n    {\n        using (var scope = _services.CreateScope())\n        {\n            var context = scope.ServiceProvider.GetRequiredService\u003cTContext\u003e();\n\n            List\u003cDataProtectionKey\u003e keys;\n\n            // Cosmos DB EF 9 supports only async methods.\n            if (context.Database.IsCosmos())\n            {\n                keys = context.DataProtectionKeys.AsNoTracking().ToListAsync().Result;\n            }\n            else\n            {\n                keys = context.DataProtectionKeys.AsNoTracking();\n            }\n\n            foreach (var key in keys)\n            {\n                _logger.ReadingXmlFromKey(key.FriendlyName!, key.Xml);\n\n                if (!string.IsNullOrEmpty(key.Xml))\n                {\n                    yield return XElement.Parse(key.Xml);\n                }\n            }\n        }\n    }\n}\n\n/// \u003cinheritdoc /\u003e\npublic void StoreElement(XElement element, string friendlyName)\n{\n    using (var scope = _services.CreateScope())\n    {\n        var context = scope.ServiceProvider.GetRequiredService\u003cTContext\u003e();\n        var newKey = new DataProtectionKey()\n        {\n            FriendlyName = friendlyName,\n            Xml = element.ToString(SaveOptions.DisableFormatting)\n        };\n\n        context.DataProtectionKeys.Add(newKey);\n        _logger.LogSavingKeyToDbContext(friendlyName, typeof(TContext).Name);\n\n        // Cosmos DB EF 9 supports only async methods.\n        if (context.Database.IsCosmos())\n        {\n            context.SaveChangesAsync().Wait();\n        }\n        else\n        {\n            context.SaveChanges();\n        }\n    }\n}\n```\n\n\n\n### Expected Behavior\n\n_No response_\n\n### Steps To Reproduce\n\nCreate an asp.net project, .Net 9, with a Cosmos DB database.  Then add data protection using the DbContext.  Here is example code that will cause the error:\n\n```csharp\n// Add shared data protection here\nbuilder.Services.AddDataProtection()\n    .SetApplicationName(\"editor\").UseCryptographicAlgorithms(\n    new AuthenticatedEncryptorConfiguration\n    {\n        EncryptionAlgorithm = EncryptionAlgorithm.AES_256_CBC,\n        ValidationAlgorithm = ValidationAlgorithm.HMACSHA256\n    }).PersistKeysToDbContext\u003cApplicationDbContext\u003e();\n```\n\nNote: The `ApplicationDbContext` uses Cosmos DB.\n\n### Exceptions (if any)\n\n_No response_\n\n### .NET Version\n\n_No response_\n\n### Anything else?\n\n_No response_",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOv__HAw==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde86c3dQB",
                                           "createdAt":  "2025-02-03T18:43:11Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "docHologram",
                                           "body":  "Any eyeballs on this, guys? I have the same issue in moving to .NET 9 in which a similar scenario happens with HttpContext.ChallengeAsync(). ",
                                           "updatedAt":  "2025-02-03T18:43:11Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86ePiZq",
                                           "createdAt":  "2025-02-12T21:22:52Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "jvalkeejarvi",
                                           "body":  "I faced this same issue after upgrading to .NET9. Are there any plans to fix this soon?",
                                           "updatedAt":  "2025-02-12T21:22:52Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86fREsH",
                                           "createdAt":  "2025-02-20T16:41:10Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "SamMonoRT",
                                           "body":  "https://learn.microsoft.com/en-us/ef/core/what-is-new/ef-core-9.0/breaking-changes#cosmos-nosync",
                                           "updatedAt":  "2025-02-20T16:41:10Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86hkAmC",
                                           "createdAt":  "2025-03-10T13:17:44Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "docHologram",
                                           "body":  "Thanks @SamMonoRT but the issue here is not with any of our proprietary code, but with the AspNetCore.Authentication library attempting to grab DataProtectionKeys and doing so synchronously. I think this is also the purpose behind the original issue and commit submitted by @toiyabe.",
                                           "updatedAt":  "2025-03-10T13:17:44Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86jJK8F",
                                           "createdAt":  "2025-03-19T15:33:50Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "krosn",
                                           "body":  "Is there any update on this? Right now the PersistKeysToDbContext with Cosmos is essentially unusable",
                                           "updatedAt":  "2025-03-19T15:33:50Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86jKWtG",
                                           "createdAt":  "2025-03-19T16:57:58Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "krosn",
                                           "body":  "Ah, I see, this can be disabled using the Mitigations in that announcement\n\nhttps://learn.microsoft.com/en-us/ef/core/what-is-new/ef-core-9.0/breaking-changes#mitigations-10\n\n![Image](https://github.com/user-attachments/assets/ee0e643f-1a1b-4d47-883a-f3137a6a6059)",
                                           "updatedAt":  "2025-03-19T16:57:58Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86jK4DD",
                                           "createdAt":  "2025-03-19T17:48:39Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "AndriySvyryd",
                                           "body":  "\u003e Question, can all EF providers support asynchronous methods\n\nYes, async methods are recommended for any database interactions ",
                                           "updatedAt":  "2025-03-19T17:48:39Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86jLqOy",
                                           "createdAt":  "2025-03-19T19:08:58Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOEYGDfQ==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "risperdal",
                                                                               "createdAt":  "2025-06-26T18:47:40Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "krosn",
                                           "body":  "\u003e That being said, applications should stop using sync APIs with Azure Cosmos DB since this is not supported by the Azure Cosmos DB SDK. The ability to suppress the exception will be removed in a future release of EF Core, after which the only option will be to use async APIs.\n\nWill the EntityFrameworkCoreXmlRepository be updated to use asynchronous methods before this suppression is removed in a future version?\n",
                                           "updatedAt":  "2025-03-19T19:08:58Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86__8cD",
                                           "createdAt":  "2025-08-25T17:58:15Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "DeagleGross",
                                           "body":  "We will work on that for NET 11 since [there is a workaround](https://learn.microsoft.com/en-us/ef/core/what-is-new/ef-core-9.0/breaking-changes#mitigations-10).",
                                           "updatedAt":  "2025-08-25T17:58:15Z"
                                       }
                                   ],
                         "totalCount":  9
                     },
        "title":  "DataProtection.PersistKeysToDbContext fails when using Cosmos DB EF 9.  Possible fix included here.",
        "labels":  [
                       "area-dataprotection"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/61386",
        "createdAt":  "2025-04-08T12:09:10Z",
        "number":  61386,
        "author":  "EvilVir",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  null,
                          "nodes":  [

                                    ],
                          "totalCount":  0
                      },
        "updatedAt":  "2025-08-21T12:48:06Z",
        "body":  "## Background and Motivation\n\nCurrently, when setting up Data Protection, there is inconsistency with how configuration is handled. In our project we use `IConfigureOptions\u003cKeyManagementOptions\u003e` approach where we can load an encryption certificate after app services are loaded, by setting `options.XmlEncryptor` to `CertificateXmlEncryptor` instance.\n\nBut we can\u0027t do the same for `XmlKeyDecryptionOptions` because that class is internal and sealed. So the only possible way to configure Data Protection with X509 cert encryption is to use `IDataProtectionBuilder.ProtectKeysWithCertificate` extension method. Which defeats purpose of `IConfigureOptions` pattern.\n\n## Proposed API\n\n`public class XmlKeyDecryptionOptions`\n\n## Usage Examples\n\n```\npublic class XmlKeyDecryptionOptionsConfigurator(ICertificatesStore store) : IConfigureOptions\u003cXmlKeyDecryptionOptions\u003e\n{\n    public void Configure(XmlKeyDecryptionOptions options)\n    {\n        var cert = store.GetDataProtectionCertificate();\n        options.AddKeyDecryptionCertificate(cert);\n    }\n}\n```\n\n## Alternative Designs\n\nAlternativelly there should be `.XmlDecryptor` property on `KeyManagementOptions`, analogous to to `.XmlEncryptor` one, by which we can set `IXmlDecryptor` instance to be used when decrypting Data Protection Keys.\n\n## Risks\n\nNone.",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOv1vMmQ==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde86pS8_9",
                                           "createdAt":  "2025-04-29T21:45:01Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  "Y3Vyc29yOnYyOpHOEQNckw==",
                                                             "nodes":  [
                                                                           {
                                                                               "content":  "THUMBS_UP",
                                                                               "user":  "EvilVir",
                                                                               "createdAt":  "2025-04-29T22:53:39Z"
                                                                           }
                                                                       ],
                                                             "totalCount":  1
                                                         },
                                           "author":  "awoodall-aveva",
                                           "body":  "I am also looking to load and configure a data protection certificate after app services are loaded and found the same limitation as discussed here. Another related discussion I found is https://github.com/dotnet/aspnetcore/issues/23033.",
                                           "updatedAt":  "2025-04-29T21:45:01Z"
                                       },
                                       {
                                           "id":  "IC_kwDOAQzde86_W8yZ",
                                           "createdAt":  "2025-08-21T12:48:06Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "DeagleGross",
                                           "body":  "Thanks for proposing, it makes sense. We will revisit it for .NET 11. Let us know if there is extra-urgency but I doubt we will take it for NET10",
                                           "updatedAt":  "2025-08-21T12:48:06Z"
                                       }
                                   ],
                         "totalCount":  2
                     },
        "title":  "Make XmlKeyDecryptionOptions public OR add KeyManagementOptions.XmlDecryptor property",
        "labels":  [
                       "area-dataprotection",
                       "api-suggestion"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/61768",
        "createdAt":  "2025-05-02T04:44:39Z",
        "number":  61768,
        "author":  "RamType0",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  "Y3Vyc29yOnYyOpHODHFWtQ==",
                          "nodes":  [
                                        {
                                            "content":  "THUMBS_UP",
                                            "user":  "hangy",
                                            "createdAt":  "2025-07-15T16:43:39Z"
                                        }
                                    ],
                          "totalCount":  1
                      },
        "updatedAt":  "2025-08-21T15:45:44Z",
        "body":  "## Background and Motivation\n\nWith current overload of `PersistKeysToStackExchangeRedis`, we could not use `IConnectionMultiplexer` from service provider.\nIt makes us impossible to use Redis registered with `AddRedisClient` of Aspire.\n\n## Proposed API\n\n```C#\npublic static IDataProtectionBuilder PersistKeysToStackExchangeRedis(this IDataProtectionBuilder builder, Func\u003cIServiceProvider, IDatabase\u003e databaseFactory, RedisKey key);\n```\n\n## Usage Examples\n\n```C#\n\nbuilder.AddRedisClient(\"redis\");\n\nbuilder.Services.AddDataProtection()\n    .PersistKeysToStackExchangeRedis(services =\u003e services.GetRequiredService\u003cIConnectionMultiplexer\u003e().GetDatabase(), \"DataProtection-Keys\");\n```\n\n",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOv2ZzUg==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde86_ZnNS",
                                           "createdAt":  "2025-08-21T15:45:32Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "DeagleGross",
                                           "body":  "Can you please elaborate on why DataProtection+PersistKeysToStackExchangeRedis is needed on the aspire project? What is the use-case you are trying to solve?",
                                           "updatedAt":  "2025-08-21T15:45:32Z"
                                       }
                                   ],
                         "totalCount":  1
                     },
        "title":  "Add `PersistKeysToStackExchangeRedis` overload which accepts `Func\u003cIServiceProvider, IDatabase\u003e`",
        "labels":  [
                       "area-dataprotection",
                       "api-suggestion"
                   ]
    },
    {
        "url":  "https://github.com/dotnet/aspnetcore/issues/61930",
        "createdAt":  "2025-05-14T07:13:15Z",
        "number":  61930,
        "author":  "DunetsNM",
        "reactions":  {
                          "hasNextPage":  false,
                          "endCursor":  null,
                          "nodes":  [

                                    ],
                          "totalCount":  0
                      },
        "updatedAt":  "2025-08-21T12:30:04Z",
        "body":  "### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Describe the bug\n\nWhen `KeyRingProvider` uses an expired key with `AutoGenerateKeys = false`, it schedules the next refresh for up to 24 hours in the future: https://github.com/dotnet/aspnetcore/blob/0230498dfccaef6f782a5e37c60ea505081b72bf/src/DataProtection/DataProtection/src/KeyManagement/KeyRingProvider.cs#L187-L198\n\nThis creates a problem in multi-application scenarios where:\n1. App A generates keys\n2. App B has `AutoGenerateKeys = false` and relies on App A for new keys, but starts few minutes earlier than App A\n3. When App B\u0027s key expires, it waits up to 24h before checking for new keys from App A\n\nSince App B explicitly disabled auto-generation, it depends on other apps for new keys and should check for them more frequently when using expired keys (e.g., every 5 minutes).\n\n**Suggested fix:**\nUse a shorter refresh period when `defaultKey.ExpirationDate \u003c= now \u0026\u0026 !_keyManagementOptions.AutoGenerateKeys`\n",
        "comments":  {
                         "hasNextPage":  false,
                         "endCursor":  "Y3Vyc29yOnYyOpHOv1rpsQ==",
                         "nodes":  [
                                       {
                                           "id":  "IC_kwDOAQzde86_Wumx",
                                           "createdAt":  "2025-08-21T12:29:58Z",
                                           "reactions":  {
                                                             "hasNextPage":  false,
                                                             "endCursor":  null,
                                                             "nodes":  [

                                                                       ],
                                                             "totalCount":  0
                                                         },
                                           "author":  "DeagleGross",
                                           "body":  "Thanks for posting the issue. I see such comment on keyRingRefreshPeriod:\n```\n            // This value is not settable since there\u0027s a complex interaction between\n            // it and the key expiration safety period.\n```\nSo it can be not so trivial to change the value here. Moreover, I think we should strive towards allowing to control those options, otherwise in some scenarios expiration period of 5 minutes as proposed by the author can also be not satisfying specific needs.\n\nI am putting this to backlog for now, and we will revisit it later. Today workaround is to use reflection to set the desired value, but its user\u0027s responsibility to ensure other parts of DataProtection will work correctly\n",
                                           "updatedAt":  "2025-08-21T12:29:58Z"
                                       }
                                   ],
                         "totalCount":  1
                     },
        "title":  "KeyRingProvider uses 24h refresh period even with expired keys and disabled key auto-generation",
        "labels":  [
                       "area-dataprotection"
                   ]
    }
]
